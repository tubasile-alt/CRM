```html
<!-- ===========================
PATCH √öNICO (COPY/PASTE) - EVOLU√á√ÉO CIR√öRGICA PADRONIZADA COM CHECKBOXES
‚úÖ Objetivo:
- Mostrar checkboxes SOMENTE quando a evolu√ß√£o for de CIRURGIA
- Permitir m√∫ltipla sele√ß√£o: necrose, crostas, infec√ß√£o secund√°ria, foliculite aguda, foliculite cr√¥nica, rarefa√ß√£o capilar, falha localizada
- Empacotar os achados no texto da evolu√ß√£o (n√£o exige mexer em banco/backend)
- Funciona mesmo sem alterar saveEvolution() no backend

üìå COMO USAR (sem tentativa-e-erro):
1) ABRA o arquivo: templates/prontuario.html
2) PROCURE dentro do modal #evolutionModal este bloco:
   <textarea id="evolutionContent" ...></textarea>
3) COLE TODO este PATCH imediatamente ANTES do </div> que fecha a modal-body
   (ou seja: logo abaixo do textarea da descri√ß√£o, dentro do modal)

4) Depois, ainda no prontuario.html, role at√© o final (antes de </body> / antes de {% endblock %})
   e COLE o bloco <script> deste patch (parte JS).
=========================== -->

<!-- ===========================
(1) HTML - inserir DENTRO do Modal de Evolu√ß√£o (#evolutionModal), na modal-body,
logo DEPOIS do campo "Descri√ß√£o" (textarea evolutionContent)
=========================== -->
<div id="surgicalEvolutionFindings" class="mb-3" style="display:none;">
  <label class="form-label"><strong>Achados Cir√∫rgicos (marque quantos quiser)</strong></label>

  <div class="row">
    <div class="col-md-6">
      <div class="form-check">
        <input class="form-check-input surg-find" type="checkbox" id="sfNecrose" value="necrose">
        <label class="form-check-label" for="sfNecrose">Necrose</label>
      </div>

      <div class="form-check">
        <input class="form-check-input surg-find" type="checkbox" id="sfCrostas" value="crostas">
        <label class="form-check-label" for="sfCrostas">Crostas</label>
      </div>

      <div class="form-check">
        <input class="form-check-input surg-find" type="checkbox" id="sfInfeccao" value="infeccao_secundaria">
        <label class="form-check-label" for="sfInfeccao">Infec√ß√£o secund√°ria</label>
      </div>

      <div class="form-check">
        <input class="form-check-input surg-find" type="checkbox" id="sfFolAguda" value="foliculite_aguda">
        <label class="form-check-label" for="sfFolAguda">Foliculite aguda</label>
      </div>
    </div>

    <div class="col-md-6">
      <div class="form-check">
        <input class="form-check-input surg-find" type="checkbox" id="sfFolCron" value="foliculite_cronica">
        <label class="form-check-label" for="sfFolCron">Foliculite cr√¥nica</label>
      </div>

      <div class="form-check">
        <input class="form-check-input surg-find" type="checkbox" id="sfRarefacao" value="rarefacao_capilar">
        <label class="form-check-label" for="sfRarefacao">Rarefa√ß√£o capilar</label>
      </div>

      <div class="form-check">
        <input class="form-check-input surg-find" type="checkbox" id="sfFalha" value="falha_localizada">
        <label class="form-check-label" for="sfFalha">Falha localizada</label>
      </div>
    </div>
  </div>

  <small class="text-muted d-block mt-2">
    * Esses achados ser√£o salvos junto da evolu√ß√£o (padronizado) e podem coexistir.
  </small>
</div>

<!-- ===========================
(2) JS - colar no FINAL do prontuario.html (idealmente dentro do {% block extra_js %} ou antes do fechamento do body)
=========================== -->
<script>
/**
 * PATCH DEFINITIVO - Evolu√ß√£o Cir√∫rgica com checkboxes (somente em cirurgia)
 *
 * Estrat√©gia (sem mexer no backend):
 * - Detecta contexto "cirurgia" por:
 *   (A) texto do select #evolutionConsultation contendo "cirurgia"
 *   (B) texto do display verde #evolutionConsultationName contendo "cirurgia"
 * - Quando for cirurgia: mostra checkboxes
 * - Quando n√£o for: esconde e limpa
 * - No saveEvolution(): injeta um bloco padronizado dentro do texto da evolu√ß√£o
 *   para garantir persist√™ncia mesmo se o backend ainda salva s√≥ "content".
 */

(function() {
  function $(id){ return document.getElementById(id); }

  function isSurgeryContext() {
    // 1) Se o modal tiver dataset.context expl√≠cito, respeita
    const modal = $('evolutionModal');
    const ctx = modal?.dataset?.context;
    if (ctx === 'surgery') return true;
    if (ctx === 'consultation') return false;

    // 2) Tenta detectar pelo select
    const sel = $('evolutionConsultation');
    const selText = sel?.options?.[sel.selectedIndex]?.textContent?.toLowerCase?.() || '';
    if (selText.includes('cirurgia')) return true;

    // 3) Tenta detectar pelo display verde
    const disp = $('evolutionConsultationName');
    const dispText = disp?.textContent?.toLowerCase?.() || '';
    if (dispText.includes('cirurgia')) return true;

    return false;
  }

  function showHideSurgicalBox() {
    const box = $('surgicalEvolutionFindings');
    if (!box) return;
    if (isSurgeryContext()) {
      box.style.display = 'block';
    } else {
      box.style.display = 'none';
      document.querySelectorAll('.surg-find').forEach(cb => cb.checked = false);
    }
  }

  function getCheckedFindings() {
    return Array.from(document.querySelectorAll('.surg-find:checked')).map(x => x.value);
  }

  function findingsToHuman(findings) {
    const map = {
      necrose: 'Necrose',
      crostas: 'Crostas',
      infeccao_secundaria: 'Infec√ß√£o secund√°ria',
      foliculite_aguda: 'Foliculite aguda',
      foliculite_cronica: 'Foliculite cr√¥nica',
      rarefacao_capilar: 'Rarefa√ß√£o capilar',
      falha_localizada: 'Falha localizada'
    };
    return findings.map(f => map[f] || f);
  }

  function injectFindingsIntoContentIfNeeded() {
    if (!isSurgeryContext()) return;

    const txt = $('evolutionContent');
    if (!txt) return;

    const findings = getCheckedFindings();
    // Sempre padroniza: se n√£o marcar nada, salva como "Sem achados selecionados"
    const human = findings.length ? findingsToHuman(findings).join(', ') : 'Sem achados selecionados';

    const blockHeader = '[ACHADOS CIR√öRGICOS - CHECKLIST]';
    const block = `${blockHeader}\n- ${human}\n[/ACHADOS CIR√öRGICOS]\n`;

    // Remove bloco antigo para evitar duplicar
    const current = txt.value || '';
    const cleaned = current
      .replace(/\[ACHADOS CIR√öRGICOS - CHECKLIST\][\s\S]*?\[\/ACHADOS CIR√öRGICOS\]\n?/g, '')
      .trim();

    // Insere no topo (padr√£o fixo)
    txt.value = (block + '\n' + cleaned).trim();
  }

  // ---- Ganchos para atualiza√ß√£o do contexto ----
  document.addEventListener('DOMContentLoaded', function() {
    // 1) Ao mudar o select, reavalia contexto
    const sel = $('evolutionConsultation');
    if (sel) {
      sel.addEventListener('change', function() {
        // opcional: se quiser fixar dataset.context automaticamente
        const modal = $('evolutionModal');
        const txt = sel.options[sel.selectedIndex]?.textContent?.toLowerCase?.() || '';
        if (modal) modal.dataset.context = txt.includes('cirurgia') ? 'surgery' : 'consultation';
        showHideSurgicalBox();
      });
    }

    // 2) Ao abrir o modal, reavalia
    const modalEl = $('evolutionModal');
    if (modalEl) {
      modalEl.addEventListener('shown.bs.modal', function() {
        showHideSurgicalBox();
      });
    }

    // 3) Se o usu√°rio clicar nos checkboxes, mant√©m o texto sempre preparado
    document.addEventListener('change', function(e) {
      if (e.target && e.target.classList && e.target.classList.contains('surg-find')) {
        // n√£o injeta automaticamente (para n√£o atrapalhar enquanto digita),
        // mas pode ser √∫til manter o bloco pronto se voc√™ quiser:
        // injectFindingsIntoContentIfNeeded();
      }
    });

    // 4) Intercepta saveEvolution() SEM precisar editar o arquivo JS original:
    //    - Se saveEvolution existir globalmente, ‚Äúwrap‚Äù com inje√ß√£o do checklist antes de salvar
    const originalSaveEvolution = window.saveEvolution;
    if (typeof originalSaveEvolution === 'function') {
      window.saveEvolution = function() {
        // garante que o checklist vai junto (no texto)
        injectFindingsIntoContentIfNeeded();
        return originalSaveEvolution.apply(this, arguments);
      };
    }

    // Primeira avalia√ß√£o
    showHideSurgicalBox();
  });

})();
</script>

<!-- ===========================
FIM DO PATCH √öNICO
=========================== -->
```
