document.addEventListener('DOMContentLoaded', function() {
    // Op√ß√µes r√°pidas para posologia
    document.querySelectorAll('.quick-posology').forEach(btn => {
        btn.addEventListener('click', function() {
            const posology = this.getAttribute('data-posology');
            // Verifica se √© um bot√£o de posologia espec√≠fico para isotretino√≠na
            if (this.closest('#isotretinoinForm')) {
                document.getElementById('isotretinoinInstructions').value = posology;
            } else {
                // Para outros bot√µes de posologia (na estrutura normal)
                const parentCol = this.closest('.col-md-5') || this.closest('.mb-3');
                if (parentCol) {
                    const instructionsInput = parentCol.querySelector('input[type="text"]');
                    if (instructionsInput) {
                        instructionsInput.value = posology;
                    }
                }
            }
        });
    });
    // DOM Elements
    const medicationInput = document.getElementById('medicationInput');
    const clearMedicationInput = document.getElementById('clearMedicationInput');
    const suggestionsList = document.getElementById('suggestionsList');
    const oralMedicationsList = document.getElementById('oralMedicationsList');
    const topicalMedicationsList = document.getElementById('topicalMedicationsList');
    const medicationCount = document.getElementById('medicationCount');
    const prescriptionForm = document.getElementById('prescriptionForm');
    const patientNameInput = document.getElementById('patientName');
    const templatePatientNameInput = document.getElementById('templatePatientName');
    const previewPatientName = document.getElementById('previewPatientName');
    const previewOralMedications = document.getElementById('previewOralMedications');
    const previewTopicalMedications = document.getElementById('previewTopicalMedications');
    const copyPrescription = document.getElementById('copyPrescription');
    const printPrescription = document.getElementById('printPrescription');
    const copyToast = document.getElementById('copyToast');
    const addManualMedicationBtn = document.getElementById('addManualMedication');
    const clearFormBtn = document.getElementById('clearForm');
    
    // Bootstrap toast initialization
    const toast = new bootstrap.Toast(copyToast);
    
    // Medication tracking
    let medications = {
        oral: [],
        topical: []
    };
    
    // Update medication count
    function updateMedicationCount() {
        const totalCount = medications.oral.length + medications.topical.length;
        medicationCount.textContent = `${totalCount}/5`;
        
        if (totalCount >= 5) {
            medicationInput.disabled = true;
            medicationInput.placeholder = "Limite de 5 medicamentos atingido";
        } else {
            medicationInput.disabled = false;
            medicationInput.placeholder = "Digite para buscar medicamentos...";
        }
    }
    
    // Clear input field
    clearMedicationInput.addEventListener('click', function() {
        medicationInput.value = '';
        suggestionsList.innerHTML = '';
        suggestionsList.classList.add('d-none');
    });
    
    // Handle input for medication suggestions
    let debounceTimer;
    medicationInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        
        const inputValue = this.value.trim();
        
        if (inputValue.length < 3) {
            suggestionsList.innerHTML = '';
            suggestionsList.classList.add('d-none');
            return;
        }
        
        debounceTimer = setTimeout(() => {
            fetchMedicationSuggestions(inputValue);
        }, 500);
    });
    
    // Fetch medication suggestions from API
    function fetchMedicationSuggestions(partialInput) {
        fetch('/api/suggest-medications', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                partial_input: partialInput
            })
        })
        .then(response => response.json())
        .then(data => {
            displaySuggestions(data.suggestions || []);
        })
        .catch(error => {
            console.error('Error fetching suggestions:', error);
            suggestionsList.innerHTML = `<div class="list-group-item text-danger">Erro ao buscar sugest√µes</div>`;
            suggestionsList.classList.remove('d-none');
        });
    }
    
    // Display medication suggestions
    function displaySuggestions(suggestions) {
        suggestionsList.innerHTML = '';
        
        if (suggestions.length === 0 || (suggestions.length === 1 && suggestions[0].error)) {
            suggestionsList.innerHTML = `<div class="list-group-item text-muted">Nenhuma sugest√£o encontrada</div>`;
            suggestionsList.classList.remove('d-none');
            return;
        }
        
        suggestions.forEach(suggestion => {
            const item = document.createElement('div');
            item.className = 'list-group-item suggestion-item';
            
            const typeClass = suggestion.type === 'topical' ? 'bg-success' : 'bg-primary';
            const typeIcon = suggestion.type === 'topical' ? 'fa-prescription-bottle' : 'fa-pills';
            
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div><strong>${suggestion.medication}</strong></div>
                        <small class="text-muted">${suggestion.instructions || ''}</small>
                    </div>
                    <span class="badge ${typeClass}">
                        <i class="fas ${typeIcon} me-1"></i>
                        ${suggestion.type === 'topical' ? 'T√≥pico' : 'Oral'}
                    </span>
                </div>
            `;
            
            item.addEventListener('click', () => {
                addMedication(suggestion);
                medicationInput.value = '';
                suggestionsList.innerHTML = '';
                suggestionsList.classList.add('d-none');
            });
            
            suggestionsList.appendChild(item);
        });
        
        suggestionsList.classList.remove('d-none');
    }
    
    // Add medication to the list
    function addMedication(medication) {
        const totalCount = medications.oral.length + medications.topical.length;
        
        if (totalCount >= 5) {
            alert('Voc√™ atingiu o limite de 5 medicamentos por prescri√ß√£o.');
            return;
        }
        
        const type = medication.type.toLowerCase();
        const list = type === 'oral' ? oralMedicationsList : topicalMedicationsList;
        
        // Check if medication already exists
        const exists = [...medications.oral, ...medications.topical].some(m => 
            m.medication.toLowerCase() === medication.medication.toLowerCase());
            
        if (exists) {
            alert('Este medicamento j√° foi adicionado √† prescri√ß√£o.');
            return;
        }
        
        // Add to the appropriate array
        if (type === 'oral') {
            medications.oral.push(medication);
        } else {
            medications.topical.push(medication);
        }
        
        // Update the list UI
        updateMedicationsList();
        updatePreview();
        updateMedicationCount();
    }
    
    // Add medication manually
    function addManualMedication() {
        const medName = document.getElementById('manualMedicationName').value.trim();
        const medType = document.getElementById('manualMedicationType').value;
        const medInstructions = document.getElementById('manualMedicationInstructions').value.trim();
        
        if (!medName) {
            alert('Por favor, digite o nome do medicamento.');
            return;
        }
        
        if (!medType) {
            alert('Por favor, selecione o tipo de medicamento (oral ou t√≥pico).');
            return;
        }
        
        const totalCount = medications.oral.length + medications.topical.length;
        if (totalCount >= 5) {
            alert('Voc√™ atingiu o limite de 5 medicamentos por prescri√ß√£o.');
            return;
        }
        
        // Check if medication already exists
        const exists = [...medications.oral, ...medications.topical].some(m => 
            m.medication.toLowerCase() === medName.toLowerCase());
            
        if (exists) {
            alert('Este medicamento j√° foi adicionado √† prescri√ß√£o.');
            return;
        }
        
        // Determine instructions - use manually entered if provided, otherwise use default
        let instructions = '';
        if (medInstructions) {
            instructions = medInstructions;
        } else {
            instructions = medType === 'oral' ? 
                'Tomar conforme orienta√ß√£o m√©dica' : 
                'Aplicar uma fina camada na √°rea afetada 1-2 vezes ao dia';
        }
        
        // Create a new medication object
        const newMedication = {
            medication: medName,
            type: medType,
            instructions: instructions
        };
        
        // Add to the appropriate array
        if (medType === 'oral') {
            medications.oral.push(newMedication);
        } else {
            medications.topical.push(newMedication);
        }
        
        // Salvar o medicamento no banco de dados para sugest√µes futuras
        saveMedicationToDatabase(newMedication);
        
        // Clear form
        document.getElementById('manualMedicationName').value = '';
        document.getElementById('manualMedicationType').value = '';
        document.getElementById('manualMedicationInstructions').value = '';
        
        // Update the UI
        updateMedicationsList();
        updatePreview();
        updateMedicationCount();
    }
    
    // Edit medication instructions
    function editMedicationInstructions(type, index) {
        const med = medications[type][index];
        const currentInstructions = med.instructions || '';
        
        // Prompt for new instructions with a helpful message
        const promptMessage = `Editar posologia para "${med.medication}":
(Exemplos: "Aplicar 2x ao dia nas √°reas afetadas", "Tomar 1 comprimido pela manh√£")`;
        
        const newInstructions = prompt(promptMessage, currentInstructions);
        
        // Update if not cancelled and not empty
        if (newInstructions !== null) {
            med.instructions = newInstructions.trim() || currentInstructions;
            updateMedicationsList();
            updatePreview();
        }
    }
    
    // Update medications lists UI
    function updateMedicationsList() {
        // Update oral medications list
        if (medications.oral.length === 0) {
            oralMedicationsList.innerHTML = '<li class="list-group-item text-muted empty-list">Nenhum medicamento oral adicionado</li>';
        } else {
            oralMedicationsList.innerHTML = '';
            medications.oral.forEach((med, index) => {
                const item = document.createElement('li');
                item.className = 'list-group-item medication-item';
                item.innerHTML = `
                    <div>
                        <div><strong>${med.medication}</strong></div>
                        <small class="text-muted">${med.instructions || ''}</small>
                    </div>
                    <div class="medication-actions">
                        <i class="fas fa-edit edit-medication me-2" title="Editar posologia" data-type="oral" data-index="${index}"></i>
                        <i class="fas fa-times remove-medication" title="Remover medicamento" data-type="oral" data-index="${index}"></i>
                    </div>
                `;
                oralMedicationsList.appendChild(item);
            });
        }
        
        // Update topical medications list
        if (medications.topical.length === 0) {
            topicalMedicationsList.innerHTML = '<li class="list-group-item text-muted empty-list">Nenhum medicamento t√≥pico adicionado</li>';
        } else {
            topicalMedicationsList.innerHTML = '';
            medications.topical.forEach((med, index) => {
                const item = document.createElement('li');
                item.className = 'list-group-item medication-item';
                item.innerHTML = `
                    <div>
                        <div><strong>${med.medication}</strong></div>
                        <small class="text-muted">${med.instructions || ''}</small>
                    </div>
                    <div class="medication-actions">
                        <i class="fas fa-edit edit-medication me-2" title="Editar posologia" data-type="topical" data-index="${index}"></i>
                        <i class="fas fa-times remove-medication" title="Remover medicamento" data-type="topical" data-index="${index}"></i>
                    </div>
                `;
                topicalMedicationsList.appendChild(item);
            });
        }
        
        // Add event listeners to remove buttons
        document.querySelectorAll('.remove-medication').forEach(btn => {
            btn.addEventListener('click', function() {
                const type = this.dataset.type;
                const index = parseInt(this.dataset.index);
                removeMedication(type, index);
            });
        });
        
        // Add event listeners to edit buttons
        document.querySelectorAll('.edit-medication').forEach(btn => {
            btn.addEventListener('click', function() {
                const type = this.dataset.type;
                const index = parseInt(this.dataset.index);
                editMedicationInstructions(type, index);
            });
        });
    }
    
    // Remove medication
    function removeMedication(type, index) {
        medications[type].splice(index, 1);
        updateMedicationsList();
        updatePreview();
        updateMedicationCount();
    }
    
    // Update prescription preview
    function updatePreview() {
        // Update patient name
        const patientName = patientNameInput.value.trim() || '______________________';
        previewPatientName.textContent = patientName;
        
        // Update oral medications
        if (medications.oral.length === 0) {
            previewOralMedications.classList.add('d-none');
        } else {
            previewOralMedications.classList.remove('d-none');
            const list = previewOralMedications.querySelector('.medication-list');
            list.innerHTML = '';
            
            medications.oral.forEach(med => {
                const item = document.createElement('li');
                item.innerHTML = `
                    <strong>${med.medication}</strong>
                    ${med.instructions ? `<br><span>${med.instructions}</span>` : ''}
                `;
                list.appendChild(item);
            });
        }
        
        // Update topical medications
        if (medications.topical.length === 0) {
            previewTopicalMedications.classList.add('d-none');
        } else {
            previewTopicalMedications.classList.remove('d-none');
            const list = previewTopicalMedications.querySelector('.medication-list');
            list.innerHTML = '';
            
            medications.topical.forEach(med => {
                const item = document.createElement('li');
                item.innerHTML = `
                    <strong>${med.medication}</strong>
                    ${med.instructions ? `<br><span>${med.instructions}</span>` : ''}
                `;
                list.appendChild(item);
            });
        }
    }
    
    // Patient name input event
    patientNameInput.addEventListener('input', updatePreview);
    
    // Save medication to database
    function saveMedicationToDatabase(medication) {
        fetch('/api/save-medication', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(medication)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Medicamento salvo no banco de dados');
                // Opcional: mostrar um feedback visual
                const toast = new bootstrap.Toast(document.getElementById('saveToast'));
                document.getElementById('saveToastMessage').textContent = 'Medicamento adicionado ao banco de dados para uso futuro.';
                toast.show();
            } else if (data.status === 'exists') {
                console.log('Medicamento j√° existia no banco de dados');
            } else {
                console.warn('Resposta inesperada ao salvar medicamento:', data);
            }
        })
        .catch(error => {
            console.error('Erro ao salvar medicamento no banco de dados:', error);
        });
    }
    
    // Form submission (Generate Prescription)
    prescriptionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const totalMedications = medications.oral.length + medications.topical.length;
        
        if (totalMedications === 0) {
            alert('Adicione pelo menos um medicamento √† prescri√ß√£o.');
            return;
        }
        
        // The preview is already updated in real-time, so we don't need to do anything here
        // Just scroll to the preview section
        document.getElementById('prescriptionPreview').scrollIntoView({ behavior: 'smooth' });
    });
    
    // Arrays para medicamentos do receitu√°rio de antibi√≥ticos
    let antibioticOralMeds = [];
    let antibioticTopicalMeds = [];
    
    // Adicionar medicamento oral √† lista de antibi√≥ticos
    if (document.getElementById('addAntibioticOral')) {
        document.getElementById('addAntibioticOral').addEventListener('click', function() {
            const medicationName = document.getElementById('antibioticOralName').value.trim();
            const medicationInstructions = document.getElementById('antibioticOralInstructions').value.trim();
            
            if (!medicationName) {
                alert('Por favor, informe o nome do medicamento oral.');
                return;
            }
            
            if (!medicationInstructions) {
                alert('Por favor, informe a posologia do medicamento oral.');
                return;
            }
            
            const newMedication = {
                name: medicationName,
                type: 'oral',
                instructions: medicationInstructions
            };
            
            antibioticOralMeds.push(newMedication);
            
            // Limpar campos para o pr√≥ximo medicamento
            document.getElementById('antibioticOralName').value = '';
            document.getElementById('antibioticOralInstructions').value = '';
            document.getElementById('antibioticOralName').focus();
            
            // Atualizar a lista e preview
            updateAntibioticMedicationLists();
            updateAntibioticPreview();
            
            // Salvar o medicamento no banco de dados para uso futuro
            saveMedicationToDatabase({
                medication: medicationName,
                type: 'oral',
                instructions: medicationInstructions
            });
        });
    }
    
    // Adicionar medicamento t√≥pico √† lista de antibi√≥ticos
    if (document.getElementById('addAntibioticTopical')) {
        document.getElementById('addAntibioticTopical').addEventListener('click', function() {
            const medicationName = document.getElementById('antibioticTopicalName').value.trim();
            const medicationInstructions = document.getElementById('antibioticTopicalInstructions').value.trim();
            
            if (!medicationName) {
                alert('Por favor, informe o nome do medicamento t√≥pico.');
                return;
            }
            
            if (!medicationInstructions) {
                alert('Por favor, informe a posologia do medicamento t√≥pico.');
                return;
            }
            
            const newMedication = {
                name: medicationName,
                type: 'topical',
                instructions: medicationInstructions
            };
            
            antibioticTopicalMeds.push(newMedication);
            
            // Limpar campos para o pr√≥ximo medicamento
            document.getElementById('antibioticTopicalName').value = '';
            document.getElementById('antibioticTopicalInstructions').value = '';
            document.getElementById('antibioticTopicalName').focus();
            
            // Atualizar a lista e preview
            updateAntibioticMedicationLists();
            updateAntibioticPreview();
            
            // Salvar o medicamento no banco de dados para uso futuro
            saveMedicationToDatabase({
                medication: medicationName,
                type: 'topical',
                instructions: medicationInstructions
            });
        });
    }
    
    // Atualizar listas de medicamentos do receitu√°rio de antibi√≥ticos
    function updateAntibioticMedicationLists() {
        // Atualizar lista de medicamentos orais
        const oralList = document.getElementById('antibioticOralList');
        oralList.innerHTML = '';
        
        if (antibioticOralMeds.length === 0) {
            oralList.innerHTML = '<li class="list-group-item text-muted empty-list">Nenhum medicamento oral adicionado</li>';
        } else {
            antibioticOralMeds.forEach((medication, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <div>
                        <strong>${medication.name}</strong>
                        <p class="mb-0 text-muted small">${medication.instructions}</p>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-danger remove-antibiotic-med" data-type="oral" data-index="${index}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                oralList.appendChild(li);
            });
            
            // Adicionar eventos para os bot√µes de remover
            document.querySelectorAll('.remove-antibiotic-med[data-type="oral"]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    antibioticOralMeds.splice(index, 1);
                    updateAntibioticMedicationLists();
                    updateAntibioticPreview();
                });
            });
        }
        
        // Atualizar lista de medicamentos t√≥picos
        const topicalList = document.getElementById('antibioticTopicalList');
        topicalList.innerHTML = '';
        
        if (antibioticTopicalMeds.length === 0) {
            topicalList.innerHTML = '<li class="list-group-item text-muted empty-list">Nenhum medicamento t√≥pico adicionado</li>';
        } else {
            antibioticTopicalMeds.forEach((medication, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <div>
                        <strong>${medication.name}</strong>
                        <p class="mb-0 text-muted small">${medication.instructions}</p>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-danger remove-antibiotic-med" data-type="topical" data-index="${index}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                topicalList.appendChild(li);
            });
            
            // Adicionar eventos para os bot√µes de remover
            document.querySelectorAll('.remove-antibiotic-med[data-type="topical"]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    antibioticTopicalMeds.splice(index, 1);
                    updateAntibioticMedicationLists();
                    updateAntibioticPreview();
                });
            });
        }
    }
    
    // Atualizar preview do receitu√°rio de antibi√≥ticos
    function updateAntibioticPreview() {
        const patientName = document.getElementById('antibioticPatientName').value.trim() || '______________________';
        
        // Atualizar nome do paciente
        document.getElementById('antibioticPatientNameDisplay').textContent = patientName;
        document.getElementById('antibioticPatientNameDisplay2').textContent = patientName;
        
        // Mostrar ou ocultar se√ß√µes com base na disponibilidade de medicamentos
        // Primeira via
        if (antibioticOralMeds.length > 0) {
            document.getElementById('antibioticPreviewOral').classList.remove('d-none');
            updateAntibioticMedicationPreview('oral', 'antibioticOralItemsPreview');
        } else {
            document.getElementById('antibioticPreviewOral').classList.add('d-none');
        }
        
        if (antibioticTopicalMeds.length > 0) {
            document.getElementById('antibioticPreviewTopical').classList.remove('d-none');
            updateAntibioticMedicationPreview('topical', 'antibioticTopicalItemsPreview');
        } else {
            document.getElementById('antibioticPreviewTopical').classList.add('d-none');
        }
        
        // Segunda via
        if (antibioticOralMeds.length > 0) {
            document.getElementById('antibioticPreviewOral2').classList.remove('d-none');
            updateAntibioticMedicationPreview('oral', 'antibioticOralItemsPreview2');
        } else {
            document.getElementById('antibioticPreviewOral2').classList.add('d-none');
        }
        
        if (antibioticTopicalMeds.length > 0) {
            document.getElementById('antibioticPreviewTopical2').classList.remove('d-none');
            updateAntibioticMedicationPreview('topical', 'antibioticTopicalItemsPreview2');
        } else {
            document.getElementById('antibioticPreviewTopical2').classList.add('d-none');
        }
        
        // Ajustar escala automaticamente com base na quantidade de medicamentos para impress√£o
        const totalMeds = antibioticOralMeds.length + antibioticTopicalMeds.length;
        const preview = document.getElementById('antibioticPreview');
        
        // Escala base √© 1.0 para visualiza√ß√£o normal
        let scale = 1.0;
        
        // Para impress√£o, calcular escala baseada no conte√∫do
        // Adicionar classe para controle de impress√£o
        preview.classList.remove('print-scale-small', 'print-scale-medium', 'print-scale-large');
        
        if (totalMeds <= 2) {
            preview.classList.add('print-scale-large'); // 0.85
        } else if (totalMeds <= 4) {
            preview.classList.add('print-scale-medium'); // 0.75
        } else {
            preview.classList.add('print-scale-small'); // 0.65
        }
        
        // Aplicar escala normal para visualiza√ß√£o
        preview.style.transform = `scale(${scale})`;
    }
    
    // Fun√ß√£o auxiliar para atualizar o preview de medicamentos no receitu√°rio de antibi√≥ticos
    function updateAntibioticMedicationPreview(type, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        const medications = type === 'oral' ? antibioticOralMeds : antibioticTopicalMeds;
        
        // Como agora ocultamos se√ß√µes vazias, n√£o precisamos mostrar a mensagem "Nenhum medicamento adicionado"
        if (medications.length > 0) {
            medications.forEach((medication, index) => {
                const div = document.createElement('div');
                div.className = 'antibiotic-item';
                div.innerHTML = `
                    <div class="antibiotic-number">${index + 1}.</div>
                    <div class="antibiotic-details">
                        <p class="antibiotic-name">${medication.name}</p>
                        <p class="antibiotic-instructions">${medication.instructions}</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }
    }
    
    // Gerar o receitu√°rio de antibi√≥ticos
    if (document.getElementById('generateAntibioticPrescription')) {
        document.getElementById('generateAntibioticPrescription').addEventListener('click', function() {
            const patientName = document.getElementById('antibioticPatientName').value.trim();
            
            if (!patientName) {
                alert('Por favor, insira o nome do paciente.');
                return;
            }
            
            const totalMeds = antibioticOralMeds.length + antibioticTopicalMeds.length;
            
            if (totalMeds === 0) {
                alert('Por favor, adicione pelo menos um medicamento √† prescri√ß√£o.');
                return;
            }
            
            // Esconder o preview padr√£o e mostrar o preview de antibi√≥ticos
            document.getElementById('prescriptionPreview').classList.add('d-none');
            document.getElementById('antibioticPreview').classList.remove('d-none');
            document.getElementById('isotretinoinPreview').classList.add('d-none');
            
            // Ajustar bot√µes de impress√£o e c√≥pia
            document.getElementById('printPrescription').innerHTML = '<i class="fas fa-print me-1"></i>Imprimir Receitu√°rio';
            document.getElementById('copyPrescription').classList.add('d-none');
            
            // Rastrear medicamentos de antibi√≥ticos
            const allAntibioticMeds = [...antibioticOralMeds, ...antibioticTopicalMeds];
            trackPrescriptionUsage(allAntibioticMeds);
            
            // Atualizar o preview com as informa√ß√µes atuais
            updateAntibioticPreview();
        });
    }
    
    // Isotretino√≠na receitu√°rio controlado
    if (document.getElementById('generateIsotretinoinPrescription')) {
        document.getElementById('generateIsotretinoinPrescription').addEventListener('click', function() {
            const patientName = document.getElementById('isotretinoinPatientName').value.trim();
            const dosage = document.getElementById('isotretinoinDosage').value;
            const instructions = document.getElementById('isotretinoinInstructions').value.trim();
            
            if (!patientName) {
                alert('Por favor, insira o nome do paciente.');
                return;
            }
            
            // Atualizar o preview do receitu√°rio de isotretino√≠na
            document.getElementById('isotretinoinPatientNameDisplay').textContent = patientName;
            document.getElementById('isotretinoinPatientNameDisplay2').textContent = patientName;
            
            document.getElementById('isotretinoinNameDisplay').textContent = `isotretino√≠na ${dosage}`;
            document.getElementById('isotretinoinNameDisplay2').textContent = `isotretino√≠na ${dosage}`;
            
            document.getElementById('isotretinoinInstructionsDisplay').textContent = instructions;
            document.getElementById('isotretinoinInstructionsDisplay2').textContent = instructions;
            
            // Esconder outros previews e mostrar o preview de isotretino√≠na
            document.getElementById('prescriptionPreview').classList.add('d-none');
            document.getElementById('antibioticPreview').classList.add('d-none');
            document.getElementById('isotretinoinPreview').classList.remove('d-none');
            
            // Ajustar bot√µes de impress√£o e c√≥pia
            document.getElementById('printPrescription').innerHTML = '<i class="fas fa-print me-1"></i>Imprimir Receitu√°rio';
            document.getElementById('copyPrescription').classList.add('d-none');
            
            // Rastrear prescri√ß√£o de isotretino√≠na
            trackPrescriptionUsage([{
                medication: `isotretino√≠na ${dosage}`,
                type: 'oral',
                instructions: instructions
            }]);
            
            // Salvar isotretino√≠na no banco de dados para uso futuro
            saveMedicationToDatabase({
                medication: `isotretino√≠na ${dosage}`,
                type: 'oral',
                instructions: instructions
            });
        });
    }
    
    // Arrays para medicamentos do receitu√°rio Dr Filipe
    let drFilipeOralMeds = [];
    let drFilipeTopicalMeds = [];
    
    // Bot√µes de atalho para posologia Dr Filipe - Oral
    document.querySelectorAll('.drfilipe-quick-posology-oral').forEach(btn => {
        btn.addEventListener('click', function() {
            const medName = this.getAttribute('data-med');
            const posology = this.getAttribute('data-posology');
            document.getElementById('drFilipeOralName').value = medName;
            document.getElementById('drFilipeOralInstructions').value = posology;
        });
    });
    
    // Bot√µes de atalho para posologia Dr Filipe - T√≥pico
    document.querySelectorAll('.drfilipe-quick-posology-topical').forEach(btn => {
        btn.addEventListener('click', function() {
            const medName = this.getAttribute('data-med');
            const posology = this.getAttribute('data-posology');
            document.getElementById('drFilipeTopicalName').value = medName;
            document.getElementById('drFilipeTopicalInstructions').value = posology;
        });
    });
    
    // Adicionar medicamento oral √† lista Dr Filipe
    if (document.getElementById('addDrFilipeOral')) {
        document.getElementById('addDrFilipeOral').addEventListener('click', function() {
            const medicationName = document.getElementById('drFilipeOralName').value.trim();
            const medicationInstructions = document.getElementById('drFilipeOralInstructions').value.trim();
            
            if (!medicationName) {
                alert('Por favor, selecione um medicamento oral.');
                return;
            }
            
            if (!medicationInstructions) {
                alert('Por favor, informe a posologia do medicamento oral.');
                return;
            }
            
            const newMedication = {
                name: medicationName,
                type: 'oral',
                instructions: medicationInstructions
            };
            
            drFilipeOralMeds.push(newMedication);
            
            // Limpar campos
            document.getElementById('drFilipeOralName').value = '';
            document.getElementById('drFilipeOralInstructions').value = '';
            document.getElementById('drFilipeOralName').focus();
            
            // Atualizar listas e preview
            updateDrFilipeMedicationLists();
            updateDrFilipePreview();
            
            // Salvar no banco de dados
            saveMedicationToDatabase({
                medication: medicationName,
                type: 'oral',
                instructions: medicationInstructions
            });
        });
    }
    
    // Adicionar medicamento t√≥pico √† lista Dr Filipe
    if (document.getElementById('addDrFilipeTopical')) {
        document.getElementById('addDrFilipeTopical').addEventListener('click', function() {
            const medicationName = document.getElementById('drFilipeTopicalName').value.trim();
            const medicationInstructions = document.getElementById('drFilipeTopicalInstructions').value.trim();
            
            if (!medicationName) {
                alert('Por favor, selecione um medicamento t√≥pico.');
                return;
            }
            
            if (!medicationInstructions) {
                alert('Por favor, informe a posologia do medicamento t√≥pico.');
                return;
            }
            
            const newMedication = {
                name: medicationName,
                type: 'topical',
                instructions: medicationInstructions
            };
            
            drFilipeTopicalMeds.push(newMedication);
            
            // Limpar campos
            document.getElementById('drFilipeTopicalName').value = '';
            document.getElementById('drFilipeTopicalInstructions').value = '';
            document.getElementById('drFilipeTopicalName').focus();
            
            // Atualizar listas e preview
            updateDrFilipeMedicationLists();
            updateDrFilipePreview();
            
            // Salvar no banco de dados
            saveMedicationToDatabase({
                medication: medicationName,
                type: 'topical',
                instructions: medicationInstructions
            });
        });
    }
    
    // Atualizar listas de medicamentos Dr Filipe
    function updateDrFilipeMedicationLists() {
        // Atualizar lista oral
        const oralList = document.getElementById('drFilipeOralList');
        oralList.innerHTML = '';
        
        if (drFilipeOralMeds.length === 0) {
            oralList.innerHTML = '<li class="list-group-item text-muted empty-list">Nenhum medicamento oral adicionado</li>';
        } else {
            drFilipeOralMeds.forEach((medication, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <div>
                        <strong>${medication.name}</strong>
                        <p class="mb-0 text-muted small">${medication.instructions}</p>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-danger remove-drfilipe-med" data-type="oral" data-index="${index}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                oralList.appendChild(li);
            });
            
            document.querySelectorAll('.remove-drfilipe-med[data-type="oral"]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    drFilipeOralMeds.splice(index, 1);
                    updateDrFilipeMedicationLists();
                    updateDrFilipePreview();
                });
            });
        }
        
        // Atualizar lista t√≥pica
        const topicalList = document.getElementById('drFilipeTopicalList');
        topicalList.innerHTML = '';
        
        if (drFilipeTopicalMeds.length === 0) {
            topicalList.innerHTML = '<li class="list-group-item text-muted empty-list">Nenhum medicamento t√≥pico adicionado</li>';
        } else {
            drFilipeTopicalMeds.forEach((medication, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <div>
                        <strong>${medication.name}</strong>
                        <p class="mb-0 text-muted small">${medication.instructions}</p>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-danger remove-drfilipe-med" data-type="topical" data-index="${index}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                topicalList.appendChild(li);
            });
            
            document.querySelectorAll('.remove-drfilipe-med[data-type="topical"]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    drFilipeTopicalMeds.splice(index, 1);
                    updateDrFilipeMedicationLists();
                    updateDrFilipePreview();
                });
            });
        }
    }
    
    // Atualizar preview Dr Filipe
    function updateDrFilipePreview() {
        const patientName = document.getElementById('drFilipePatientName').value.trim() || '______________________';
        
        // Atualizar nome do paciente em ambas as metades
        document.getElementById('drFilipePatientNameDisplay').textContent = patientName;
        document.getElementById('drFilipePatientNameDisplay2').textContent = patientName;
        
        // Atualizar medicamentos orais - primeira metade
        updateDrFilipeMedicationPreview('oral', 'drFilipeOralItemsPreview');
        // Atualizar medicamentos orais - segunda metade
        updateDrFilipeMedicationPreview('oral', 'drFilipeOralItemsPreview2');
        
        // Atualizar medicamentos t√≥picos - primeira metade
        updateDrFilipeMedicationPreview('topical', 'drFilipeTopicalItemsPreview');
        // Atualizar medicamentos t√≥picos - segunda metade
        updateDrFilipeMedicationPreview('topical', 'drFilipeTopicalItemsPreview2');
    }
    
    // Fun√ß√£o auxiliar para atualizar preview de medicamentos Dr Filipe
    function updateDrFilipeMedicationPreview(type, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        const medications = type === 'oral' ? drFilipeOralMeds : drFilipeTopicalMeds;
        
        if (medications.length > 0) {
            medications.forEach((medication, index) => {
                const div = document.createElement('div');
                div.className = 'drfilipe-item';
                div.innerHTML = `
                    <div class="drfilipe-item-number">${index + 1}.</div>
                    <div class="drfilipe-item-content">
                        <div class="drfilipe-med-name">${medication.name}</div>
                        <div class="drfilipe-med-instructions">${medication.instructions}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
    }
    
    // Atualizar preview do nome do paciente em tempo real
    if (document.getElementById('drFilipePatientName')) {
        document.getElementById('drFilipePatientName').addEventListener('input', function() {
            updateDrFilipePreview();
        });
    }
    
    // Gerar receita Dr Filipe
    if (document.getElementById('generateDrFilipePrescription')) {
        document.getElementById('generateDrFilipePrescription').addEventListener('click', function() {
            const patientName = document.getElementById('drFilipePatientName').value.trim();
            
            if (!patientName) {
                alert('Por favor, insira o nome do paciente.');
                return;
            }
            
            const totalMeds = drFilipeOralMeds.length + drFilipeTopicalMeds.length;
            
            if (totalMeds === 0) {
                alert('Por favor, adicione pelo menos um medicamento √† prescri√ß√£o.');
                return;
            }
            
            // Esconder outros previews e mostrar o preview Dr Filipe
            document.getElementById('prescriptionPreview').classList.add('d-none');
            document.getElementById('antibioticPreview').classList.add('d-none');
            document.getElementById('isotretinoinPreview').classList.add('d-none');
            document.getElementById('drFilipePreview').classList.remove('d-none');
            
            // Ajustar bot√µes
            document.getElementById('printPrescription').innerHTML = '<i class="fas fa-print me-1"></i>Imprimir Receita';
            document.getElementById('copyPrescription').classList.add('d-none');
            
            // Rastrear prescri√ß√£o
            const allDrFilipeMeds = [...drFilipeOralMeds, ...drFilipeTopicalMeds];
            trackPrescriptionUsage(allDrFilipeMeds);
            
            // Atualizar preview
            updateDrFilipePreview();
        });
    }
    
    // Evento para alternar entre os tabs e alternar entre os previews
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('click', function() {
            const targetId = this.getAttribute('aria-controls');
            
            if (targetId === 'antibiotic-tab-content') {
                // Se selecionou a aba de antibi√≥ticos, manter o preview de antibi√≥ticos se j√° estiver vis√≠vel
                if (!document.getElementById('antibioticPreview').classList.contains('d-none')) {
                    return;
                }
                
                // Mostrar o preview de antibi√≥ticos
                document.getElementById('prescriptionPreview').classList.add('d-none');
                document.getElementById('antibioticPreview').classList.remove('d-none');
                document.getElementById('isotretinoinPreview').classList.add('d-none');
                document.getElementById('drFilipePreview').classList.add('d-none');
                document.getElementById('copyPrescription').classList.add('d-none');
            } else if (targetId === 'isotretinoin-tab-content') {
                // Se selecionou a aba de isotretino√≠na
                if (!document.getElementById('isotretinoinPreview').classList.contains('d-none')) {
                    return;
                }
                
                // Mostrar o preview de isotretino√≠na
                document.getElementById('prescriptionPreview').classList.add('d-none');
                document.getElementById('antibioticPreview').classList.add('d-none');
                document.getElementById('isotretinoinPreview').classList.remove('d-none');
                document.getElementById('drFilipePreview').classList.add('d-none');
                document.getElementById('copyPrescription').classList.add('d-none');
            } else if (targetId === 'drfilipe-tab-content') {
                // Se selecionou a aba Dr Filipe
                if (!document.getElementById('drFilipePreview').classList.contains('d-none')) {
                    return;
                }
                
                // Mostrar o preview Dr Filipe
                document.getElementById('prescriptionPreview').classList.add('d-none');
                document.getElementById('antibioticPreview').classList.add('d-none');
                document.getElementById('isotretinoinPreview').classList.add('d-none');
                document.getElementById('drFilipePreview').classList.remove('d-none');
                document.getElementById('copyPrescription').classList.add('d-none');
            } else {
                // Restaurar o preview padr√£o quando navegar para outra aba
                document.getElementById('prescriptionPreview').classList.remove('d-none');
                document.getElementById('antibioticPreview').classList.add('d-none');
                document.getElementById('isotretinoinPreview').classList.add('d-none');
                document.getElementById('drFilipePreview').classList.add('d-none');
                document.getElementById('copyPrescription').classList.remove('d-none');
                document.getElementById('printPrescription').innerHTML = '<i class="fas fa-print me-1"></i>Imprimir';
            }
        });
    });
    
    // Copy prescription button
    copyPrescription.addEventListener('click', function() {
        const prescriptionContent = document.querySelector('.prescription-content');
        
        // Create a formatted text version of the prescription
        let textContent = 'üßæ PRESCRI√á√ÉO M√âDICA\n\n';
        
        // Patient info
        textContent += `Paciente: ${previewPatientName.textContent}\n\n`;
        
        // Oral medications
        if (medications.oral.length > 0) {
            textContent += 'üíä Uso Oral:\n';
            medications.oral.forEach(med => {
                textContent += `- ${med.medication}\n`;
                if (med.instructions) {
                    textContent += `  ${med.instructions}\n`;
                }
            });
            textContent += '\n';
        }
        
        // Topical medications
        if (medications.topical.length > 0) {
            textContent += 'üß¥ Uso T√≥pico:\n';
            medications.topical.forEach(med => {
                textContent += `- ${med.medication}\n`;
                if (med.instructions) {
                    textContent += `  ${med.instructions}\n`;
                }
            });
            textContent += '\n';
        }
        
        // Doctor info
        textContent += 'Dr. Arthur Basile ‚Äì CRM 125.217\n';
        textContent += 'Dermatologista\n\n';
        
        // Clinic info
        textContent += 'Cl√≠nica Basile ‚Äì Av. Prof. Jo√£o Fi√∫sa, 2300 ‚Äì Ribeir√£o Preto ‚Äì SP\n';
        textContent += 'www.clinicabasile.com.br | Fone/Fax: (16) 3602-7785';
        
        // Copy to clipboard
        navigator.clipboard.writeText(textContent)
            .then(() => {
                toast.show();
            })
            .catch(err => {
                console.error('Failed to copy prescription: ', err);
                alert('Erro ao copiar a prescri√ß√£o. Por favor, tente novamente.');
            });
    });
    
    // Print prescription button
    printPrescription.addEventListener('click', function() {
        // Coletar todos os medicamentos para rastreamento apenas se n√£o foi rastreado ainda
        if (!prescriptionTracked) {
            const allMedications = [...medications.oral, ...medications.topical];
            
            // Se tem medicamentos, rastrear a prescri√ß√£o antes de imprimir
            if (allMedications.length > 0) {
                trackPrescriptionUsage(allMedications);
                prescriptionTracked = true;
            }
        }
        
        // Limpar classes anteriores
        document.querySelectorAll('.print-me').forEach(el => el.classList.remove('print-me'));
        
        // Buscar receitas
        const receitas = [
            document.getElementById('antibioticPreview'),
            document.getElementById('isotretinoinPreview'),
            document.getElementById('drFilipePreview'),
            document.getElementById('prescriptionPreview')
        ];
        
        // Encontrar a receita vis√≠vel (sem d-none)
        let receitaAtiva = null;
        for (let receita of receitas) {
            if (receita && !receita.classList.contains('d-none')) {
                receitaAtiva = receita;
                break;
            }
        }
        
        if (receitaAtiva) {
            console.log('Receita encontrada para impress√£o:', receitaAtiva.id);
            
            // Marcar para impress√£o
            receitaAtiva.classList.add('print-me');
            
            // Aguardar um momento para CSS ser aplicado
            setTimeout(() => {
                console.log('Iniciando impress√£o...');
                window.print();
                
                // Limpar ap√≥s impress√£o
                setTimeout(() => {
                    receitaAtiva.classList.remove('print-me');
                    console.log('Classe de impress√£o removida');
                }, 500);
            }, 100);
        } else {
            alert('Nenhuma receita ativa encontrada. Gere uma receita primeiro.');
        }
    });
    
    // Add event listener for manual medication button
    if (addManualMedicationBtn) {
        addManualMedicationBtn.addEventListener('click', addManualMedication);
    }
    
    // Function to clear the form and reset all data
    function clearForm() {
        // Reset medications arrays
        medications.oral = [];
        medications.topical = [];
        
        // Reset tracking flag
        prescriptionTracked = false;
        
        // Clear patient name
        patientNameInput.value = '';
        
        // Clear medication input
        medicationInput.value = '';
        suggestionsList.innerHTML = '';
        suggestionsList.classList.add('d-none');
        
        // Clear manual medication inputs
        document.getElementById('manualMedicationName').value = '';
        document.getElementById('manualMedicationType').value = '';
        document.getElementById('manualMedicationInstructions').value = '';
        
        // Reset the UI
        updateMedicationsList();
        updatePreview();
        updateMedicationCount();
    }
    
    // Add event listener for the clear form button
    clearFormBtn.addEventListener('click', function() {
        if (confirm('Tem certeza que deseja limpar todos os dados do formul√°rio?')) {
            clearForm();
        }
    });
    
    // Initialize the UI
    updateMedicationsList();
    updatePreview();
    updateMedicationCount();
    
    // Template patient name sync
    if (templatePatientNameInput) {
        templatePatientNameInput.addEventListener('input', function() {
            patientNameInput.value = this.value;
            updatePreview();
        });
    }
    
    // Use transplant template button
    if (document.getElementById('useTransplantTemplate')) {
        document.getElementById('useTransplantTemplate').addEventListener('click', function() {
            // Clear existing medications
            medications.oral = [];
            medications.topical = [];
            
            // Get patient name from template tab
            if (templatePatientNameInput && templatePatientNameInput.value.trim()) {
                patientNameInput.value = templatePatientNameInput.value.trim();
            }
            
            // Add pre-defined medications for post-hair transplant
            // Topical medication
            medications.topical.push({
                medication: "CAPPY",
                type: "topical",
                instructions: "APLICAR NO COURO CABELUDO 1X/DIA"
            });
            
            // Oral medications
            medications.oral.push({
                medication: "NEOSIL ATTACK",
                type: "oral",
                instructions: "TOMAR 01 CP VO POR DIA POR 3 MESES"
            });
            
            medications.oral.push({
                medication: "MINOXIDIL 2,5MG",
                type: "oral",
                instructions: "TOMAR 01 CP VO POR DIA"
            });
            
            // Update UI
            updateMedicationsList();
            updatePreview();
            updateMedicationCount();
            
            // Switch to preview
            document.getElementById('prescriptionPreview').scrollIntoView({ behavior: 'smooth' });
            
            // Switch to custom tab so user can edit if needed
            document.getElementById('custom-tab').click();
        });
    }

    // Exporta√ß√£o Excel - Bot√£o de download
    const exportExcelBtn = document.getElementById('exportMedicationsExcel');
    if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', function() {
            // Mostrar loading no bot√£o
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Gerando...';
            this.disabled = true;
            
            // Fazer download do arquivo Excel
            fetch('/api/export-medications-excel')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao gerar arquivo Excel');
                    }
                    return response.blob();
                })
                .then(blob => {
                    // Criar link de download
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    
                    // Extrair nome do arquivo da resposta se poss√≠vel, sen√£o usar nome padr√£o
                    const timestamp = new Date().toISOString().slice(0,19).replace(/[-:]/g, '').replace('T', '_');
                    a.download = `medicamentos_relatorio_${timestamp}.xlsx`;
                    
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // Mostrar mensagem de sucesso
                    alert('Arquivo Excel baixado com sucesso!');
                })
                .catch(error => {
                    console.error('Erro ao exportar Excel:', error);
                    alert('Erro ao gerar arquivo Excel. Tente novamente.');
                })
                .finally(() => {
                    // Restaurar bot√£o
                    this.innerHTML = originalText;
                    this.disabled = false;
                });
        });
    }

    // Fun√ß√£o para rastrear prescri√ß√µes quando gerar receita
    function trackPrescriptionUsage(medicationsList) {
        if (medicationsList && medicationsList.length > 0) {
            fetch('/api/track-prescription', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    medications: medicationsList
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Prescri√ß√£o registrada para analytics:', data.message);
            })
            .catch(error => {
                console.error('Erro ao registrar prescri√ß√£o:', error);
                // N√£o exibir erro para o usu√°rio, apenas log
            });
        }
    }

    // Vari√°vel para controlar se j√° foi rastreado nesta sess√£o
    let prescriptionTracked = false;

    // Bot√£o "Gerar Prescri√ß√£o" no cabe√ßalho da visualiza√ß√£o
    const generatePrescriptionBtn = document.getElementById('generatePrescription');
    if (generatePrescriptionBtn) {
        generatePrescriptionBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Validar se tem nome do paciente
            const patientName = patientNameInput.value.trim();
            if (!patientName) {
                alert('Por favor, insira o nome do paciente.');
                patientNameInput.focus();
                return;
            }
            
            // Validar se tem medicamentos
            const totalMeds = medications.oral.length + medications.topical.length;
            if (totalMeds === 0) {
                alert('Por favor, adicione pelo menos um medicamento √† prescri√ß√£o.');
                return;
            }
            
            // Coletar todos os medicamentos e rastrear apenas uma vez
            if (!prescriptionTracked) {
                const allMedications = [...medications.oral, ...medications.topical];
                trackPrescriptionUsage(allMedications);
                prescriptionTracked = true;
            }
            
            // Continuar com a gera√ß√£o normal da prescri√ß√£o
            generatePrescription();
        });
    }

    // Modificar a fun√ß√£o de gerar prescri√ß√£o para incluir rastreamento
    prescriptionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Coletar todos os medicamentos e rastrear apenas se n√£o foi rastreado ainda
        if (!prescriptionTracked) {
            const allMedications = [...medications.oral, ...medications.topical];
            trackPrescriptionUsage(allMedications);
            prescriptionTracked = true;
        }
        
        // Continuar com a gera√ß√£o normal da prescri√ß√£o
        generatePrescription();
    });

    // Gerenciamento da aba de estat√≠sticas
    const analyticsTab = document.getElementById('analytics-tab');
    if (analyticsTab) {
        analyticsTab.addEventListener('click', function() {
            loadAnalyticsData();
        });
    }

    // Bot√£o de exporta√ß√£o Excel na aba de estat√≠sticas
    const exportExcelFromStatsBtn = document.getElementById('exportMedicationsExcelFromStats');
    if (exportExcelFromStatsBtn) {
        exportExcelFromStatsBtn.addEventListener('click', function() {
            // Usar a mesma funcionalidade do bot√£o principal
            exportExcelBtn.click();
        });
    }

    // Bot√£o de limpar dados de prescri√ß√µes
    const clearDataBtn = document.getElementById('clearPrescriptionData');
    if (clearDataBtn) {
        clearDataBtn.addEventListener('click', function() {
            // Confirmar antes de limpar
            if (confirm('Tem certeza que deseja limpar todos os dados de prescri√ß√µes?\n\nEsta a√ß√£o ir√°:\n- Remover todo o hist√≥rico de prescri√ß√µes\n- Zerar as estat√≠sticas\n- Manter os medicamentos no banco\n\nEsta a√ß√£o n√£o pode ser desfeita!')) {
                clearPrescriptionData();
            }
        });
    }

    // Fun√ß√£o para carregar dados das estat√≠sticas
    function loadAnalyticsData() {
        loadTopMedications();
        loadGeneralStats();
        loadRecentPrescriptions();
    }

    // Carregar top medicamentos
    function loadTopMedications() {
        fetch('/api/analytics/top-medications')
            .then(response => response.json())
            .then(data => {
                const topMedicationsList = document.getElementById('topMedicationsList');
                if (data.length === 0) {
                    topMedicationsList.innerHTML = '<div class="list-group-item text-muted text-center">Nenhuma prescri√ß√£o registrada ainda</div>';
                    return;
                }

                let html = '';
                data.forEach(med => {
                    const badgeColor = med.type === 'Oral' ? 'bg-primary' : 'bg-success';
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">${med.position}. ${med.name}</div>
                                <small class="text-muted">${med.instructions}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge ${badgeColor} rounded-pill mb-1">${med.type}</span>
                                <br>
                                <span class="badge bg-warning text-dark">${med.prescriptions} prescri√ß√µes</span>
                            </div>
                        </div>
                    `;
                });
                topMedicationsList.innerHTML = html;
            })
            .catch(error => {
                console.error('Erro ao carregar top medicamentos:', error);
                document.getElementById('topMedicationsList').innerHTML = 
                    '<div class="list-group-item text-danger text-center">Erro ao carregar dados</div>';
            });
    }

    // Carregar estat√≠sticas gerais
    function loadGeneralStats() {
        fetch('/api/analytics/general-stats')
            .then(response => response.json())
            .then(data => {
                const generalStats = document.getElementById('generalStats');
                const mostPrescribed = data.most_prescribed ? 
                    `<strong>${data.most_prescribed.name}</strong> (${data.most_prescribed.count} vezes)` : 
                    'Nenhum ainda';

                generalStats.innerHTML = `
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="border rounded p-2">
                                <h4 class="text-primary mb-0">${data.total_medications}</h4>
                                <small class="text-muted">Total de Medicamentos</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="border rounded p-2">
                                <h4 class="text-success mb-0">${data.total_prescriptions}</h4>
                                <small class="text-muted">Total de Prescri√ß√µes</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="border rounded p-2">
                                <h4 class="text-info mb-0">${data.oral_medications}</h4>
                                <small class="text-muted">Medicamentos Orais</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="border rounded p-2">
                                <h4 class="text-warning mb-0">${data.topical_medications}</h4>
                                <small class="text-muted">Medicamentos T√≥picos</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted"><strong>Mais Prescrito:</strong></small><br>
                        <span class="small">${mostPrescribed}</span>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Erro ao carregar estat√≠sticas gerais:', error);
                document.getElementById('generalStats').innerHTML = 
                    '<div class="text-danger text-center">Erro ao carregar dados</div>';
            });
    }

    // Carregar prescri√ß√µes recentes
    function loadRecentPrescriptions() {
        fetch('/api/analytics/recent-prescriptions')
            .then(response => response.json())
            .then(data => {
                const recentPrescriptions = document.getElementById('recentPrescriptions');
                if (data.length === 0) {
                    recentPrescriptions.innerHTML = '<div class="text-muted text-center">Nenhuma prescri√ß√£o recente</div>';
                    return;
                }

                let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
                html += '<thead><tr><th>Medicamento</th><th>Tipo</th><th>Data/Hora</th></tr></thead><tbody>';
                
                data.forEach(prescription => {
                    const badgeColor = prescription.type === 'Oral' ? 'bg-primary' : 'bg-success';
                    html += `
                        <tr>
                            <td>${prescription.medication_name}</td>
                            <td><span class="badge ${badgeColor}">${prescription.type}</span></td>
                            <td><small>${prescription.prescribed_at}</small></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                recentPrescriptions.innerHTML = html;
            })
            .catch(error => {
                console.error('Erro ao carregar prescri√ß√µes recentes:', error);
                document.getElementById('recentPrescriptions').innerHTML = 
                    '<div class="text-danger text-center">Erro ao carregar dados</div>';
            });
    }

    // Fun√ß√£o para limpar dados de prescri√ß√µes
    function clearPrescriptionData() {
        const clearBtn = document.getElementById('clearPrescriptionData');
        const originalText = clearBtn.innerHTML;
        
        // Mostrar loading
        clearBtn.disabled = true;
        clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Limpando...';
        
        fetch('/api/clear-prescription-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Mostrar sucesso
            alert(`Dados limpos com sucesso!\n\n${data.message}`);
            
            // Recarregar dados das estat√≠sticas
            loadAnalyticsData();
        })
        .catch(error => {
            console.error('Erro ao limpar dados:', error);
            alert('Erro ao limpar dados: ' + error.message);
        })
        .finally(() => {
            // Restaurar bot√£o
            clearBtn.disabled = false;
            clearBtn.innerHTML = originalText;
        });
    }
});
