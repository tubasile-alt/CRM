{% extends "base.html" %}

{% block title %}Agenda - Clínica Basile{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
<style>
.daily-agenda-container {
    display: flex;
    gap: 0;
    margin-top: 20px;
    align-items: flex-start;
}

.daily-agenda-divider {
    width: 2px;
    background: linear-gradient(to bottom, #d9d9d9, #f0f0f0);
    box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
    margin: 0 15px;
    flex-shrink: 0;
}

.mini-calendar {
    width: 220px;
    flex-shrink: 0;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    height: fit-content;
}

.mini-calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.mini-calendar-header button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    padding: 0;
}

.mini-calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-bottom: 10px;
}

.mini-calendar-day {
    text-align: center;
    font-size: 12px;
    font-weight: 600;
    padding: 5px;
    color: #666;
}

.mini-calendar-date {
    text-align: center;
    padding: 8px;
    font-size: 12px;
    border-radius: 4px;
    cursor: pointer;
    background: #f8f9fa;
    transition: all 0.2s;
}

.mini-calendar-date:hover {
    background: #e9ecef;
}

.mini-calendar-date.selected {
    background: #0d6efd;
    color: white;
    font-weight: bold;
}

.mini-calendar-date.today {
    border: 2px solid #0d6efd;
}

.daily-schedule {
    background: white;
    border-radius: 8px;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    overflow: hidden;
    flex: 1;
    min-width: 0;
}

.schedule-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 2px solid #f0f0f0;
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    color: white;
}

.schedule-header h3 {
    margin: 0;
}

.schedule-nav {
    display: flex;
    gap: 10px;
}

.schedule-nav button {
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    cursor: pointer;
    transition: all 0.2s;
}

.schedule-nav button:hover {
    background: rgba(255, 255, 255, 0.3);
}

.view-toggle {
    display: flex;
    gap: 5px;
}

.view-toggle button {
    padding: 6px 12px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}

.view-toggle button.active {
    background: rgba(255, 255, 255, 0.4);
    border-color: white;
}

.hourly-grid {
    display: grid;
    grid-template-columns: 60px 1fr;
    gap: 0;
    height: 600px;
    overflow-y: auto;
}

.time-column {
    border-right: 2px solid #f0f0f0;
    background: #f8f9fa;
    padding: 0;
}

.hour-slot {
    height: 60px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #666;
    font-weight: 500;
}

.appointments-grid {
    position: relative;
    padding: 10px;
}

.appointment-block {
    position: absolute;
    left: 10px;
    right: 10px;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    overflow: hidden;
    border-left: 4px solid;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.appointment-block:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.appointment-time {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 3px;
}

.appointment-name {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 2px;
}

.appointment-type {
    font-size: 11px;
    opacity: 0.8;
}

/* Cores por tipo de consulta */
.appointment-particular {
    background: #fff3cd;
    border-left-color: #ffc107;
    color: #856404;
}

.appointment-retorno {
    background: #cfe2ff;
    border-left-color: #0d6efd;
    color: #084298;
}

.appointment-unimed {
    background: #d1e7dd;
    border-left-color: #198754;
    color: #0f5132;
}

.appointment-cortesia {
    background: #e2e3e5;
    border-left-color: #6c757d;
    color: #383d41;
}

.appointment-transplante {
    background: #f8d7da;
    border-left-color: #dc3545;
    color: #842029;
}

.status-confirmado {
    opacity: 1;
}

.status-agendado {
    opacity: 0.8;
}

.status-faltou {
    opacity: 0.5;
    text-decoration: line-through;
}

.status-atendido {
    opacity: 0.7;
    font-style: italic;
}

.empty-schedule {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 400px;
    color: #999;
    font-size: 16px;
}

@media (max-width: 1024px) {
    .daily-agenda-container {
        gap: 10px;
    }
    
    .mini-calendar {
        width: 180px;
    }
    
    .schedule-nav {
        flex-direction: column;
        gap: 8px;
    }
}

@media (max-width: 768px) {
    .daily-agenda-container {
        flex-direction: column;
        gap: 20px;
    }
    
    .mini-calendar {
        width: 100%;
        order: 2;
    }
    
    .daily-schedule {
        order: 1;
    }
    
    .daily-agenda-divider {
        display: none;
    }
    
    .schedule-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .schedule-nav {
        width: 100%;
    }
    
    .view-toggle {
        width: 100%;
    }
}

#calendar {
    display: none;
}
</style>
{% endblock %}

{% block content %}
<!-- TAB NAVIGATION FOR SECRETARY -->
{% if not current_user.is_doctor() %}
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="agenda-tab" data-bs-toggle="tab" data-bs-target="#agenda-content" type="button" role="tab">
            <i class="bi bi-calendar-event"></i> Agenda
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="checkout-tab" data-bs-toggle="tab" data-bs-target="#checkout-content" type="button" role="tab">
            <i class="bi bi-credit-card"></i> Checkout
        </button>
    </li>
</ul>
{% endif %}

<div class="tab-content">
    <div class="tab-pane fade show active" id="agenda-content" role="tabpanel">

<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-4">Agenda Médica</h2>
        <div id="waitingCounter" class="badge bg-warning text-dark mb-3" style="font-size: 1.1rem;">
            <i class="bi bi-people"></i> <span id="waitingCount">0</span> aguardando
        </div>
        {% if not current_user.is_doctor() %}
        <div class="btn-group w-100 mb-3" style="display: flex; flex-wrap: wrap;">
            <button class="btn btn-sm btn-outline-primary active" onclick="filterByDoctor('all')">Todos</button>
            {% for doctor in doctors %}
            <button class="btn btn-sm btn-outline-primary" onclick="filterByDoctor({{ doctor.id }})">{{ doctor.name }}</button>
            {% endfor %}
        </div>
        {% endif %}
        <div class="d-flex gap-2 flex-wrap mb-3">
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newAppointmentModal">
                <i class="bi bi-plus-circle"></i> <span class="d-none d-md-inline">Novo Agendamento</span><span class="d-md-none">Novo</span>
            </button>
            <div class="btn-group">
                <button class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-download"></i> <span class="d-none d-md-inline">Exportar</span>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportAgenda('pdf')"><i class="bi bi-file-pdf"></i> PDF</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportAgenda('excel')"><i class="bi bi-file-excel"></i> Excel</a></li>
                </ul>
            </div>
            <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                <i class="bi bi-printer"></i> <span class="d-none d-md-inline">Imprimir</span>
            </button>
        </div>
    </div>
</div>

<div class="daily-agenda-container">
    <!-- MINI CALENDAR -->
    <div class="mini-calendar" id="miniCalendar"></div>
    
    <!-- DIVIDER -->
    <div class="daily-agenda-divider"></div>
    
    <!-- DAILY SCHEDULE -->
    <div class="daily-schedule">
        <div class="schedule-header">
            <h3 id="scheduleDate"></h3>
            <div class="schedule-nav">
                <button onclick="previousDay()"><i class="bi bi-chevron-left"></i> Anterior</button>
                <button onclick="todayDay()">Hoje</button>
                <button onclick="nextDay()">Próximo <i class="bi bi-chevron-right"></i></button>
            </div>
            <div class="view-toggle">
                <button class="active" id="dayViewBtn" onclick="switchView('day')">Dia</button>
                <button id="monthViewBtn" onclick="switchView('month')">Mês</button>
            </div>
        </div>
        <div id="dayViewContent" class="hourly-grid">
            <div class="time-column" id="timeColumn"></div>
            <div class="appointments-grid" id="appointmentsGrid"></div>
        </div>
        <div id="monthViewContent" style="display: none;">
            <div id="calendar"></div>
        </div>
    </div>
</div>

    </div>

    <!-- CHECKOUT TAB FOR SECRETARY -->
    {% if not current_user.is_doctor() %}
    <div class="tab-pane fade" id="checkout-content" role="tabpanel">
        <div class="container-fluid mt-4">
            <h3 class="mb-4">
                <i class="bi bi-credit-card"></i> Checkout - Cobrança de Consultas
            </h3>
            
            <div id="checkoutList" class="row">
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="bi bi-hourglass-split"></i> Carregando checkouts pendentes...
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="newAppointmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Agendamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    {% if not current_user.is_doctor() %}
                    <div class="mb-3">
                        <label class="form-label">Médico</label>
                        <select class="form-select" id="appointmentDoctor" required>
                            {% for doctor in doctors %}
                            <option value="{{ doctor.id }}">{{ doctor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <label class="form-label">Nome do Paciente</label>
                        <input type="text" class="form-control" id="patientName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Telefone</label>
                        <input type="text" class="form-control" id="patientPhone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo de Paciente</label>
                        <select class="form-select" id="patientType">
                            <option value="particular" selected>Particular</option>
                            <option value="unimed">Unimed</option>
                            <option value="cortesia">Cortesia</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo de Consulta</label>
                        <select class="form-select" id="appointmentType">
                            <option value="Particular" selected>Particular - R$400</option>
                            <option value="Transplante Capilar">Transplante Capilar - R$400</option>
                            <option value="Retorno">Retorno - Sem Cobrança</option>
                            <option value="UNIMED">UNIMED - Sem Cobrança</option>
                            <option value="Cortesia">Cortesia - Sem Cobrança</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Data e Hora</label>
                        <input type="datetime-local" class="form-control" id="appointmentStart" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Duração (minutos)</label>
                        <select class="form-select" id="appointmentDuration">
                            <option value="30">30 minutos</option>
                            <option value="60" selected>60 minutos</option>
                            <option value="90">90 minutos</option>
                            <option value="120">120 minutos</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="appointmentStatus">
                            <option value="agendado">Agendado</option>
                            <option value="confirmado">Confirmado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" id="appointmentNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveAppointment()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="eventDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Agendamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventDetails">
            </div>
            <div class="modal-footer">
                {% if not current_user.is_doctor() %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                {% else %}
                <button type="button" class="btn btn-danger" onclick="deleteEvent()">Excluir</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="openPatientChart()">Abrir Prontuário</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
window.isSecretary = {% if not current_user.is_doctor() %}true{% else %}false{% endif %};
const doctors = {{ doctors | tojson }};
let currentDoctorFilter = null;
let currentEvent = null;
let calendar;
let selectedDate = new Date();
let currentView = 'day';
</script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/locales/pt-br.global.min.js"></script>
<script src="{{ url_for('static', filename='js/agenda.js') }}"></script>
<script src="{{ url_for('static', filename='js/checkout.js') }}"></script>
{% endblock %}
