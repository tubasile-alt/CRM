{% extends "base.html" %}

{% block title %}Dashboard - Clínica Basile{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Dashboard</h2>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-calendar-check text-secondary" style="font-size: 2rem;"></i>
                <h3 class="mt-2">{{ stats.agendados }}</h3>
                <p class="text-muted mb-0">Agendados Hoje</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-check-circle text-primary" style="font-size: 2rem;"></i>
                <h3 class="mt-2">{{ stats.confirmados }}</h3>
                <p class="text-muted mb-0">Confirmados</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-clipboard-check text-success" style="font-size: 2rem;"></i>
                <h3 class="mt-2">{{ stats.atendidos }}</h3>
                <p class="text-muted mb-0">Atendidos</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-x-circle text-danger" style="font-size: 2rem;"></i>
                <h3 class="mt-2">{{ stats.faltaram }}</h3>
                <p class="text-muted mb-0">Faltaram</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Gráficos de CRM</h5>
            </div>
            <div class="card-body">
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-bar-chart" style="font-size: 3rem;"></i>
                    <p class="mt-3">Gráficos de conversão de procedimentos e taxa de retorno serão exibidos aqui.</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-chat-dots"></i> Chat Rápido</h5>
            </div>
            <div class="card-body">
                <div id="quickChat" style="height: 300px; overflow-y: auto;" class="mb-3 border rounded p-2 bg-light">
                </div>
                <div class="input-group">
                    <input type="text" id="quickChatInput" class="form-control" placeholder="Digite sua mensagem...">
                    <button class="btn btn-primary" onclick="sendQuickMessage()">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let lastMessageId = 0;

function loadQuickMessages() {
    fetch('/api/chat/messages')
        .then(response => response.json())
        .then(messages => {
            const chatDiv = document.getElementById('quickChat');
            chatDiv.innerHTML = '';
            
            messages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'mb-2';
                msgDiv.innerHTML = `
                    <strong>${msg.sender}</strong> <small class="text-muted">${msg.timestamp}</small><br>
                    ${msg.message}
                `;
                chatDiv.appendChild(msgDiv);
                lastMessageId = Math.max(lastMessageId, msg.id);
            });
            
            chatDiv.scrollTop = chatDiv.scrollHeight;
        });
}

function sendQuickMessage() {
    const input = document.getElementById('quickChatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    fetch('/api/chat/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(() => {
        input.value = '';
        loadQuickMessages();
    });
}

document.getElementById('quickChatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendQuickMessage();
    }
});

loadQuickMessages();
setInterval(loadQuickMessages, 5000);
</script>
{% endblock %}
