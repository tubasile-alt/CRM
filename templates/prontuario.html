{% extends "base.html" %}

{% block title %}Prontu√°rio - {{ patient.name }}{% endblock %}

{% block content %}
<script>
function calculateAge(birthDate) {
    if (!birthDate) return null;
    const today = new Date();
    const birth = new Date(birthDate + 'T00:00:00');
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    return age >= 0 ? age : null;
}

const patientBirth = '{{ patient.birth_date }}';
const age = calculateAge(patientBirth);

function openAttentionModal() {
    document.getElementById('attentionText').value = document.getElementById('attentionContent').textContent;
    new bootstrap.Modal(document.getElementById('attentionModal')).show();
}

function saveAttentionNote() {
    const content = document.getElementById('attentionText').value;
    fetch(`/api/patient/{{ patient.id }}/attention-note`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({attention_note: content})
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            document.getElementById('attentionContent').textContent = content;
            document.getElementById('attentionBadge').style.display = content ? 'inline' : 'none';
            bootstrap.Modal.getInstance(document.getElementById('attentionModal')).hide();
            showAlert('Anota√ß√£o salva!', 'success');
        } else {
            showAlert(result.error || 'Erro ao salvar', 'danger');
        }
    })
    .catch(err => {
        console.error('Erro:', err);
        showAlert('Erro ao salvar anota√ß√£o', 'danger');
    });
}

function openEditPatientModal() {
    new bootstrap.Modal(document.getElementById('editPatientModal')).show();
}

function savePatientData() {
    const data = {
        name: document.getElementById('editPatientName').value,
        email: document.getElementById('editPatientEmail').value,
        phone: document.getElementById('editPatientPhone').value,
        birth_date: document.getElementById('editPatientBirthDate').value,
        cpf: document.getElementById('editPatientCpf').value,
        address: document.getElementById('editPatientAddress').value,
        city: document.getElementById('editPatientCity').value,
        state: document.getElementById('editPatientState').value,
        zip_code: document.getElementById('editPatientZip').value,
        mother_name: document.getElementById('editPatientMotherName').value,
        occupation: document.getElementById('editPatientOccupation').value,
        indication_source: document.getElementById('editPatientIndication').value,
        patient_type: document.getElementById('editPatientType').value
    };
    
    if (!data.name) {
        showAlert('Nome do paciente √© obrigat√≥rio', 'warning');
        return;
    }
    
    fetch(`/api/patient/{{ patient.id }}/update`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('editPatientModal')).hide();
            showAlert('Dados do paciente atualizados!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.error || 'Erro ao atualizar', 'danger');
        }
    })
    .catch(err => {
        console.error('Erro:', err);
        showAlert('Erro ao salvar dados', 'danger');
    });
}

// Fun√ß√µes de foto do paciente
function uploadPatientPhoto(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    if (file.size > 5 * 1024 * 1024) {
        showAlert('Arquivo muito grande. M√°ximo 5MB.', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('photo', file);
    
    fetch('/api/patient/{{ patient.id }}/photo', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert('Foto salva com sucesso!', 'success');
            const wrapper = document.getElementById('patientPhotoWrapper');
            wrapper.innerHTML = `<img src="${result.photo_url}?t=${Date.now()}" alt="Foto do paciente" style="width: 100%; height: 100%; object-fit: cover;" id="patientPhoto">`;
            location.reload();
        } else {
            showAlert(result.error || 'Erro ao salvar foto', 'danger');
        }
    })
    .catch(err => {
        console.error('Erro:', err);
        showAlert('Erro ao enviar foto', 'danger');
    });
}

function deletePatientPhoto() {
    if (!confirm('Remover foto do paciente?')) return;
    
    fetch('/api/patient/{{ patient.id }}/photo', {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert('Foto removida!', 'success');
            location.reload();
        } else {
            showAlert(result.error || 'Erro ao remover foto', 'danger');
        }
    })
    .catch(err => {
        console.error('Erro:', err);
        showAlert('Erro ao remover foto', 'danger');
    });
}
</script>

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <!-- Foto 3x4 do Paciente -->
                <div class="patient-photo-container" style="position: relative;">
                    <div id="patientPhotoWrapper" class="patient-photo" style="width: 80px; height: 100px; border: 2px dashed #ccc; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #f8f9fa; cursor: pointer;" onclick="document.getElementById('photoInput').click()">
                        {% if patient.photo_url %}
                        <img src="{{ patient.photo_url }}" alt="Foto do paciente" style="width: 100%; height: 100%; object-fit: cover;" id="patientPhoto">
                        {% else %}
                        <div style="text-align: center; color: #999;" id="photoPlaceholder">
                            <i class="bi bi-camera" style="font-size: 24px;"></i>
                            <div style="font-size: 10px;">Foto 3x4</div>
                        </div>
                        {% endif %}
                    </div>
                    <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="uploadPatientPhoto(this)">
                    {% if patient.photo_url %}
                    <button class="btn btn-sm btn-danger" style="position: absolute; top: -5px; right: -5px; padding: 2px 6px; border-radius: 50%;" onclick="event.stopPropagation(); deletePatientPhoto()">
                        <i class="bi bi-x"></i>
                    </button>
                    {% endif %}
                </div>
                
                <div>
                    <h2>
                        Prontu√°rio: {{ patient.name }}
                        {% if age %}
                        <small class="text-muted">({{ age }} anos)</small>
                        {% endif %}
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="openEditPatientModal()">
                            <i class="bi bi-pencil"></i> Editar Cadastro
                        </button>
                    </h2>
                    <p class="text-muted mb-0">
                        {% if patient.phone %}<i class="bi bi-telephone"></i> {{ patient.phone }} | {% endif %}
                        {% if patient.email %}<i class="bi bi-envelope"></i> {{ patient.email }}{% endif %}
                        <button class="btn btn-sm btn-warning ms-2" onclick="openAttentionModal()">
                            <i class="bi bi-exclamation-circle"></i> Aten√ß√£o
                        </button>
                        <span id="attentionBadge" class="badge bg-danger ms-2" style="display: {% if patient.attention_note %}inline{% else %}none{% endif %};">
                            <i class="bi bi-exclamation-triangle"></i> Anota√ß√£o
                        </span>
                    </p>
                </div>
            </div>
            <button class="btn btn-outline-secondary" onclick="history.back()">
                <i class="bi bi-arrow-left"></i> Voltar
            </button>
        </div>
    </div>
</div>

<!-- Modal de Aten√ß√£o -->
<div class="modal fade" id="attentionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-exclamation-circle"></i> Anota√ß√£o de Aten√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">Informa√ß√µes importantes sobre o paciente:</label>
                <textarea class="form-control" id="attentionText" rows="6" placeholder="Ex: Al√©rgico a penicilina, tem medo de agulhas, etc..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="saveAttentionNote()">
                    <i class="bi bi-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<div id="attentionContent" style="display:none;">{{ patient.attention_note or '' }}</div>

<!-- Modal de Edi√ß√£o do Paciente -->
<div class="modal fade" id="editPatientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Dados do Paciente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPatientForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="editPatientName" value="{{ patient.name }}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="editPatientEmail" value="{{ patient.email or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Telefone</label>
                            <input type="text" class="form-control" id="editPatientPhone" value="{{ patient.phone or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="editPatientBirthDate" value="{{ patient.birth_date.strftime('%Y-%m-%d') if patient.birth_date else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-control" id="editPatientCpf" value="{{ patient.cpf or '' }}">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Endere√ßo</label>
                            <input type="text" class="form-control" id="editPatientAddress" value="{{ patient.address or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="editPatientCity" value="{{ patient.city or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Estado</label>
                            <input type="text" class="form-control" id="editPatientState" value="{{ patient.state or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-control" id="editPatientZip" value="{{ patient.zip_code or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nome da M√£e</label>
                            <input type="text" class="form-control" id="editPatientMotherName" value="{{ patient.mother_name or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ocupa√ß√£o</label>
                            <input type="text" class="form-control" id="editPatientOccupation" value="{{ patient.occupation or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fonte de Indica√ß√£o</label>
                            <input type="text" class="form-control" id="editPatientIndication" value="{{ patient.indication_source or '' }}" placeholder="Ex: Google, Indica√ß√£o de amigo...">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Paciente</label>
                            <select class="form-select" id="editPatientType">
                                <option value="particular" {% if patient.patient_type == 'particular' %}selected{% endif %}>Particular</option>
                                <option value="UNIMED" {% if patient.patient_type == 'UNIMED' %}selected{% endif %}>UNIMED</option>
                                <option value="convenio" {% if patient.patient_type == 'convenio' %}selected{% endif %}>Conv√™nio</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="savePatientData()">
                    <i class="bi bi-save"></i> Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>
</div>

{% if current_user.is_doctor() %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6>Tags do Paciente</h6>
                <div id="patientTags">
                    {% for tag in tags %}
                    <div class="form-check form-check-inline">
                        <input class="form-check-input tag-checkbox" type="checkbox" 
                               value="{{ tag.id }}" id="tag{{ tag.id }}"
                               {% if tag.id in patient_tags %}checked{% endif %}>
                        <label class="form-check-label" for="tag{{ tag.id }}">
                            <span class="badge" style="background-color: {{ tag.color }}">{{ tag.name }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <button class="btn btn-sm btn-primary mt-2" onclick="savePatientTags()">
                    <i class="bi bi-save"></i> Salvar Tags
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if current_user.is_doctor() %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="mb-3"><i class="bi bi-folder-plus"></i> Categoria do Atendimento</h6>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="category" id="catPatologia" value="patologia" checked>
                    <label class="btn btn-outline-primary" for="catPatologia">
                        <i class="bi bi-capsule"></i> Patologia
                    </label>

                    <input type="radio" class="btn-check" name="category" id="catCosm" value="cosmiatria">
                    <label class="btn btn-outline-success" for="catCosm">
                        <i class="bi bi-stars"></i> Cosmiatria
                    </label>

                    <input type="radio" class="btn-check" name="category" id="catTransp" value="transplante_capilar">
                    <label class="btn btn-outline-info" for="catTransp">
                        <i class="bi bi-person-badge"></i> Transplante Capilar
                    </label>
                </div>
                <small class="text-muted d-block mt-2">Selecione a categoria para adaptar os campos do prontu√°rio</small>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#queixa">Queixa Principal</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#anamnese">Anamnese / Exame F√≠sico</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#diagnostico">Diagn√≥stico</a>
                    </li>
                    <li class="nav-item" id="tabPlanejamento" style="display:none;">
                        <a class="nav-link" data-bs-toggle="tab" href="#planejamento">Planejamento</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#conduta">Conduta</a>
                    </li>
                    <li class="nav-item" id="tabTransplante" style="display:none;">
                        <a class="nav-link" data-bs-toggle="tab" href="#transplante">Planejamento Cir√∫rgico</a>
                    </li>
                    <li class="nav-item" id="tabSurgery" style="display:none;">
                        <a class="nav-link" data-bs-toggle="tab" href="#surgery"><i class="bi bi-heart-pulse"></i> Cirurgias</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="mb-3 d-flex align-items-center">
                    {% if current_user.is_doctor() %}
                    <button class="btn btn-sm btn-success" id="startTimer" onclick="startConsultation()">
                        <i class="bi bi-play-circle"></i> Iniciar Atendimento
                    </button>
                    <button class="btn btn-sm btn-primary ms-2" id="finishTimer" onclick="finishConsultation()">
                        <i class="bi bi-check-all"></i> Finalizar Atendimento
                    </button>
                    {% endif %}
                    <span id="timerDisplay" class="ms-3 fw-bold fs-5 text-primary">00:00</span>
                </div>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="queixa">
                        <div class="mb-3">
                            <label class="form-label">Queixa Principal</label>
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-sm btn-outline-primary float-end" onclick="startDictation('queixaText')">
                                <i class="bi bi-mic"></i> Ditado
                            </button>
                            {% endif %}
                        </div>
                        <textarea class="form-control" id="queixaText" rows="8" {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                    </div>

                    <div class="tab-pane fade" id="anamnese">
                        <div class="mb-3">
                            <label class="form-label">Anamnese</label>
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-sm btn-outline-primary float-end" onclick="startDictation('anamneseText')">
                                <i class="bi bi-mic"></i> Ditado
                            </button>
                            {% endif %}
                        </div>
                        <textarea class="form-control" id="anamneseText" rows="8" {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                        
                        <div class="mt-3" id="indicatedProceduresSection" style="display:none;">
                            <h6>Procedimentos Indicados</h6>
                            {% for proc in procedures %}
                            <div class="form-check">
                                <input class="form-check-input indicated-proc" type="checkbox" 
                                       value="{{ proc.id }}" id="indicated{{ proc.id }}" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="indicated{{ proc.id }}">
                                    {{ proc.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="diagnostico">
                        <div class="mb-3">
                            <label class="form-label">Diagn√≥stico</label>
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-sm btn-outline-primary float-end" onclick="startDictation('diagnosticoText')">
                                <i class="bi bi-mic"></i> Ditado
                            </button>
                            {% endif %}
                        </div>
                        <textarea class="form-control" id="diagnosticoText" rows="8" {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                    </div>

                    <div class="tab-pane fade" id="conduta">
                        <div class="mb-3">
                            <label class="form-label">Conduta</label>
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-sm btn-outline-primary float-end ms-2" onclick="startDictation('condutaText')">
                                <i class="bi bi-mic"></i> Ditado
                            </button>
                            <button class="btn btn-sm btn-primary float-end" onclick="abrirDermaScribe()">
                                <i class="bi bi-prescription2"></i> Prescrever
                            </button>
                            {% endif %}
                        </div>
                        <textarea class="form-control" id="condutaText" rows="8" {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                        
                        <div class="mt-3" id="prescriptionHistorySection">
                            <h6><i class="bi bi-file-medical"></i> Receitas Emitidas</h6>
                            <div id="prescriptionHistoryList">
                                <small class="text-muted">Nenhuma receita emitida nesta consulta</small>
                            </div>
                        </div>
                        
                        <!-- Se√ß√£o para Cosmiatria: Procedimentos Planejados com Or√ßamento e Status -->
                        <div class="mt-4" id="cosmeticConductSection" style="display:none;">
                            <h6><i class="bi bi-check2-square"></i> Procedimentos Planejados - Execu√ß√£o</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Procedimento</th>
                                            <th style="width: 150px;">Or√ßamento (R$)</th>
                                            <th style="width: 140px;">Data Realiza√ß√£o</th>
                                            <th style="width: 120px;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cosmeticConductBody">
                                        <!-- Linhas preenchidas via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Procedimentos Realizados (apenas para Cosmiatria, n√£o para Patologia) -->
                        <div class="mt-3" id="conductProceduresSection" style="display:none;">
                            <h6>Procedimentos Realizados</h6>
                            {% for proc in procedures %}
                            <div class="form-check">
                                <input class="form-check-input performed-proc" type="checkbox" 
                                       value="{{ proc.id }}" id="performed{{ proc.id }}" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="performed{{ proc.id }}">
                                    {{ proc.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        
                            <div id="evolutionHistorySection" class="p-3 mb-3 bg-light rounded border border-success" style="min-height: 100px;">
                                <h6 class="text-success mb-3 fw-bold">
                                    <i class="bi bi-stickies-fill"></i> EVOLU√á√ïES DESTE ATENDIMENTO (19/02)
                                </h6>
                                <div id="currentConsultationEvolutions" class="mt-2 bg-white p-3 rounded border shadow-sm" style="display: block !important; visibility: visible !important;">
                                    <p class="text-muted small mb-0">Carregando hist√≥rico de evolu√ß√µes salvos hoje...</p>
                                </div>
                            </div>

                            <div class="mt-4 pt-3 border-top">
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-success btn-lg" onclick="finalizarAtendimento()">
                                <i class="bi bi-check-circle-fill"></i> Finalizar Atendimento
                            </button>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle"></i> Todos os dados ser√£o salvos automaticamente
                            </small>
                            {% endif %}
                        </div>
                    </div>

                    <!-- ABA PLANEJAMENTO CL√çNICO (COSMIATRIA) -->
                    <div class="tab-pane fade" id="planejamento">
                        <h6 class="mb-3"><i class="bi bi-calendar-check"></i> Planejamento Cl√≠nico Cosm√©tico</h6>
                        
                        <div class="table-responsive">
                            <table class="table table-sm" id="cosmeticPlanTable">
                                <thead>
                                    <tr>
                                        <th>Procedimento</th>
                                        <th style="width: 150px;">Valor (R$)</th>
                                        <th style="width: 120px;">Retorno (meses)</th>
                                        <th>Observa√ß√µes</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="cosmeticPlanBody">
                                    <!-- Linhas ser√£o adicionadas via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        {% if current_user.is_doctor() %}
                        <div class="mb-3">
                            <div class="row g-2 mb-2">
                                <div class="col-md-5">
                                    <select class="form-select" id="newProcedureName">
                                        <option value="">Selecione o procedimento...</option>
                                        <option value="Botox">Botox (6 meses)</option>
                                        <option value="Preenchimento">Preenchimento (12 meses)</option>
                                        <option value="MD Codes">MD Codes (12 meses)</option>
                                        <option value="Pearl Fracionado">Pearl Fracionado (6 meses)</option>
                                        <option value="LIMELIGHT FACE">LIMELIGHT FACE</option>
                                        <option value="PROTOCOLO M√ÉOS(LIMELIGHT + PEARL)">PROTOCOLO M√ÉOS(LIMELIGHT + PEARL)</option>
                                        <option value="PDRN">PDRN</option>
                                        <option value="LASER CICATRIZ">LASER CICATRIZ</option>
                                        <option value="PEQUENA CIRURGIA">PEQUENA CIRURGIA</option>
                                        <option value="Ulthera">Ulthera (18 meses)</option>
                                        <option value="Morpheus">Morpheus (12 meses)</option>
                                        <option value="Sculptra">Sculptra (18 meses)</option>
                                        <option value="Radiesse">Radiesse (12 meses)</option>
                                        <option value="Harmonyca">Harmonyca (12 meses)</option>
                                        <option value="Profhilo">Profhilo (6 meses)</option>
                                        <option value="Emsculpt Neo">Emsculpt Neo (12 meses)</option>
                                        <option value="Exilis">Exilis (6 meses)</option>
                                        <option value="Emtone">Emtone (6 meses)</option>
                                        <option value="Peeling">Peeling (3 meses)</option>
                                        <option value="Outros">Outros</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control" id="newProcedureValue" placeholder="Valor (R$)" step="any" min="0">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" id="newProcedureMonths" placeholder="Meses" value="6">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-success w-100" onclick="addCosmeticProcedure()">
                                        <i class="bi bi-plus-circle"></i> Adicionar
                                    </button>
                                </div>
                            </div>
                            <textarea class="form-control form-control-sm" id="newProcedureObservations" placeholder="Observa√ß√µes sobre o procedimento (ex: orienta√ß√µes especiais, pontos importantes, etc)" rows="2"></textarea>
                        </div>
                        {% endif %}
                        
                        <div class="alert alert-info">
                            <strong>Total Estimado:</strong> R$ <span id="cosmeticTotal">0,00</span>
                        </div>
                        
                        {% if current_user.is_doctor() %}
                        <button class="btn btn-success" onclick="generateBudget()">
                            <i class="bi bi-file-pdf"></i> Gerar Or√ßamento PDF
                        </button>
                        {% endif %}
                        <div class="alert alert-warning mt-2">
                            <small><i class="bi bi-info-circle"></i> Os procedimentos ser√£o salvos automaticamente ao clicar em "Finalizar Atendimento" na aba Conduta.</small>
                        </div>
                    </div>

                    <!-- ABA CIRURGIAS (TRANSPLANTE CAPILAR) -->
                    <div class="tab-pane fade" id="surgery">
                        <h6 class="mb-3"><i class="bi bi-heart-pulse"></i> Registro de Cirurgias</h6>
                        
                        {% if current_user.is_doctor() %}
                        <div class="card mb-4 p-3 bg-light">
                            <h6 class="mb-3">Registrar Nova Cirurgia</h6>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Data da Cirurgia</strong></label>
                                    <input type="date" id="surgeryDate" class="form-control">
                                    <small class="text-muted">Data atual ou retroativa</small>
                                </div>
                            </div>
                            <div class="row g-2 mt-3">
                                <div class="col-12">
                                    <label class="form-label"><strong>Tipo de Cirurgia</strong></label>
                                    <div class="d-flex flex-wrap gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="surgeryTypeCapilar" value="Capilar">
                                            <label class="form-check-label" for="surgeryTypeCapilar">So Capilar</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="surgeryTypeBodyHair" value="Body Hair">
                                            <label class="form-check-label" for="surgeryTypeBodyHair">Body Hair</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="surgeryTypeSobrancelhas" value="Sobrancelhas">
                                            <label class="form-check-label" for="surgeryTypeSobrancelhas">Sobrancelhas</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="surgeryTypeBarba" value="Barba">
                                            <label class="form-check-label" for="surgeryTypeBarba">Barba</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="surgeryTypeRetoque" value="Retoque">
                                            <label class="form-check-label" for="surgeryTypeRetoque">Retoque</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label"><strong>Dados Cir√∫rgicos</strong></label>
                                    <textarea id="surgicalData" class="form-control" rows="3" placeholder="T√©cnica, n√∫mero de enxertos, √°reas operadas, detalhes do procedimento..."></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label"><strong>Observa√ß√µes</strong></label>
                                    <textarea id="surgeryObservations" class="form-control" rows="3" placeholder="Intercorr√™ncias, pontos importantes, cuidados p√≥s-operat√≥rios..."></textarea>
                                </div>
                            </div>
                            <button class="btn btn-success mt-3" onclick="saveSurgery()">
                                <i class="bi bi-plus-circle"></i> Registrar Cirurgia
                            </button>
                        </div>
                        {% endif %}
                        
                        <h6 class="mb-2"><strong>Hist√≥rico de Cirurgias</strong></h6>
                        <div id="surgeriesList" class="mb-3">
                            <p class="text-muted text-center">Carregando cirurgias...</p>
                        </div>
                    </div>

                    <!-- ABA PLANEJAMENTO CIR√öRGICO (TRANSPLANTE CAPILAR) -->
                    <div class="tab-pane fade" id="transplante">
                        <h6 class="mb-3"><i class="bi bi-scissors"></i> Planejamento Cir√∫rgico</h6>
                        
                        <!-- Indica√ß√£o de Transplante -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Indica√ß√£o de Transplante Capilar</strong></label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="transplantIndication" id="indicationNo" value="nao" {% if not patient.has_transplant_indication %}checked{% endif %} onchange="saveTransplantIndication()" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="btn btn-outline-danger" for="indicationNo">N√£o tem indica√ß√£o</label>
                                
                                <input type="radio" class="btn-check" name="transplantIndication" id="indicationYes" value="sim" {% if patient.has_transplant_indication %}checked{% endif %} onchange="saveTransplantIndication()" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="btn btn-outline-success" for="indicationYes">Sim, tem indica√ß√£o</label>
                            </div>
                        </div>
                        
                        <!-- Hist√≥rico de Transplante -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Hist√≥rico de Transplante Capilar</strong></label>
                            <div class="mb-2">
                                <label class="form-label">J√° realizou transplante capilar anteriormente?</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="previousTransplant" id="previousNo" value="nao" checked onchange="toggleTransplantLocation()" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    <label class="btn btn-outline-secondary" for="previousNo">N√£o</label>
                                    
                                    <input type="radio" class="btn-check" name="previousTransplant" id="previousYes" value="sim" onchange="toggleTransplantLocation()" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    <label class="btn btn-outline-primary" for="previousYes">Sim</label>
                                </div>
                            </div>
                            <div id="transplantLocationSection" style="display:none;" class="mt-2">
                                <label class="form-label">Onde foi realizado?</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="transplantLocation" id="locationICB" value="ICB" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    <label class="btn btn-outline-info" for="locationICB">ICB</label>
                                    
                                    <input type="radio" class="btn-check" name="transplantLocation" id="locationOther" value="outro_servico" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    <label class="btn btn-outline-warning" for="locationOther">Outro Servi√ßo</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Classifica√ß√£o de Norwood -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Classifica√ß√£o de Norwood (N√≠vel de Calv√≠cie)</strong></label>
                            <div class="row g-2">
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="1">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('1'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">üë§</div>
                                        <small><strong>Norwood 1</strong></small>
                                        <input type="radio" name="norwood" value="1" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="2">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('2'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">üë§</div>
                                        <small><strong>Norwood 2</strong></small>
                                        <input type="radio" name="norwood" value="2" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="3">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('3'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">üë§</div>
                                        <small><strong>Norwood 3</strong></small>
                                        <input type="radio" name="norwood" value="3" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="4">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('4'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">üë§</div>
                                        <small><strong>Norwood 4</strong></small>
                                        <input type="radio" name="norwood" value="4" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="5">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('5'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">üë§</div>
                                        <small><strong>Norwood 5</strong></small>
                                        <input type="radio" name="norwood" value="5" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="6">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('6'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">üë§</div>
                                        <small><strong>Norwood 6</strong></small>
                                        <input type="radio" name="norwood" value="6" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upload de Imagens -->
                        {% if current_user.is_doctor() %}
                        <div class="mb-3">
                            <label class="form-label"><strong>Anexos da Consulta</strong></label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label small">Foto da Consulta <span class="text-danger">*</span></label>
                                    <input type="file" class="form-control form-control-sm" id="consultationPhoto" accept="image/*">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Planejamento Cir√∫rgico</label>
                                    <input type="file" class="form-control form-control-sm" id="surgicalPlanImage" accept="image/*">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Simula√ß√£o Visual</label>
                                    <input type="file" class="form-control form-control-sm" id="simulationImage" accept="image/*">
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Tipo de Caso -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Tipo de Caso</strong></label>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="caseType" id="casePrimary" value="primaria" checked {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="btn btn-outline-primary" for="casePrimary">Cirurgia Prim√°ria</label>
                                
                                <input type="radio" class="btn-check" name="caseType" id="caseSecondary" value="secundaria" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="btn btn-outline-warning" for="caseSecondary">Cirurgia Secund√°ria</label>
                            </div>
                        </div>

                        <!-- N√∫mero de Cirurgias e √Åreas -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Planejamento de Cirurgias e √Åreas</strong></label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="singleSurgery" value="1" checked {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="singleSurgery">Uma √∫nica cirurgia</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="twoSurgeries" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="twoSurgeries">Duas cirurgias planejadas</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bodyHair" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="bodyHair">Body hair transplant</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="eyebrowTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="eyebrowTransplant">Transplante de sobrancelha</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="beardTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="beardTransplant">Transplante de barba</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="feminineHairTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="feminineHairTransplant">Transplante capilar feminino</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Indica√ß√µes Cir√∫rgicas -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Indica√ß√µes Cir√∫rgicas</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="frontalTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="frontalTransplant">Transplante capilar frontal</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="crownTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="crownTransplant">Transplante capilar em coroa</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="completeTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="completeTransplant">Transplante capilar completo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="completeBodyHair" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="completeBodyHair">Transplante capilar completo com body hair</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="densePacking" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="densePacking">Dense Packing</label>
                            </div>
                        </div>

                        <!-- Planejamento Cir√∫rgico -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Planejamento Cir√∫rgico</strong></label>
                            <textarea class="form-control" id="surgicalPlanning" rows="6" 
                                placeholder="Descreva: linha frontal, n√∫mero estimado de UF, estrat√©gia de extra√ß√£o, distribui√ß√£o de √°reas receptoras, densidade planejada..." {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                        </div>

                        <!-- SUB-CATEGORIA: CIRURGIA -->
                        <div class="card mt-4 border-danger">
                            <div class="card-header bg-danger text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-scissors"></i> Cirurgias Realizadas</h6>
                                    {% if current_user.is_doctor() %}
                                    <button class="btn btn-sm btn-light" onclick="openSurgeryModal()"><i class="bi bi-plus"></i> Adicionar Cirurgia</button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="surgeriesList" class="accordion">
                                    <!-- Cirurgias ser√£o carregadas aqui via JavaScript -->
                                </div>
                                <p class="text-muted text-center mt-3" id="noSurgeriesMsg">Nenhuma cirurgia registrada</p>
                            </div>
                        </div>

                        <!-- MODAL CIRURGIA -->
                        <div class="modal fade" id="surgeryModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header bg-danger text-white">
                                        <h5 class="modal-title"><i class="bi bi-scissors"></i> Registrar Cirurgia</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Data da Cirurgia *</strong></label>
                                            <input type="date" class="form-control" id="surgeryModalDate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Planejamento Cir√∫rgico</strong></label>
                                            <textarea class="form-control" id="surgeryModalSurgicalPlanning" rows="5" placeholder="Descreva o planejamento detalhado da cirurgia..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Intercorr√™ncias</strong></label>
                                            <textarea class="form-control" id="surgeryModalComplications" rows="4" placeholder="Relate qualquer complica√ß√£o ou evento inusitado durante a cirurgia..."></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="button" class="btn btn-danger" onclick="saveSurgery()"><i class="bi bi-check"></i> Salvar Cirurgia</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3">
                            <small><i class="bi bi-info-circle"></i> O planejamento cir√∫rgico ser√° salvo automaticamente ao clicar em "Finalizar Atendimento" na aba Conduta.</small>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- HIST√ìRICO DE CONSULTAS - VIS√çVEL PARA M√âDICOS E SECRET√ÅRIAS -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> Prontu√°rio em Linha do Tempo
                    </h5>
                    {% if current_user.is_doctor() %}
                    <button class="btn btn-success btn-sm" onclick="finalizarAtendimento()">
                        <i class="bi bi-check-circle-fill"></i> Finalizar Atendimento Atual
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="card-body timeline-wrapper">
                <div class="timeline-column" id="consultationTimelineList">
                    <p class="text-muted mb-0">Carregando linha do tempo...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- HIST√ìRICO DE CIRURGIAS -->
<div class="row mt-3">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-heart-pulse"></i> Hist√≥rico de Cirurgias
                </h5>
            </div>
            <div class="card-body" id="surgeriesContainer" style="max-height: 600px; overflow-y: auto;">
                <!-- Cirurgias ser√£o carregadas aqui via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Modal de Evolu√ß√£o -->
<div class="modal fade" id="evolutionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Nova Evolu√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label"><strong>Consulta do Hist√≥rico *</strong></label>
                    <!-- Dropdown para sele√ß√£o (mostrado quando nenhuma consulta pr√©-selecionada) -->
                    <select id="evolutionConsultation" class="form-select" required>
                        <option value="">-- Selecione uma consulta --</option>
                    </select>
                    <!-- Display da consulta selecionada (oculto por padr√£o) -->
                    <div id="evolutionConsultationDisplay" style="display: none; padding: 8px 12px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
                        <strong id="evolutionConsultationName"></strong>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Data da Evolu√ß√£o</strong></label>
                    <input type="datetime-local" id="evolutionDate" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Descri√ß√£o</strong></label>
                    <textarea id="evolutionContent" class="form-control" rows="5" placeholder="Descreva a evolu√ß√£o do paciente desde a √∫ltima consulta..."></textarea>
                </div>
                <div id="surgicalEvolutionFindings" class="mb-3" style="display:none;">
                  <label class="form-label"><strong>Achados Cir√∫rgicos (marque quantos quiser)</strong></label>

                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfNecrose" value="necrose">
                        <label class="form-check-label" for="sfNecrose">Necrose</label>
                      </div>

                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfCrostas" value="crostas">
                        <label class="form-check-label" for="sfCrostas">Crostas</label>
                      </div>

                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfInfeccao" value="infeccao_secundaria">
                        <label class="form-check-label" for="sfInfeccao">Infec√ß√£o secund√°ria</label>
                      </div>

                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfFolAguda" value="foliculite_aguda">
                        <label class="form-check-label" for="sfFolAguda">Foliculite aguda</label>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfFolCron" value="foliculite_cronica">
                        <label class="form-check-label" for="sfFolCron">Foliculite cr√¥nica</label>
                      </div>

                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfRarefacao" value="rarefacao_capilar">
                        <label class="form-check-label" for="sfRarefacao">Rarefa√ß√£o capilar</label>
                      </div>

                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfFalha" value="falha_localizada">
                        <label class="form-check-label" for="sfFalha">Falha localizada</label>
                      </div>
                    </div>
                  </div>

                  <small class="text-muted d-block mt-2">
                    * Esses achados ser√£o salvos junto da evolu√ß√£o (padronizado) e podem coexistir.
                  </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveEvolution()"><i class="bi bi-save"></i> Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edi√ß√£o de Data da Consulta -->
<div class="modal fade" id="editConsultationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Consulta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <input type="hidden" id="editConsultationId">
                
                <div class="mb-3">
                    <label class="form-label"><strong>Data e Hora</strong></label>
                    <input type="datetime-local" id="editConsultationDateTime" class="form-control">
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <label class="form-label"><strong>Queixa Principal</strong></label>
                    <textarea id="editQueixa" class="form-control" rows="2" placeholder="Ex: Dor na cabe√ßa..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><strong>Anamnese / Exame F√≠sico</strong></label>
                    <textarea id="editAnamnese" class="form-control" rows="3" placeholder="Ex: Paciente refere..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><strong>Diagn√≥stico</strong></label>
                    <textarea id="editDiagnostico" class="form-control" rows="3" placeholder="Ex: Diagn√≥stico de..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><strong>Conduta</strong></label>
                    <textarea id="editConduta" class="form-control" rows="3" placeholder="Ex: Prescrever..."></textarea>
                </div>
                
                <input type="hidden" id="editQueixaId">
                <input type="hidden" id="editAnamneseId">
                <input type="hidden" id="editDiagnosticoId">
                <input type="hidden" id="editCondutaId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="saveConsultationEdit()">
                    <i class="bi bi-save"></i> Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/**
 * PATCH DEFINITIVO - Evolu√ß√£o Cir√∫rgica com checkboxes (somente em cirurgia)
 *
 * Estrat√©gia (sem mexer no backend):
 * - Detecta contexto "cirurgia" por:
 *   (A) texto do select #evolutionConsultation contendo "cirurgia"
 *   (B) texto do display verde #evolutionConsultationName contendo "cirurgia"
 * - Quando for cirurgia: mostra checkboxes
 * - Quando n√£o for: esconde e limpa
 * - No saveEvolution(): injeta um bloco padronizado dentro do texto da evolu√ß√£o
 *   para garantir persist√™ncia mesmo se o backend ainda salva s√≥ "content".
 */

(function() {
  function $(id){ return document.getElementById(id); }

  function isSurgeryContext() {
    // 1) Se o modal tiver dataset.context expl√≠cito, respeita
    const modal = $('evolutionModal');
    const ctx = modal?.dataset?.context;
    if (ctx === 'surgery') return true;
    if (ctx === 'consultation') return false;

    // 2) Tenta detectar pelo select
    const sel = $('evolutionConsultation');
    const selText = sel?.options?.[sel.selectedIndex]?.textContent?.toLowerCase?.() || '';
    if (selText.includes('cirurgia')) return true;

    // 3) Tenta detectar pelo display verde
    const disp = $('evolutionConsultationName');
    const dispText = disp?.textContent?.toLowerCase?.() || '';
    if (dispText.includes('cirurgia')) return true;

    return false;
  }

  function showHideSurgicalBox() {
    const box = $('surgicalEvolutionFindings');
    if (!box) return;
    if (isSurgeryContext()) {
      box.style.display = 'block';
    } else {
      box.style.display = 'none';
      document.querySelectorAll('.surg-find').forEach(cb => cb.checked = false);
    }
  }

  function getCheckedFindings() {
    return Array.from(document.querySelectorAll('.surg-find:checked')).map(x => x.value);
  }

  function findingsToHuman(findings) {
    const map = {
      necrose: 'Necrose',
      crostas: 'Crostas',
      infeccao_secundaria: 'Infec√ß√£o secund√°ria',
      foliculite_aguda: 'Foliculite aguda',
      foliculite_cronica: 'Foliculite cr√¥nica',
      rarefacao_capilar: 'Rarefa√ß√£o capilar',
      falha_localizada: 'Falha localizada'
    };
    return findings.map(f => map[f] || f);
  }

  function injectFindingsIntoContentIfNeeded() {
    if (!isSurgeryContext()) return;

    const txt = $('evolutionContent');
    if (!txt) return;

    const findings = getCheckedFindings();
    // Sempre padroniza: se n√£o marcar nada, salva como "Sem achados selecionados"
    const human = findings.length ? findingsToHuman(findings).join(', ') : 'Sem achados selecionados';

    const blockHeader = '[ACHADOS CIR√öRGICOS - CHECKLIST]';
    const block = `${blockHeader}\n- ${human}\n[/ACHADOS CIR√öRGICOS]\n`;

    // Remove bloco antigo para evitar duplicar
    const current = txt.value || '';
    const cleaned = current
      .replace(/\[ACHADOS CIR√öRGICOS - CHECKLIST\][\s\S]*?\[\/ACHADOS CIR√öRGICOS\]\n?/g, '')
      .trim();

    // Insere no topo (padr√£o fixo)
    txt.value = (block + '\n' + cleaned).trim();
  }

  // ---- Ganchos para atualiza√ß√£o do contexto ----
  document.addEventListener('DOMContentLoaded', function() {
    // 1) Ao mudar o select, reavalia contexto
    const sel = $('evolutionConsultation');
    if (sel) {
      sel.addEventListener('change', function() {
        // opcional: se quiser fixar dataset.context automaticamente
        const modal = $('evolutionModal');
        const txt = sel.options[sel.selectedIndex]?.textContent?.toLowerCase?.() || '';
        if (modal) modal.dataset.context = txt.includes('cirurgia') ? 'surgery' : 'consultation';
        showHideSurgicalBox();
      });
    }

    // 2) Ao abrir o modal, reavalia
    const modalEl = $('evolutionModal');
    if (modalEl) {
      modalEl.addEventListener('shown.bs.modal', function() {
        showHideSurgicalBox();
      });
    }

    // 3) Se o usu√°rio clicar nos checkboxes, mant√©m o texto sempre preparado
    document.addEventListener('change', function(e) {
      if (e.target && e.target.classList && e.target.classList.contains('surg-find')) {
        // n√£o injeta automaticamente (para n√£o atrapalhar enquanto digita),
        // mas pode ser √∫til manter o bloco pronto se voc√™ quiser:
        // injectFindingsIntoContentIfNeeded();
      }
    });

    // 4) Intercepta saveEvolution() SEM precisar editar o arquivo JS original:
    //    - Se saveEvolution existir globalmente, ‚Äúwrap‚Äù com inje√ß√£o do checklist antes de salvar
    const originalSaveEvolution = window.saveEvolution;
    if (typeof originalSaveEvolution === 'function') {
      window.saveEvolution = function() {
        // garante que o checklist vai junto (no texto)
        injectFindingsIntoContentIfNeeded();
        return originalSaveEvolution.apply(this, arguments);
      };
    }

    // Primeira avalia√ß√£o
    showHideSurgicalBox();
  });

})();
</script>
<script>
const patientId = {{ patient.id }};
window.patientId = {{ patient.id }};
window.patientName = "{{ patient.name }}";
window.appointmentId = {{ appointment_id | tojson }};
console.log('DEBUG prontuario: appointmentId from URL =', window.appointmentId);

document.addEventListener('DOMContentLoaded', function() {
    // Se nao tem appointment_id, buscar o ultimo agendamento do paciente para hoje
    if (!window.appointmentId) {
        fetch(`/api/patient/${patientId}/today-appointment`)
            .then(r => r.json())
            .then(data => {
                if (data.appointment_id) {
                    window.appointmentId = data.appointment_id;
                    console.log('DEBUG: Loaded today appointment_id =', window.appointmentId);
                }
            })
            .catch(err => console.log('No today appointment found'));
    }
    
    if (typeof loadPrescriptionHistory === 'function') {
        loadPrescriptionHistory();
    }
});
</script>
    <script src="{{ url_for('static', filename='js/surgeries.js') }}?v={{ range(1, 100000) | random }}"></script>
<script src="{{ url_for('static', filename='js/prontuario.js') }}"></script>
{% endblock %}
