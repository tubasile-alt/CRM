{% extends "base.html" %}

{% block title %}Prontu√°rio - {{ patient.name }}{% endblock %}

{% block content %}
<script>
function calculateAge(birthDate) {
    if (!birthDate) return null;
    const today = new Date();
    const birth = new Date(birthDate + 'T00:00:00');
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    return age >= 0 ? age : null;
}

const patientBirth = '{{ patient.birth_date }}';
const age = calculateAge(patientBirth);

function openAttentionModal() {
    document.getElementById('attentionText').value = document.getElementById('attentionContent').textContent;
    new bootstrap.Modal(document.getElementById('attentionModal')).show();
}

function saveAttentionNote() {
    const content = document.getElementById('attentionText').value;
    fetch(`/api/patient/{{ patient.id }}/attention-note`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({attention_note: content})
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            document.getElementById('attentionContent').textContent = content;
            document.getElementById('attentionBadge').style.display = content ? 'inline' : 'none';
            bootstrap.Modal.getInstance(document.getElementById('attentionModal')).hide();
            showAlert('Anota√ß√£o salva!', 'success');
        } else {
            showAlert(result.error || 'Erro ao salvar', 'danger');
        }
    })
    .catch(err => {
        console.error('Erro:', err);
        showAlert('Erro ao salvar anota√ß√£o', 'danger');
    });
}
</script>

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>
                    Prontu√°rio: {{ patient.name }}
                    {% if age %}
                    <small class="text-muted">({{ age }} anos)</small>
                    {% endif %}
                </h2>
                <p class="text-muted mb-0">
                    {% if patient.phone %}<i class="bi bi-telephone"></i> {{ patient.phone }} | {% endif %}
                    {% if patient.email %}<i class="bi bi-envelope"></i> {{ patient.email }}{% endif %}
                    <button class="btn btn-sm btn-warning ms-2" onclick="openAttentionModal()">
                        <i class="bi bi-exclamation-circle"></i> Aten√ß√£o
                    </button>
                    <span id="attentionBadge" class="badge bg-danger ms-2" style="display: {% if patient.attention_note %}inline{% else %}none{% endif %};">
                        <i class="bi bi-exclamation-triangle"></i> Anota√ß√£o
                    </span>
                </p>
            </div>
            <button class="btn btn-outline-secondary" onclick="history.back()">
                <i class="bi bi-arrow-left"></i> Voltar
            </button>
        </div>
    </div>
</div>

<!-- Modal de Aten√ß√£o -->
<div class="modal fade" id="attentionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-exclamation-circle"></i> Anota√ß√£o de Aten√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">Informa√ß√µes importantes sobre o paciente:</label>
                <textarea class="form-control" id="attentionText" rows="6" placeholder="Ex: Al√©rgico a penicilina, tem medo de agulhas, etc..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="saveAttentionNote()">
                    <i class="bi bi-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<div id="attentionContent" style="display:none;">{{ patient.attention_note or '' }}</div>

{% if current_user.is_doctor() %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6>Tags do Paciente</h6>
                <div id="patientTags">
                    {% for tag in tags %}
                    <div class="form-check form-check-inline">
                        <input class="form-check-input tag-checkbox" type="checkbox" 
                               value="{{ tag.id }}" id="tag{{ tag.id }}"
                               {% if tag.id in patient_tags %}checked{% endif %}>
                        <label class="form-check-label" for="tag{{ tag.id }}">
                            <span class="badge" style="background-color: {{ tag.color }}">{{ tag.name }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <button class="btn btn-sm btn-primary mt-2" onclick="savePatientTags()">
                    <i class="bi bi-save"></i> Salvar Tags
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if current_user.is_doctor() %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="mb-3"><i class="bi bi-folder-plus"></i> Categoria do Atendimento</h6>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="category" id="catPatologia" value="patologia" checked>
                    <label class="btn btn-outline-primary" for="catPatologia">
                        <i class="bi bi-capsule"></i> Patologia
                    </label>

                    <input type="radio" class="btn-check" name="category" id="catCosm" value="cosmiatria">
                    <label class="btn btn-outline-success" for="catCosm">
                        <i class="bi bi-stars"></i> Cosmiatria
                    </label>

                    <input type="radio" class="btn-check" name="category" id="catTransp" value="transplante_capilar">
                    <label class="btn btn-outline-info" for="catTransp">
                        <i class="bi bi-person-badge"></i> Transplante Capilar
                    </label>
                </div>
                <small class="text-muted d-block mt-2">Selecione a categoria para adaptar os campos do prontu√°rio</small>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#queixa">Queixa Principal</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#anamnese">Anamnese / Exame F√≠sico</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#diagnostico">Diagn√≥stico</a>
                    </li>
                    <li class="nav-item" id="tabPlanejamento" style="display:none;">
                        <a class="nav-link" data-bs-toggle="tab" href="#planejamento">Planejamento</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#conduta">Conduta</a>
                    </li>
                    <li class="nav-item" id="tabTransplante" style="display:none;">
                        <a class="nav-link" data-bs-toggle="tab" href="#transplante">Dados Cir√∫rgicos</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    {% if current_user.is_doctor() %}
                    <button class="btn btn-sm btn-success" id="startTimer" onclick="startConsultation()">
                        <i class="bi bi-play-circle"></i> Iniciar Atendimento
                    </button>
                    {% endif %}
                    <span id="timerDisplay" class="ms-2 fw-bold"></span>
                </div>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="queixa">
                        <div class="mb-3">
                            <label class="form-label">Queixa Principal</label>
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-sm btn-outline-primary float-end" onclick="startDictation('queixaText')">
                                <i class="bi bi-mic"></i> Ditado
                            </button>
                            {% endif %}
                        </div>
                        <textarea class="form-control" id="queixaText" rows="8" {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                    </div>

                    <div class="tab-pane fade" id="anamnese">
                        <div class="mb-3">
                            <label class="form-label">Anamnese</label>
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-sm btn-outline-primary float-end" onclick="startDictation('anamneseText')">
                                <i class="bi bi-mic"></i> Ditado
                            </button>
                            {% endif %}
                        </div>
                        <textarea class="form-control" id="anamneseText" rows="8" {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                        
                        <div class="mt-3" id="indicatedProceduresSection" style="display:none;">
                            <h6>Procedimentos Indicados</h6>
                            {% for proc in procedures %}
                            <div class="form-check">
                                <input class="form-check-input indicated-proc" type="checkbox" 
                                       value="{{ proc.id }}" id="indicated{{ proc.id }}" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="indicated{{ proc.id }}">
                                    {{ proc.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="diagnostico">
                        <div class="mb-3">
                            <label class="form-label">Diagn√≥stico</label>
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-sm btn-outline-primary float-end" onclick="startDictation('diagnosticoText')">
                                <i class="bi bi-mic"></i> Ditado
                            </button>
                            {% endif %}
                        </div>
                        <textarea class="form-control" id="diagnosticoText" rows="8" {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                    </div>

                    <div class="tab-pane fade" id="conduta">
                        <div class="mb-3">
                            <label class="form-label">Conduta</label>
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-sm btn-outline-primary float-end" onclick="startDictation('condutaText')">
                                <i class="bi bi-mic"></i> Ditado
                            </button>
                            {% endif %}
                        </div>
                        <textarea class="form-control" id="condutaText" rows="8" {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                        
                        <!-- Se√ß√£o para Cosmiatria: Procedimentos Planejados com Or√ßamento e Status -->
                        <div class="mt-4" id="cosmeticConductSection" style="display:none;">
                            <h6><i class="bi bi-check2-square"></i> Procedimentos Planejados - Execu√ß√£o</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Procedimento</th>
                                            <th style="width: 150px;">Or√ßamento (R$)</th>
                                            <th style="width: 140px;">Data Realiza√ß√£o</th>
                                            <th style="width: 120px;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cosmeticConductBody">
                                        <!-- Linhas preenchidas via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Procedimentos Realizados (apenas para Cosmiatria, n√£o para Patologia) -->
                        <div class="mt-3" id="conductProceduresSection" style="display:none;">
                            <h6>Procedimentos Realizados</h6>
                            {% for proc in procedures %}
                            <div class="form-check">
                                <input class="form-check-input performed-proc" type="checkbox" 
                                       value="{{ proc.id }}" id="performed{{ proc.id }}" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="performed{{ proc.id }}">
                                    {{ proc.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="mt-4 pt-3 border-top">
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-success btn-lg" onclick="finalizarAtendimento()">
                                <i class="bi bi-check-circle-fill"></i> Finalizar Atendimento
                            </button>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle"></i> Todos os dados ser√£o salvos automaticamente
                            </small>
                            {% endif %}
                        </div>
                    </div>

                    <!-- ABA PLANEJAMENTO CL√çNICO (COSMIATRIA) -->
                    <div class="tab-pane fade" id="planejamento">
                        <h6 class="mb-3"><i class="bi bi-calendar-check"></i> Planejamento Cl√≠nico Cosm√©tico</h6>
                        
                        <div class="table-responsive">
                            <table class="table table-sm" id="cosmeticPlanTable">
                                <thead>
                                    <tr>
                                        <th>Procedimento</th>
                                        <th style="width: 150px;">Valor (R$)</th>
                                        <th style="width: 120px;">Retorno (meses)</th>
                                        <th>Observa√ß√µes</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="cosmeticPlanBody">
                                    <!-- Linhas ser√£o adicionadas via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        {% if current_user.is_doctor() %}
                        <div class="mb-3">
                            <div class="row g-2 mb-2">
                                <div class="col-md-5">
                                    <select class="form-select" id="newProcedureName">
                                        <option value="">Selecione o procedimento...</option>
                                        <option value="Botox">Botox (6 meses)</option>
                                        <option value="Preenchimento">Preenchimento (12 meses)</option>
                                        <option value="MD Codes">MD Codes (12 meses)</option>
                                        <option value="Pearl Fracionado">Pearl Fracionado (6 meses)</option>
                                        <option value="Ulthera">Ulthera (18 meses)</option>
                                        <option value="Morpheus">Morpheus (12 meses)</option>
                                        <option value="Sculptra">Sculptra (18 meses)</option>
                                        <option value="Radiesse">Radiesse (12 meses)</option>
                                        <option value="Harmonyca">Harmonyca (12 meses)</option>
                                        <option value="Profhilo">Profhilo (6 meses)</option>
                                        <option value="Emsculpt Neo">Emsculpt Neo (12 meses)</option>
                                        <option value="Exilis">Exilis (6 meses)</option>
                                        <option value="Emtone">Emtone (6 meses)</option>
                                        <option value="Peeling">Peeling (3 meses)</option>
                                        <option value="Outros">Outros</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control" id="newProcedureValue" placeholder="Valor (R$)" step="any" min="0">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" id="newProcedureMonths" placeholder="Meses" value="6">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-success w-100" onclick="addCosmeticProcedure()">
                                        <i class="bi bi-plus-circle"></i> Adicionar
                                    </button>
                                </div>
                            </div>
                            <textarea class="form-control form-control-sm" id="newProcedureObservations" placeholder="Observa√ß√µes sobre o procedimento (ex: orienta√ß√µes especiais, pontos importantes, etc)" rows="2"></textarea>
                        </div>
                        {% endif %}
                        
                        <div class="alert alert-info">
                            <strong>Total Estimado:</strong> R$ <span id="cosmeticTotal">0,00</span>
                        </div>
                        
                        {% if current_user.is_doctor() %}
                        <button class="btn btn-success" onclick="generateBudget()">
                            <i class="bi bi-file-pdf"></i> Gerar Or√ßamento PDF
                        </button>
                        {% endif %}
                        <div class="alert alert-warning mt-2">
                            <small><i class="bi bi-info-circle"></i> Os procedimentos ser√£o salvos automaticamente ao clicar em "Finalizar Atendimento" na aba Conduta.</small>
                        </div>
                    </div>

                    <!-- ABA DADOS CIR√öRGICOS (TRANSPLANTE CAPILAR) -->
                    <div class="tab-pane fade" id="transplante">
                        <h6 class="mb-3"><i class="bi bi-scissors"></i> Dados do Transplante Capilar</h6>
                        
                        <!-- Hist√≥rico de Transplante -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Hist√≥rico de Transplante Capilar</strong></label>
                            <div class="mb-2">
                                <label class="form-label">J√° realizou transplante capilar anteriormente?</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="previousTransplant" id="previousNo" value="nao" checked onchange="toggleTransplantLocation()" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    <label class="btn btn-outline-secondary" for="previousNo">N√£o</label>
                                    
                                    <input type="radio" class="btn-check" name="previousTransplant" id="previousYes" value="sim" onchange="toggleTransplantLocation()" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    <label class="btn btn-outline-primary" for="previousYes">Sim</label>
                                </div>
                            </div>
                            <div id="transplantLocationSection" style="display:none;" class="mt-2">
                                <label class="form-label">Onde foi realizado?</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="transplantLocation" id="locationICB" value="ICB" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    <label class="btn btn-outline-info" for="locationICB">ICB</label>
                                    
                                    <input type="radio" class="btn-check" name="transplantLocation" id="locationOther" value="outro_servico" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    <label class="btn btn-outline-warning" for="locationOther">Outro Servi√ßo</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Classifica√ß√£o de Norwood -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Classifica√ß√£o de Norwood (N√≠vel de Calv√≠cie)</strong></label>
                            <div class="row g-2">
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="1">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('1'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">üë§</div>
                                        <small><strong>Norwood 1</strong></small>
                                        <input type="radio" name="norwood" value="1" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="2">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('2'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">üë§</div>
                                        <small><strong>Norwood 2</strong></small>
                                        <input type="radio" name="norwood" value="2" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="3">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('3'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">üë§</div>
                                        <small><strong>Norwood 3</strong></small>
                                        <input type="radio" name="norwood" value="3" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="4">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('4'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">üë§</div>
                                        <small><strong>Norwood 4</strong></small>
                                        <input type="radio" name="norwood" value="4" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="5">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('5'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">üë§</div>
                                        <small><strong>Norwood 5</strong></small>
                                        <input type="radio" name="norwood" value="5" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="6">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('6'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">üë§</div>
                                        <small><strong>Norwood 6</strong></small>
                                        <input type="radio" name="norwood" value="6" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upload de Imagens -->
                        {% if current_user.is_doctor() %}
                        <div class="mb-3">
                            <label class="form-label"><strong>Anexos da Consulta</strong></label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label small">Foto da Consulta <span class="text-danger">*</span></label>
                                    <input type="file" class="form-control form-control-sm" id="consultationPhoto" accept="image/*">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Planejamento Cir√∫rgico</label>
                                    <input type="file" class="form-control form-control-sm" id="surgicalPlanImage" accept="image/*">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Simula√ß√£o Visual</label>
                                    <input type="file" class="form-control form-control-sm" id="simulationImage" accept="image/*">
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Tipo de Caso -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Tipo de Caso</strong></label>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="caseType" id="casePrimary" value="primaria" checked {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="btn btn-outline-primary" for="casePrimary">Cirurgia Prim√°ria</label>
                                
                                <input type="radio" class="btn-check" name="caseType" id="caseSecondary" value="secundaria" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="btn btn-outline-warning" for="caseSecondary">Cirurgia Secund√°ria</label>
                            </div>
                        </div>

                        <!-- N√∫mero de Cirurgias e √Åreas -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Planejamento de Cirurgias e √Åreas</strong></label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="singleSurgery" value="1" checked {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="singleSurgery">Uma √∫nica cirurgia</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="twoSurgeries" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="twoSurgeries">Duas cirurgias planejadas</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bodyHair" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="bodyHair">Body hair transplant</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="eyebrowTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="eyebrowTransplant">Transplante de sobrancelha</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="beardTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="beardTransplant">Transplante de barba</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Indica√ß√µes Cir√∫rgicas -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Indica√ß√µes Cir√∫rgicas</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="frontalTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="frontalTransplant">Transplante capilar frontal</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="crownTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="crownTransplant">Transplante capilar em coroa</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="completeTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="completeTransplant">Transplante capilar completo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="completeBodyHair" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="completeBodyHair">Transplante capilar completo com body hair</label>
                            </div>
                        </div>

                        <!-- Planejamento Cir√∫rgico -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Planejamento Cir√∫rgico</strong></label>
                            <textarea class="form-control" id="surgicalPlanning" rows="6" 
                                placeholder="Descreva: linha frontal, n√∫mero estimado de UF, estrat√©gia de extra√ß√£o, distribui√ß√£o de √°reas receptoras, densidade planejada..." {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                        </div>

                        {% if current_user.is_doctor() %}
                        <button class="btn btn-primary" onclick="saveHairTransplant()">
                            <i class="bi bi-save"></i> Salvar Dados Cir√∫rgicos
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- HIST√ìRICO DE CONSULTAS - VIS√çVEL PARA M√âDICOS E SECRET√ÅRIAS -->
<div class="row mt-3">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> Hist√≥rico de Consultas
                </h5>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                {% if consultations %}
                <div class="accordion" id="consultationsAccordion">
                    {% for consultation in consultations %}
                    <div class="accordion-item mb-2">
                        <h2 class="accordion-header" id="heading{{ consultation.id }}">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#collapse{{ consultation.id }}" 
                                    aria-expanded="false" 
                                    aria-controls="collapse{{ consultation.id }}"
                                    data-consultation-key="{{ consultation.id }}"
                                    onclick="highlightConsultationGroup('{{ consultation.id }}')"
                                <div class="w-100">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong>
                                            <i class="bi bi-calendar3"></i> 
                                            {{ consultation.date.strftime('%d/%m/%Y %H:%M') }}
                                            {% if not consultation.is_finalized %}
                                            <span class="badge bg-secondary ms-1" style="font-size: 0.7em;">Rascunho</span>
                                            {% endif %}
                                        </strong>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-primary">
                                                {{ consultation.category|replace('_', ' ')|title if consultation.category else 'Consulta' }}
                                            </span>
                                            {% if current_user.is_doctor() and consultation.appointment_id %}
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick="event.stopPropagation(); window.location.href='/prontuario/{{ patient.id }}?appointment_id={{ consultation.appointment_id }}'"
                                                    title="Editar consulta">
                                                <i class="bi bi-pencil-square"></i> Editar
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        <i class="bi bi-person-circle"></i> {{ consultation.doctor.name }}
                                        {% if consultation.duration %}
                                        | <i class="bi bi-clock"></i> {{ consultation.duration }}min
                                        {% endif %}
                                    </small>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse{{ consultation.id }}" 
                             class="accordion-collapse collapse" 
                             aria-labelledby="heading{{ consultation.id }}" 
                             data-bs-parent="#consultationsAccordion">
                            <div class="accordion-body p-3">
                                <!-- Queixa Principal -->
                                {% if 'queixa' in consultation.notes_by_type %}
                                <div class="mb-3">
                                    <h6 class="text-primary">
                                        <i class="bi bi-chat-left-text"></i> Queixa Principal
                                    </h6>
                                    <p class="mb-0" style="white-space: pre-wrap;">{{ consultation.notes_by_type['queixa'].content }}</p>
                                </div>
                                {% endif %}

                                <!-- Anamnese -->
                                {% if 'anamnese' in consultation.notes_by_type %}
                                <div class="mb-3">
                                    <h6 class="text-primary">
                                        <i class="bi bi-clipboard-pulse"></i> Anamnese / Exame F√≠sico
                                    </h6>
                                    <p class="mb-0" style="white-space: pre-wrap;">{{ consultation.notes_by_type['anamnese'].content }}</p>
                                </div>
                                {% endif %}

                                <!-- Diagn√≥stico -->
                                {% if 'diagnostico' in consultation.notes_by_type %}
                                <div class="mb-3">
                                    <h6 class="text-primary">
                                        <i class="bi bi-clipboard-check"></i> Diagn√≥stico
                                    </h6>
                                    <p class="mb-0" style="white-space: pre-wrap;">{{ consultation.notes_by_type['diagnostico'].content }}</p>
                                </div>
                                {% endif %}

                                <!-- Procedimentos Cosm√©ticos (Cosmiatria) -->
                                {% if consultation.cosmetic_plans %}
                                    <div class="mb-3">
                                        <h6 class="text-success mb-2">
                                            <i class="bi bi-heart-pulse"></i> Planejamento e Execu√ß√£o
                                        </h6>
                                        <div class="list-group">
                                            {% for plan in consultation.cosmetic_plans %}
                                            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-{% if plan.was_performed %}check-circle-fill text-success{% else %}x-circle-fill text-danger{% endif %} me-2 fs-5"></i>
                                                    <div>
                                                        <strong>{{ plan.procedure_name }}</strong> - 
                                                        <span class="text-muted">
                                                            R$ {{ "{:,.2f}".format((plan.final_budget or plan.planned_value)|float).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                                        </span>
                                                        {% if plan.was_performed and plan.performed_date %}
                                                        <br><small class="text-muted">Realizado em: {{ plan.performed_date.strftime('%d/%m/%Y') }}</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div>
                                                    {% if plan.was_performed %}
                                                    <span class="badge bg-success">FEITO</span>
                                                    {% else %}
                                                    <span class="badge bg-danger">PENDENTE</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}

                                <!-- Transplante Capilar -->
                                {% set hair_transplants = [] %}
                                {% for note in consultation.all_notes %}
                                    {% if note.hair_transplants %}
                                        {% set hair_transplants = hair_transplants + note.hair_transplants %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% if hair_transplants %}
                                    {% for ht in hair_transplants %}
                                    <div class="mb-3">
                                        <h6 class="text-success">
                                            <i class="bi bi-scissors"></i> Dados do Transplante Capilar
                                        </h6>
                                        
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <strong>Classifica√ß√£o Norwood:</strong><br>
                                                <span class="badge bg-info">{{ ht.norwood_classification if ht.norwood_classification else 'N√£o informado' }}</span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Tipo de Caso:</strong><br>
                                                {% if ht.case_type == 'primaria' %}
                                                <span class="badge bg-primary">Cirurgia Prim√°ria</span>
                                                {% elif ht.case_type == 'secundaria' %}
                                                <span class="badge bg-warning">Cirurgia Secund√°ria</span>
                                                {% else %}
                                                <span class="badge bg-secondary">N√£o informado</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <strong>Transplante Anterior:</strong><br>
                                                {% if ht.previous_transplant == 'sim' %}
                                                Sim
                                                {% if ht.transplant_location %}
                                                ({{ 'ICB' if ht.transplant_location == 'ICB' else 'Outro Servi√ßo' }})
                                                {% endif %}
                                                {% elif ht.previous_transplant == 'nao' %}
                                                N√£o
                                                {% else %}
                                                <span class="text-muted">N√£o informado</span>
                                                {% endif %}
                                            </div>
                                            <div class="col-6">
                                                <strong>N√∫mero de Cirurgias:</strong><br>
                                                {% if ht.number_of_surgeries is not none %}
                                                {{ ht.number_of_surgeries }} cirurgia(s) planejada(s)
                                                {% else %}
                                                <span class="text-muted">N√£o informado</span>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="mb-2">
                                            <strong>√Åreas Adicionais:</strong><br>
                                            <ul class="mb-0 list-unstyled">
                                                <li>
                                                    <i class="bi bi-{{ 'check-circle-fill text-success' if ht.body_hair_needed else 'x-circle text-muted' }}"></i>
                                                    Body hair transplant: {{ 'Sim' if ht.body_hair_needed else 'N√£o' }}
                                                </li>
                                                <li>
                                                    <i class="bi bi-{{ 'check-circle-fill text-success' if ht.eyebrow_transplant else 'x-circle text-muted' }}"></i>
                                                    Transplante de sobrancelha: {{ 'Sim' if ht.eyebrow_transplant else 'N√£o' }}
                                                </li>
                                                <li>
                                                    <i class="bi bi-{{ 'check-circle-fill text-success' if ht.beard_transplant else 'x-circle text-muted' }}"></i>
                                                    Transplante de barba: {{ 'Sim' if ht.beard_transplant else 'N√£o' }}
                                                </li>
                                            </ul>
                                        </div>

                                        {% if ht.frontal_transplant or ht.crown_transplant or ht.complete_transplant or ht.complete_with_body_hair %}
                                        <div class="mb-2">
                                            <strong>Indica√ß√µes Cir√∫rgicas:</strong><br>
                                            <ul class="mb-0">
                                                {% if ht.frontal_transplant %}<li>Transplante frontal</li>{% endif %}
                                                {% if ht.crown_transplant %}<li>Transplante em coroa</li>{% endif %}
                                                {% if ht.complete_transplant %}<li>Transplante completo</li>{% endif %}
                                                {% if ht.complete_with_body_hair %}<li>Transplante completo com body hair</li>{% endif %}
                                            </ul>
                                        </div>
                                        {% endif %}

                                        {% if ht.surgical_planning %}
                                        <div class="mb-2">
                                            <strong>Planejamento Cir√∫rgico:</strong><br>
                                            <p class="mb-0 p-2 bg-light rounded" style="white-space: pre-wrap;">{{ ht.surgical_planning }}</p>
                                        </div>
                                        {% endif %}
                                        
                                        {% if ht.clinical_conduct %}
                                        <div class="mb-2">
                                            <strong>Conduta Cl√≠nica:</strong><br>
                                            <p class="mb-0 p-2 bg-light rounded" style="white-space: pre-wrap;">{{ ht.clinical_conduct }}</p>
                                        </div>
                                        {% endif %}
                                        
                                        {% if ht.images %}
                                        <div class="mb-2">
                                            <strong>Imagens do Transplante:</strong><br>
                                            <div class="row g-2 mt-1">
                                                {% for img in ht.images %}
                                                <div class="col-4">
                                                    <div class="card">
                                                        <img src="{{ url_for('static', filename='uploads/' + img.file_path) }}" 
                                                             class="card-img-top" 
                                                             alt="{{ img.image_type }}"
                                                             style="max-height: 150px; object-fit: cover;">
                                                        <div class="card-body p-2 text-center">
                                                            <small class="text-muted">
                                                                {% if img.image_type == 'consultation_photo' %}Foto Consulta
                                                                {% elif img.image_type == 'surgical_plan' %}Planejamento
                                                                {% elif img.image_type == 'simulation' %}Simula√ß√£o
                                                                {% else %}{{ img.image_type }}{% endif %}
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                                {% endif %}

                                <!-- Procedimentos Indicados/Realizados -->
                                {% set all_indications = [] %}
                                {% for note in consultation.all_notes %}
                                    {% if note.indications %}
                                        {% set all_indications = all_indications + note.indications %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% if all_indications %}
                                    <div class="mb-3">
                                        <h6 class="text-info">
                                            <i class="bi bi-list-check"></i> Procedimentos Realizados no Dia
                                        </h6>
                                        <div class="row">
                                            {% set indicated = all_indications | selectattr('indicated', 'equalto', True) | list %}
                                            {% set performed = all_indications | selectattr('performed', 'equalto', True) | list %}
                                            
                                            {% if indicated %}
                                            <div class="col-6">
                                                <strong class="text-muted">Indicados:</strong>
                                                <ul class="small mb-0">
                                                    {% for ind in indicated %}
                                                    <li>{{ ind.procedure.name }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                            
                                            {% if performed %}
                                            <div class="col-6">
                                                <strong class="text-success">Realizados:</strong>
                                                <ul class="small mb-0">
                                                    {% for ind in performed %}
                                                    <li>{{ ind.procedure.name }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}

                                <!-- Conduta (texto livre) -->
                                {% if 'conduta' in consultation.notes_by_type %}
                                    {% set conduta_text = consultation.notes_by_type['conduta'].content %}
                                    {% if conduta_text and conduta_text != '[Conduta registrada via procedimentos]' %}
                                    <div class="mb-0">
                                        <h6 class="text-primary">
                                            <i class="bi bi-prescription2"></i> Conduta
                                        </h6>
                                        <p class="mb-0" style="white-space: pre-wrap;">{{ conduta_text }}</p>
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center py-4">
                    <i class="bi bi-inbox"></i><br>
                    Nenhuma consulta finalizada registrada.
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const patientId = {{ patient.id }};
const appointmentId = {{ appointment_id | tojson }};
</script>
<script src="{{ url_for('static', filename='js/prontuario.js') }}"></script>
{% endblock %}
