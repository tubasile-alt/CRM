{% extends "base.html" %}

{% block title %}Prontuário - {{ patient.name }}{% endblock %}

{% block content %}
<script>
function calculateAge(birthDate) {
    if (!birthDate) return null;
    const today = new Date();
    const birth = new Date(birthDate + 'T00:00:00');
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    return age >= 0 ? age : null;
}

const patientBirth = '{{ patient.birth_date }}';
const age = calculateAge(patientBirth);

function openAttentionModal() {
    document.getElementById('attentionText').value = document.getElementById('attentionContent').textContent;
    new bootstrap.Modal(document.getElementById('attentionModal')).show();
}

function saveAttentionNote() {
    const content = document.getElementById('attentionText').value;
    fetch(`/api/patient/{{ patient.id }}/attention-note`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({attention_note: content})
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            document.getElementById('attentionContent').textContent = content;
            document.getElementById('attentionBadge').style.display = content ? 'inline' : 'none';
            bootstrap.Modal.getInstance(document.getElementById('attentionModal')).hide();
            showAlert('Anotação salva!', 'success');
        } else {
            showAlert(result.error || 'Erro ao salvar', 'danger');
        }
    })
    .catch(err => {
        console.error('Erro:', err);
        showAlert('Erro ao salvar anotação', 'danger');
    });
}

function openEditPatientModal() {
    new bootstrap.Modal(document.getElementById('editPatientModal')).show();
}

function savePatientData() {
    const data = {
        name: document.getElementById('editPatientName').value,
        email: document.getElementById('editPatientEmail').value,
        phone: document.getElementById('editPatientPhone').value,
        birth_date: document.getElementById('editPatientBirthDate').value,
        cpf: document.getElementById('editPatientCpf').value,
        address: document.getElementById('editPatientAddress').value,
        city: document.getElementById('editPatientCity').value,
        state: document.getElementById('editPatientState').value,
        zip_code: document.getElementById('editPatientZip').value,
        mother_name: document.getElementById('editPatientMotherName').value,
        occupation: document.getElementById('editPatientOccupation').value,
        indication_source: document.getElementById('editPatientIndication').value,
        patient_type: document.getElementById('editPatientType').value
    };
    
    if (!data.name) {
        showAlert('Nome do paciente é obrigatório', 'warning');
        return;
    }
    
    fetch(`/api/patient/{{ patient.id }}/update`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('editPatientModal')).hide();
            showAlert('Dados do paciente atualizados!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.error || 'Erro ao atualizar', 'danger');
        }
    })
    .catch(err => {
        console.error('Erro:', err);
        showAlert('Erro ao salvar dados', 'danger');
    });
}

// Funções de foto do paciente
function uploadPatientPhoto(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    if (file.size > 5 * 1024 * 1024) {
        showAlert('Arquivo muito grande. Máximo 5MB.', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('photo', file);
    
    fetch('/api/patient/{{ patient.id }}/photo', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert('Foto salva com sucesso!', 'success');
            const wrapper = document.getElementById('patientPhotoWrapper');
            wrapper.innerHTML = `<img src="${result.photo_url}?t=${Date.now()}" alt="Foto do paciente" style="width: 100%; height: 100%; object-fit: cover;" id="patientPhoto">`;
            location.reload();
        } else {
            showAlert(result.error || 'Erro ao salvar foto', 'danger');
        }
    })
    .catch(err => {
        console.error('Erro:', err);
        showAlert('Erro ao enviar foto', 'danger');
    });
}

function deletePatientPhoto() {
    if (!confirm('Remover foto do paciente?')) return;
    
    fetch('/api/patient/{{ patient.id }}/photo', {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert('Foto removida!', 'success');
            location.reload();
        } else {
            showAlert(result.error || 'Erro ao remover foto', 'danger');
        }
    })
    .catch(err => {
        console.error('Erro:', err);
        showAlert('Erro ao remover foto', 'danger');
    });
}
</script>

<div class="row">
    <div class="col-12">
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center gap-4">
                    <!-- Foto 3x4 do Paciente -->
                    <div class="patient-photo-container" style="position: relative;">
                        <div id="patientPhotoWrapper" class="patient-photo shadow-sm" style="width: 100px; height: 125px; border: 2px dashed #dee2e6; border-radius: 12px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #ffffff; cursor: pointer; transition: all 0.3s ease;" onclick="document.getElementById('photoInput').click()">
                            {% if patient.photo_url %}
                            <img src="{{ patient.photo_url }}" alt="Foto do paciente" style="width: 100%; height: 100%; object-fit: cover;" id="patientPhoto">
                            {% else %}
                            <div style="text-align: center; color: #adb5bd;" id="photoPlaceholder">
                                <i class="bi bi-camera" style="font-size: 32px;"></i>
                                <div style="font-size: 12px; font-weight: 500; margin-top: 5px;">Foto 3x4</div>
                            </div>
                            {% endif %}
                        </div>
                        <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="uploadPatientPhoto(this)">
                        {% if patient.photo_url %}
                        <button class="btn btn-sm btn-danger shadow-sm" style="position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center;" onclick="event.stopPropagation(); deletePatientPhoto()">
                            <i class="bi bi-x"></i>
                        </button>
                        {% endif %}
                    </div>
                    
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h2 class="mb-1 fw-bold" style="color: #2c3e50;">
                                    Prontuário: {{ patient.name|upper }}
                                    {% if age %}
                                    <span class="text-muted fw-normal fs-4">({{ age }} anos)</span>
                                    {% endif %}
                                    <span id="patientStarsContainer" class="ms-2">
                                        {% if patient.ivp_stars %}
                                            <span class="text-warning">{% for i in range(patient.ivp_stars) %}⭐{% endfor %}</span>
                                        {% endif %}
                                    </span>
                                    <div class="dropdown d-inline-block ms-1">
                                        <button class="btn btn-sm btn-outline-secondary border-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-star"></i> <small>Classificar</small>
                                        </button>
                                        <ul class="dropdown-menu shadow-sm">
                                            <li><h6 class="dropdown-header">Índice Interno</h6></li>
                                            <li><a class="dropdown-item" href="#" onclick="updatePatientStars(null)">[Sem classificação]</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="#" onclick="updatePatientStars(1)">⭐</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="updatePatientStars(2)">⭐⭐</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="updatePatientStars(3)">⭐⭐⭐</a></li>
                                        </ul>
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary border-0 ms-2" onclick="openEditPatientModal()" title="Editar Cadastro">
                                        <i class="bi bi-pencil-square"></i> Editar Cadastro
                                    </button>
                                </h2>
                                <div class="d-flex align-items-center gap-3 text-muted">
                                    {% if patient.phone %}
                                    <span><i class="bi bi-telephone-fill me-1"></i> {{ patient.phone }}</span>
                                    {% endif %}
                                    <div class="vr"></div>
                                    <button class="btn btn-sm btn-warning d-flex align-items-center gap-2 px-3 py-1 rounded-pill fw-bold text-dark border-0" onclick="openAttentionModal()" style="background-color: #ffc107;">
                                        <i class="bi bi-exclamation-circle-fill"></i> Atenção
                                    </button>
                                    <span id="attentionBadge" class="badge rounded-pill bg-danger px-3 py-2" style="display: {% if patient.attention_note %}inline-block{% else %}none{% endif %};">
                                        <i class="bi bi-exclamation-triangle-fill me-1"></i> Anotação
                                    </span>
                                </div>
                            </div>
                            <button class="btn btn-light border shadow-sm px-4 rounded-pill" onclick="history.back()">
                                <i class="bi bi-arrow-left me-2"></i> Voltar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if current_user.is_doctor() %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h6 class="fw-bold mb-3"><i class="bi bi-tags-fill text-primary"></i> Tags do Paciente</h6>
                <div id="patientTags" class="d-flex flex-wrap gap-2">
                    {% for tag in tags %}
                    <div class="form-check p-0 m-0">
                        <input class="btn-check tag-checkbox" type="checkbox" 
                               value="{{ tag.id }}" id="tag{{ tag.id }}"
                               {% if tag.id in patient_tags %}checked{% endif %}>
                        <label class="btn btn-sm rounded-pill px-3 py-1" for="tag{{ tag.id }}" 
                               style="font-size: 0.85rem; border: 1px solid {{ tag.color }}; color: {{ tag.color }}; background: transparent; cursor: pointer;">
                            {{ tag.name }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary btn-sm px-4 rounded-pill shadow-sm fw-bold" onclick="savePatientTags()">
                        <i class="bi bi-save2 me-1"></i> Salvar Tags
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}


<!-- Timeline de Consultas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body py-4">
                {% if debug_info %}
                <div class="alert alert-info mx-5 mt-3 mb-0 py-2 small shadow-sm border-info" style="font-family: monospace; font-size: 11px;">
                    <strong>DEBUG TIMELINE:</strong> 
                    Appts: {{ debug_info.appointments_count }} | 
                    Evos: {{ debug_info.evolutions_count }} | 
                    Total: {{ debug_info.events_total }} |
                    Sample: {{ debug_info.first_evolution_sample }}...
                </div>
                {% endif %}

                <div class="consultation-timeline-container position-relative px-5">
                    <div class="timeline-line position-absolute w-100" style="height: 4px; background: #e9ecef; top: 50%; left: 0; transform: translateY(-50%); z-index: 1;"></div>
                    <div class="d-flex align-items-center justify-content-start gap-4 position-relative py-5 overflow-auto" style="z-index: 2; scrollbar-width: thin;">
                        {% for event in timeline_events %}
                        <div class="timeline-item text-center position-relative" style="min-width: 140px;">
                            <div class="timeline-date mb-2 fw-bold text-muted small">
                                {{ event.dt.strftime('%d/%m/%Y') }}
                                <div class="text-xs opacity-75">{{ event.dt.strftime('%H:%M') }}</div>
                            </div>
                            
                            <div class="timeline-dot-wrapper d-flex justify-content-center">
                                <div class="timeline-dot rounded-circle shadow-sm 
                                    {% if event.type == 'evolution' %}
                                        bg-primary
                                    {% elif event.status == 'atendido' or loop.first %}
                                        bg-success
                                    {% else %}
                                        bg-secondary
                                    {% endif %}" 
                                     style="width: 24px; height: 24px; border: 4px solid #fff; cursor: pointer; transition: all 0.2s;"
                                     data-appointment-id="{{ event.appointment_id or event.id }}"
                                     data-event-type="{{ event.type }}"
                                     data-dt-iso="{{ event.dt_iso }}"
                                     onclick="handleTimelineClick(this)">
                                </div>
                                
                                <div class="timeline-popover position-absolute bg-white p-3 rounded shadow-sm border text-start" 
                                     style="width: 280px; top: 40px; left: 50%; transform: translateX(-50%); display: none; z-index: 1000;">
                                    <div class="fw-bold mb-2 border-bottom pb-1 d-flex justify-content-between">
                                        <span>{{ event.title }}</span>
                                        {% if event.type == 'evolution' %}
                                            <span class="badge bg-primary">Evolução</span>
                                        {% endif %}
                                    </div>
                                    <div class="small text-muted mb-2">
                                        <i class="bi bi-clock me-1"></i> {{ event.dt.strftime('%d/%m/%Y %H:%M') }}
                                        {% if event.doctor %}<br><i class="bi bi-person me-1"></i> {{ event.doctor }}{% endif %}
                                    </div>
                                    <div class="timeline-body small text-dark" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">
                                        {{ event.body|default("(Sem observações)", true) }}
                                    </div>
                                    {% if event.type == 'appointment' %}
                                    <div class="mt-2 border-top pt-2 d-grid">
                                        <button class="btn btn-sm btn-outline-primary" onclick="scrollToConsultation('consultation-{{ event.id }}')">
                                            Ver Consulta
                                        </button>
                                    </div>
                                    {% endif %}
                                    {% if event.type == 'evolution' and "(Evolução sem texto" in event.body %}
                                    <div class="mt-2 border-top pt-2 d-grid">
                                        <button class="btn btn-sm btn-warning" onclick="recalculateEvolution({{ event.appointment_id }})">
                                            <i class="bi bi-arrow-clockwise"></i> Regerar Evolução
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<style>
.text-truncate-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.highlight-consult {
    animation: highlight 2s ease-out;
}
.animate-pulse-red {
    animation: pulse-red 2s infinite;
}
@keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}
@keyframes highlight {
    0% { background-color: rgba(25, 135, 84, 0.1); }
    100% { background-color: transparent; }
}
.timeline-dot:hover {
    transform: scale(1.3);
}
.cursor-pointer { cursor: pointer; }
</style>

<!-- Modal de Atenção -->
<div class="modal fade" id="attentionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-exclamation-circle"></i> Anotação de Atenção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">Informações importantes sobre o paciente:</label>
                <textarea class="form-control" id="attentionText" rows="6" placeholder="Ex: Alérgico a penicilina, tem medo de agulhas, etc..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="saveAttentionNote()">
                    <i class="bi bi-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<div id="attentionContent" style="display:none;">{{ patient.attention_note or '' }}</div>

<!-- Modal de Edição do Paciente -->
<div class="modal fade" id="editPatientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Dados do Paciente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPatientForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="editPatientName" value="{{ patient.name }}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="editPatientEmail" value="{{ patient.email or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Telefone</label>
                            <input type="text" class="form-control" id="editPatientPhone" value="{{ patient.phone or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="editPatientBirthDate" value="{{ patient.birth_date.strftime('%Y-%m-%d') if patient.birth_date else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-control" id="editPatientCpf" value="{{ patient.cpf or '' }}">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Endereço</label>
                            <input type="text" class="form-control" id="editPatientAddress" value="{{ patient.address or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="editPatientCity" value="{{ patient.city or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Estado</label>
                            <input type="text" class="form-control" id="editPatientState" value="{{ patient.state or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-control" id="editPatientZip" value="{{ patient.zip_code or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nome da Mãe</label>
                            <input type="text" class="form-control" id="editPatientMotherName" value="{{ patient.mother_name or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ocupação</label>
                            <input type="text" class="form-control" id="editPatientOccupation" value="{{ patient.occupation or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fonte de Indicação</label>
                            <input type="text" class="form-control" id="editPatientIndication" value="{{ patient.indication_source or '' }}" placeholder="Ex: Google, Indicação de amigo...">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Paciente</label>
                            <select class="form-select" id="editPatientType">
                                <option value="particular" {% if patient.patient_type == 'particular' %}selected{% endif %}>Particular</option>
                                <option value="UNIMED" {% if patient.patient_type == 'UNIMED' %}selected{% endif %}>UNIMED</option>
                                <option value="convenio" {% if patient.patient_type == 'convenio' %}selected{% endif %}>Convênio</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="savePatientData()">
                    <i class="bi bi-save"></i> Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>

{% if current_user.is_doctor() %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="mb-3"><i class="bi bi-folder-plus"></i> Categoria do Atendimento</h6>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="category" id="catPatologia" value="patologia" checked>
                    <label class="btn btn-outline-primary" for="catPatologia">
                        <i class="bi bi-capsule"></i> Patologia
                    </label>

                    <input type="radio" class="btn-check" name="category" id="catCosm" value="cosmiatria">
                    <label class="btn btn-outline-success" for="catCosm">
                        <i class="bi bi-stars"></i> Cosmiatria
                    </label>

                    <input type="radio" class="btn-check" name="category" id="catTransp" value="transplante_capilar">
                    <label class="btn btn-outline-info" for="catTransp">
                        <i class="bi bi-person-badge"></i> Transplante Capilar
                    </label>
                </div>
                <small class="text-muted d-block mt-2">Selecione a categoria para adaptar os campos do prontuário</small>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#queixa">Queixa Principal</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#anamnese">Anamnese / Exame Físico</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#diagnostico">Diagnóstico</a>
                    </li>
                    <li class="nav-item" id="tabPlanejamento" style="display:none;">
                        <a class="nav-link" data-bs-toggle="tab" href="#planejamento">Planejamento</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#conduta">Conduta</a>
                    </li>
                    <li class="nav-item" id="tabTransplante" style="display:none;">
                        <a class="nav-link" data-bs-toggle="tab" href="#transplante">Planejamento Cirúrgico</a>
                    </li>
                    <li class="nav-item" id="tabSurgery" style="display:none;">
                        <a class="nav-link" data-bs-toggle="tab" href="#surgery"><i class="bi bi-heart-pulse"></i> Cirurgias</a>
                    </li>
                    <li class="nav-item ms-auto">
                        <a class="nav-link text-secondary" data-bs-toggle="tab" href="#data-consulta"><i class="bi bi-calendar-event me-1"></i>Data</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="mb-3 d-flex align-items-center">
                    {% if current_user.is_doctor() %}
                    <button class="btn btn-sm btn-success" id="startTimer" onclick="startConsultation()">
                        <i class="bi bi-play-circle"></i> Iniciar Atendimento
                    </button>
                    <button class="btn btn-sm btn-primary ms-2" id="finishTimer" onclick="finishConsultation()">
                        <i class="bi bi-check-all"></i> Finalizar Atendimento
                    </button>
                    {% endif %}
                    <span id="timerDisplay" class="ms-3 fw-bold fs-5 text-primary">00:00</span>
                </div>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="queixa">
                        <div class="mb-3">
                            <label class="form-label">Queixa Principal</label>
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-sm btn-outline-primary float-end" onclick="startDictation('queixaText')">
                                <i class="bi bi-mic"></i> Ditado
                            </button>
                            {% endif %}
                        </div>
                        <textarea class="form-control" id="queixaText" rows="8" {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                    </div>

                    <div class="tab-pane fade" id="anamnese">
                        <div class="mb-3">
                            <label class="form-label">Anamnese</label>
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-sm btn-outline-primary float-end" onclick="startDictation('anamneseText')">
                                <i class="bi bi-mic"></i> Ditado
                            </button>
                            {% endif %}
                        </div>
                        <textarea class="form-control" id="anamneseText" rows="8" {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                        
                        <div class="mt-3" id="indicatedProceduresSection" style="display:none;">
                            <h6>Procedimentos Indicados</h6>
                            {% for proc in procedures %}
                            <div class="form-check">
                                <input class="form-check-input indicated-proc" type="checkbox" 
                                       value="{{ proc.id }}" id="indicated{{ proc.id }}" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="indicated{{ proc.id }}">
                                    {{ proc.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="diagnostico">
                        <div class="mb-3">
                            <label class="form-label">Diagnóstico</label>
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-sm btn-outline-primary float-end" onclick="startDictation('diagnosticoText')">
                                <i class="bi bi-mic"></i> Ditado
                            </button>
                            {% endif %}
                        </div>
                        <textarea class="form-control" id="diagnosticoText" rows="8" {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                    </div>

                    <div class="tab-pane fade" id="conduta">
                        <div class="mb-3">
                            <label class="form-label">Conduta</label>
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-sm btn-outline-primary float-end ms-2" onclick="startDictation('condutaText')">
                                <i class="bi bi-mic"></i> Ditado
                            </button>
                            <button class="btn btn-sm btn-primary float-end" onclick="abrirDermaScribe()">
                                <i class="bi bi-prescription2"></i> Prescrever
                            </button>
                            {% endif %}
                        </div>
                        <textarea class="form-control" id="condutaText" rows="8" {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                        
                        <div class="mt-3" id="prescriptionHistorySection">
                            <h6><i class="bi bi-file-medical"></i> Receitas Emitidas</h6>
                            <div id="prescriptionHistoryList">
                                <small class="text-muted">Nenhuma receita emitida nesta consulta</small>
                            </div>
                        </div>
                        
                        <!-- Seção para Cosmiatria: Procedimentos Planejados com Orçamento e Status -->
                        <div class="mt-4" id="cosmeticConductSection" style="display:none;">
                            <h6><i class="bi bi-check2-square"></i> Procedimentos Planejados - Execução</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Procedimento</th>
                                            <th style="width: 150px;">Orçamento (R$)</th>
                                            <th style="width: 140px;">Data Realização</th>
                                            <th style="width: 120px;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cosmeticConductBody">
                                        <!-- Linhas preenchidas via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Procedimentos Realizados (apenas para Cosmiatria, não para Patologia) -->
                        <div class="mt-3" id="conductProceduresSection" style="display:none;">
                            <h6>Procedimentos Realizados</h6>
                            {% for proc in procedures %}
                            <div class="form-check">
                                <input class="form-check-input performed-proc" type="checkbox" 
                                       value="{{ proc.id }}" id="performed{{ proc.id }}" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="performed{{ proc.id }}">
                                    {{ proc.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        
                            <div id="evolutionHistorySection" class="p-3 mb-3 bg-light rounded border border-success" style="min-height: 100px;">
                                <h6 class="text-success mb-3 fw-bold">
                                    <i class="bi bi-stickies-fill"></i> EVOLUÇÕES DESTE ATENDIMENTO (19/02)
                                </h6>
                                <div id="currentConsultationEvolutions" class="mt-2 bg-white p-3 rounded border shadow-sm" style="display: block !important; visibility: visible !important;">
                                    <p class="text-muted small mb-0">Carregando histórico de evoluções salvos hoje...</p>
                                </div>
                            </div>

                            <div class="mt-4 pt-3 border-top">
                            {% if current_user.is_doctor() %}
                            <button class="btn btn-success btn-lg" onclick="finalizarAtendimento()">
                                <i class="bi bi-check-circle-fill"></i> Finalizar Atendimento
                            </button>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle"></i> Todos os dados serão salvos automaticamente
                            </small>
                            {% endif %}
                        </div>
                    </div>

                    <!-- ABA PLANEJAMENTO CLÍNICO (COSMIATRIA) -->
                    <div class="tab-pane fade" id="planejamento">
                        <h6 class="mb-3"><i class="bi bi-calendar-check"></i> Planejamento Clínico Cosmético</h6>
                        
                        <div class="table-responsive">
                            <table class="table table-sm" id="cosmeticPlanTable">
                                <thead>
                                    <tr>
                                        <th>Procedimento</th>
                                        <th style="width: 150px;">Valor (R$)</th>
                                        <th style="width: 120px;">Retorno (meses)</th>
                                        <th>Observações</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="cosmeticPlanBody">
                                    <!-- Linhas serão adicionadas via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        {% if current_user.is_doctor() %}
                        <div class="mb-3">
                            <div class="row g-2 mb-2">
                                <div class="col-md-5">
                                    <select class="form-select" id="newProcedureName">
                                        <option value="">Selecione o procedimento...</option>
                                        <option value="Botox">Botox (6 meses)</option>
                                        <option value="Preenchimento">Preenchimento (12 meses)</option>
                                        <option value="MD Codes">MD Codes (12 meses)</option>
                                        <option value="Pearl Fracionado">Pearl Fracionado (6 meses)</option>
                                        <option value="LIMELIGHT FACE">LIMELIGHT FACE</option>
                                        <option value="PROTOCOLO MÃOS(LIMELIGHT + PEARL)">PROTOCOLO MÃOS(LIMELIGHT + PEARL)</option>
                                        <option value="PDRN">PDRN</option>
                                        <option value="LASER CICATRIZ">LASER CICATRIZ</option>
                                        <option value="PEQUENA CIRURGIA">PEQUENA CIRURGIA</option>
                                        <option value="Ulthera">Ulthera (18 meses)</option>
                                        <option value="Morpheus">Morpheus (12 meses)</option>
                                        <option value="Sculptra">Sculptra (18 meses)</option>
                                        <option value="Radiesse">Radiesse (12 meses)</option>
                                        <option value="Harmonyca">Harmonyca (12 meses)</option>
                                        <option value="Profhilo">Profhilo (6 meses)</option>
                                        <option value="Emsculpt Neo">Emsculpt Neo (12 meses)</option>
                                        <option value="Exilis">Exilis (6 meses)</option>
                                        <option value="Emtone">Emtone (6 meses)</option>
                                        <option value="Peeling">Peeling (3 meses)</option>
                                        <option value="Outros">Outros</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control" id="newProcedureValue" placeholder="Valor (R$)" step="any" min="0">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" id="newProcedureMonths" placeholder="Meses" value="6">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-success w-100" onclick="addCosmeticProcedure()">
                                        <i class="bi bi-plus-circle"></i> Adicionar
                                    </button>
                                </div>
                            </div>
                            <textarea class="form-control form-control-sm" id="newProcedureObservations" placeholder="Observações sobre o procedimento (ex: orientações especiais, pontos importantes, etc)" rows="2"></textarea>
                        </div>
                        {% endif %}
                        
                        <div class="alert alert-info">
                            <strong>Total Estimado:</strong> R$ <span id="cosmeticTotal">0,00</span>
                        </div>
                        
                        {% if current_user.is_doctor() %}
                        <button class="btn btn-success" onclick="generateBudget()">
                            <i class="bi bi-file-pdf"></i> Gerar Orçamento PDF
                        </button>
                        {% endif %}
                        <div class="alert alert-warning mt-2">
                            <small><i class="bi bi-info-circle"></i> Os procedimentos serão salvos automaticamente ao clicar em "Finalizar Atendimento" na aba Conduta.</small>
                        </div>
                    </div>

                    <!-- ABA CIRURGIAS (TRANSPLANTE CAPILAR) -->
                    <div class="tab-pane fade" id="surgery">
                        <h6 class="mb-3"><i class="bi bi-heart-pulse"></i> Registro de Cirurgias</h6>
                        
                        {% if current_user.is_doctor() %}
                        <div class="card mb-4 p-3 bg-light">
                            <h6 class="mb-3">Registrar Nova Cirurgia</h6>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Data da Cirurgia</strong></label>
                                    <input type="date" id="surgeryDate" class="form-control">
                                    <small class="text-muted">Data atual ou retroativa</small>
                                </div>
                            </div>
                            <div class="row g-2 mt-3">
                                <div class="col-12">
                                    <label class="form-label"><strong>Tipo de Cirurgia</strong></label>
                                    <div class="d-flex flex-wrap gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="surgeryTypeCapilar" value="Capilar">
                                            <label class="form-check-label" for="surgeryTypeCapilar">So Capilar</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="surgeryTypeBodyHair" value="Body Hair">
                                            <label class="form-check-label" for="surgeryTypeBodyHair">Body Hair</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="surgeryTypeSobrancelhas" value="Sobrancelhas">
                                            <label class="form-check-label" for="surgeryTypeSobrancelhas">Sobrancelhas</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="surgeryTypeBarba" value="Barba">
                                            <label class="form-check-label" for="surgeryTypeBarba">Barba</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="surgeryTypeRetoque" value="Retoque">
                                            <label class="form-check-label" for="surgeryTypeRetoque">Retoque</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label"><strong>Dados Cirúrgicos</strong></label>
                                    <textarea id="surgicalData" class="form-control" rows="3" placeholder="Técnica, número de enxertos, áreas operadas, detalhes do procedimento..."></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label"><strong>Observações</strong></label>
                                    <textarea id="surgeryObservations" class="form-control" rows="3" placeholder="Intercorrências, pontos importantes, cuidados pós-operatórios..."></textarea>
                                </div>
                            </div>
                            <button class="btn btn-success mt-3" onclick="saveSurgery()">
                                <i class="bi bi-plus-circle"></i> Registrar Cirurgia
                            </button>
                        </div>
                        {% endif %}
                        
                        <h6 class="mb-2"><strong>Histórico de Cirurgias</strong></h6>
                        <div id="surgeriesList" class="mb-3">
                            <p class="text-muted text-center">Carregando cirurgias...</p>
                        </div>
                    </div>

                    <!-- ABA PLANEJAMENTO CIRÚRGICO (TRANSPLANTE CAPILAR) -->
                    <div class="tab-pane fade" id="transplante">
                        <h6 class="mb-3"><i class="bi bi-scissors"></i> Planejamento Cirúrgico</h6>
                        
                        <!-- Indicação de Transplante -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Indicação de Transplante Capilar</strong></label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="transplantIndication" id="indicationNo" value="nao" {% if not patient.has_transplant_indication %}checked{% endif %} onchange="saveTransplantIndication()" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="btn btn-outline-danger" for="indicationNo">Não tem indicação</label>
                                
                                <input type="radio" class="btn-check" name="transplantIndication" id="indicationYes" value="sim" {% if patient.has_transplant_indication %}checked{% endif %} onchange="saveTransplantIndication()" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="btn btn-outline-success" for="indicationYes">Sim, tem indicação</label>
                            </div>
                        </div>
                        
                        <!-- Histórico de Transplante -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Histórico de Transplante Capilar</strong></label>
                            <div class="mb-2">
                                <label class="form-label">Já realizou transplante capilar anteriormente?</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="previousTransplant" id="previousNo" value="nao" checked onchange="toggleTransplantLocation()" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    <label class="btn btn-outline-secondary" for="previousNo">Não</label>
                                    
                                    <input type="radio" class="btn-check" name="previousTransplant" id="previousYes" value="sim" onchange="toggleTransplantLocation()" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    <label class="btn btn-outline-primary" for="previousYes">Sim</label>
                                </div>
                            </div>
                            <div id="transplantLocationSection" style="display:none;" class="mt-2">
                                <label class="form-label">Onde foi realizado?</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="transplantLocation" id="locationICB" value="ICB" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    <label class="btn btn-outline-info" for="locationICB">ICB</label>
                                    
                                    <input type="radio" class="btn-check" name="transplantLocation" id="locationOther" value="outro_servico" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    <label class="btn btn-outline-warning" for="locationOther">Outro Serviço</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Classificação de Norwood -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Classificação de Norwood (Nível de Calvície)</strong></label>
                            <div class="row g-2">
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="1">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('1'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">👤</div>
                                        <small><strong>Norwood 1</strong></small>
                                        <input type="radio" name="norwood" value="1" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="2">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('2'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">👤</div>
                                        <small><strong>Norwood 2</strong></small>
                                        <input type="radio" name="norwood" value="2" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="3">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('3'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">👤</div>
                                        <small><strong>Norwood 3</strong></small>
                                        <input type="radio" name="norwood" value="3" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="4">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('4'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">👤</div>
                                        <small><strong>Norwood 4</strong></small>
                                        <input type="radio" name="norwood" value="4" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="5">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('5'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">👤</div>
                                        <small><strong>Norwood 5</strong></small>
                                        <input type="radio" name="norwood" value="5" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4 col-lg-2" data-norwood="6">
                                    <div class="card norwood-card text-center p-2" onclick="{% if current_user.is_doctor() %}selectNorwood('6'){% endif %}" style="{% if not current_user.is_doctor() %}cursor: default; opacity: 0.7;{% endif %}">
                                        <div class="norwood-icon mb-1">👤</div>
                                        <small><strong>Norwood 6</strong></small>
                                        <input type="radio" name="norwood" value="6" style="display:none;" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upload de Imagens -->
                        {% if current_user.is_doctor() %}
                        <div class="mb-3">
                            <label class="form-label"><strong>Anexos da Consulta</strong></label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label small">Foto da Consulta <span class="text-danger">*</span></label>
                                    <input type="file" class="form-control form-control-sm" id="consultationPhoto" accept="image/*">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Planejamento Cirúrgico</label>
                                    <input type="file" class="form-control form-control-sm" id="surgicalPlanImage" accept="image/*">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Simulação Visual</label>
                                    <input type="file" class="form-control form-control-sm" id="simulationImage" accept="image/*">
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Tipo de Caso -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Tipo de Caso</strong></label>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="caseType" id="casePrimary" value="primaria" checked {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="btn btn-outline-primary" for="casePrimary">Cirurgia Primária</label>
                                
                                <input type="radio" class="btn-check" name="caseType" id="caseSecondary" value="secundaria" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="btn btn-outline-warning" for="caseSecondary">Cirurgia Secundária</label>
                            </div>
                        </div>

                        <!-- Número de Cirurgias e Áreas -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Planejamento de Cirurgias e Áreas</strong></label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="singleSurgery" value="1" checked {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="singleSurgery">Uma única cirurgia</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="twoSurgeries" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="twoSurgeries">Duas cirurgias planejadas</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bodyHair" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="bodyHair">Body hair transplant</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="eyebrowTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="eyebrowTransplant">Transplante de sobrancelha</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="beardTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="beardTransplant">Transplante de barba</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="feminineHairTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                        <label class="form-check-label" for="feminineHairTransplant">Transplante capilar feminino</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Indicações Cirúrgicas -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Indicações Cirúrgicas</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="frontalTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="frontalTransplant">Transplante capilar frontal</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="crownTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="crownTransplant">Transplante capilar em coroa</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="completeTransplant" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="completeTransplant">Transplante capilar completo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="completeBodyHair" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="completeBodyHair">Transplante capilar completo com body hair</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="densePacking" {% if not current_user.is_doctor() %}disabled{% endif %}>
                                <label class="form-check-label" for="densePacking">Dense Packing</label>
                            </div>
                        </div>

                        <!-- Planejamento Cirúrgico -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Planejamento Cirúrgico</strong></label>
                            <textarea class="form-control" id="surgicalPlanning" rows="6" 
                                placeholder="Descreva: linha frontal, número estimado de UF, estratégia de extração, distribuição de áreas receptoras, densidade planejada..." {% if not current_user.is_doctor() %}readonly{% endif %}></textarea>
                        </div>

                        <!-- SUB-CATEGORIA: CIRURGIA -->
                        <div class="card mt-4 border-danger">
                            <div class="card-header bg-danger text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-scissors"></i> Cirurgias Realizadas</h6>
                                    {% if current_user.is_doctor() %}
                                    <button class="btn btn-sm btn-light" onclick="openSurgeryModal()"><i class="bi bi-plus"></i> Adicionar Cirurgia</button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="surgeriesList" class="accordion">
                                    <!-- Cirurgias serão carregadas aqui via JavaScript -->
                                </div>
                                <p class="text-muted text-center mt-3" id="noSurgeriesMsg">Nenhuma cirurgia registrada</p>
                            </div>
                        </div>

                        <!-- MODAL CIRURGIA -->
                        <div class="modal fade" id="surgeryModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header bg-danger text-white">
                                        <h5 class="modal-title"><i class="bi bi-scissors"></i> Registrar Cirurgia</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Data da Cirurgia *</strong></label>
                                            <input type="date" class="form-control" id="surgeryModalDate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Planejamento Cirúrgico</strong></label>
                                            <textarea class="form-control" id="surgeryModalSurgicalPlanning" rows="5" placeholder="Descreva o planejamento detalhado da cirurgia..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Intercorrências</strong></label>
                                            <textarea class="form-control" id="surgeryModalComplications" rows="4" placeholder="Relate qualquer complicação ou evento inusitado durante a cirurgia..."></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="button" class="btn btn-danger" onclick="saveSurgery()"><i class="bi bi-check"></i> Salvar Cirurgia</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3">
                            <small><i class="bi bi-info-circle"></i> O planejamento cirúrgico será salvo automaticamente ao clicar em "Finalizar Atendimento" na aba Conduta.</small>
                        </div>
                    </div>

                    <!-- ABA DATA DA CONSULTA -->
                    <div class="tab-pane fade" id="data-consulta">
                        <div class="py-3" style="max-width: 400px;">
                            <h6 class="mb-1"><i class="bi bi-calendar-event me-2 text-primary"></i>Data da Consulta</h6>
                            <p class="text-muted small mb-4">Altere a data para registrar consultas retroativas ou adiantar agendamentos.</p>
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Data e Hora</label>
                                <input type="datetime-local" id="consultationDateInput" class="form-control form-control-lg">
                            </div>
                            <button class="btn btn-primary px-4" onclick="saveConsultationDate()">
                                <i class="bi bi-check-circle me-2"></i>Salvar Data
                            </button>
                            <span id="consultationDateStatus" class="ms-3 small"></span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- HISTÓRICO DE CONSULTAS - VISÍVEL PARA MÉDICOS E SECRETÁRIAS -->
<div class="row mt-3">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> Histórico de Consultas
                </h5>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                {% if consultations %}
                <div class="accordion" id="consultationsAccordion">
                    {% for consultation in consultations %}
                    <div class="accordion-item mb-2 consultation-card" id="consultation-{{ consultation.id }}">
                        <h2 class="accordion-header" id="heading{{ consultation.id }}">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#collapse{{ consultation.id }}" 
                                    aria-expanded="false" 
                                    aria-controls="collapse{{ consultation.id }}"
                                    data-consultation-key="{{ consultation.id }}"
                                    onclick="highlightConsultationGroup('{{ consultation.id }}')"
                                <div class="w-100">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong>
                                            <i class="bi bi-calendar3"></i> 
                                            {{ consultation.date.strftime('%d/%m/%Y %H:%M') }}
                                            {% if not consultation.all_notes %}
                                            <span class="badge bg-warning text-dark ms-1" style="font-size: 0.7em;"><i class="bi bi-exclamation-triangle-fill me-1"></i>Sem notas</span>
                                            {% elif not consultation.is_finalized %}
                                            <span class="badge bg-secondary ms-1" style="font-size: 0.7em;">Rascunho</span>
                                            {% endif %}
                                        </strong>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-primary">
                                                {{ consultation.category|replace('_', ' ')|title if consultation.category else 'Consulta' }}
                                            </span>
                                            {% if current_user.is_doctor() %}
                                            <button class="btn btn-sm btn-outline-success" 
                                                    onclick="event.stopPropagation(); openEvolutionFromConsultation({{ consultation.id }}, '{{ consultation.date.strftime('%d/%m/%Y %H:%M') }}')"
                                                    title="Adicionar evolução para esta consulta">
                                                <i class="bi bi-plus-circle"></i> Evolução
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning" 
                                                    onclick="event.stopPropagation(); editConsultationDate({{ consultation.id }}, '{{ consultation.date.strftime('%Y-%m-%dT%H:%M') }}')"
                                                    title="Editar data e informações">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="event.stopPropagation(); deleteConsultation({{ consultation.id }}, '{{ consultation.date.strftime('%d/%m/%Y') }}')"
                                                    title="Deletar consulta">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            {% if consultation.appointment_id %}
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick="event.stopPropagation(); window.location.href='/prontuario/{{ patient.id }}?appointment_id={{ consultation.appointment_id }}'"
                                                    title="Editar consulta completa">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        <i class="bi bi-person-circle"></i> {{ consultation.doctor.name }}
                                        {% if consultation.duration %}
                                        | <i class="bi bi-clock"></i> {{ consultation.duration }}min
                                        {% endif %}
                                    </small>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse{{ consultation.id }}" 
                             class="accordion-collapse collapse" 
                             aria-labelledby="heading{{ consultation.id }}" 
                             data-bs-parent="#consultationsAccordion">
                            <div class="accordion-body p-3">
                                {% if not consultation.all_notes and not consultation.evolutions %}
                                <div class="text-center py-3">
                                    <i class="bi bi-journal-x text-warning" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2 mb-3">Nenhum conteúdo clínico foi salvo nesta consulta.</p>
                                    <a href="/prontuario/{{ patient.id }}?appointment_id={{ consultation.id }}" class="btn btn-warning btn-sm px-4">
                                        <i class="bi bi-pencil-square me-1"></i> Preencher Prontuário
                                    </a>
                                </div>
                                {% endif %}

                                <!-- Evoluções (Novo fallback/primário) -->
                                {% if consultation.evolutions %}
                                <div class="mb-3">
                                    <h6 class="text-primary">
                                        <i class="bi bi-journal-text"></i> Evoluções do Prontuário
                                    </h6>
                                    {% for evo in consultation.evolutions %}
                                    <div class="p-2 mb-2 bg-light rounded border-start border-3 border-primary" id="evolution-{{ evo.id }}">
                                        <small class="text-muted d-block mb-1">
                                            {{ evo.evolution_date.strftime('%d/%m/%Y %H:%M') }} - Dr(a). {{ evo.doctor.name }}
                                        </small>
                                        <p class="mb-0" style="white-space: pre-wrap;">{{ evo.content }}</p>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                <!-- Queixa Principal -->
                                {% if 'queixa' in consultation.notes_by_type %}
                                <div class="mb-3">
                                    <h6 class="text-primary">
                                        <i class="bi bi-chat-left-text"></i> Queixa Principal
                                    </h6>
                                    <p class="mb-0" style="white-space: pre-wrap;">{{ consultation.notes_by_type['queixa'].content }}</p>
                                </div>
                                {% endif %}

                                <!-- Anamnese -->
                                {% if 'anamnese' in consultation.notes_by_type %}
                                <div class="mb-3">
                                    <h6 class="text-primary">
                                        <i class="bi bi-clipboard-pulse"></i> Anamnese / Exame Físico
                                    </h6>
                                    <p class="mb-0" style="white-space: pre-wrap;">{{ consultation.notes_by_type['anamnese'].content }}</p>
                                </div>
                                {% endif %}

                                <!-- Diagnóstico -->
                                {% if 'diagnostico' in consultation.notes_by_type %}
                                <div class="mb-3">
                                    <h6 class="text-primary">
                                        <i class="bi bi-clipboard-check"></i> Diagnóstico
                                    </h6>
                                    <p class="mb-0" style="white-space: pre-wrap;">{{ consultation.notes_by_type['diagnostico'].content }}</p>
                                </div>
                                {% endif %}

                                <!-- Procedimentos Cosméticos (Cosmiatria) -->
                                {% if consultation.cosmetic_plans %}
                                    <div class="mb-3">
                                        <h6 class="text-success mb-2">
                                            <i class="bi bi-heart-pulse"></i> Planejamento e Execução
                                        </h6>
                                        <div class="list-group">
                                            {% for plan in consultation.cosmetic_plans %}
                                            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-{% if plan.was_performed %}check-circle-fill text-success{% else %}x-circle-fill text-danger{% endif %} me-2 fs-5"></i>
                                                    <div>
                                                        <strong>{{ plan.procedure_name }}</strong> - 
                                                        <span class="text-muted">
                                                            R$ {{ "{:,.2f}".format((plan.final_budget or plan.planned_value)|float).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                                        </span>
                                                        {% if plan.was_performed and plan.performed_date %}
                                                        <br><small class="text-muted">Realizado em: {{ plan.performed_date.strftime('%d/%m/%Y') }}</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div>
                                                    {% if plan.was_performed %}
                                                    <span class="badge bg-success">FEITO</span>
                                                    {% else %}
                                                    <button class="btn btn-sm btn-danger py-0 px-2 fw-bold" 
                                                            onclick="performCosmeticProcedure({{ plan.id }}, '{{ plan.procedure_name }}')"
                                                            title="Clique para marcar como realizado hoje e abrir evolução">
                                                        PENDENTE
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}

                                <!-- Transplante Capilar -->
                                {% set hair_transplants = [] %}
                                {% for note in consultation.all_notes %}
                                    {% if note.hair_transplants %}
                                        {% set hair_transplants = hair_transplants + note.hair_transplants %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% if hair_transplants %}
                                    {% for ht in hair_transplants %}
                                    <div class="mb-3">
                                        <h6 class="text-success">
                                            <i class="bi bi-scissors"></i> Dados do Transplante Capilar
                                        </h6>
                                        
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <strong>Classificação Norwood:</strong><br>
                                                <span class="badge bg-info">{{ ht.norwood_classification if ht.norwood_classification else 'Não informado' }}</span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Tipo de Caso:</strong><br>
                                                {% if ht.case_type == 'primaria' %}
                <script>const hairTransplantId = {{ consultation.all_notes[0].hair_transplants[0].id if consultation.all_notes and consultation.all_notes[0].hair_transplants else 'null' }};</script>
                                                <span class="badge bg-primary">Cirurgia Primária</span>
                                                {% elif ht.case_type == 'secundaria' %}
                                                <span class="badge bg-warning">Cirurgia Secundária</span>
                                                {% else %}
                                                <span class="badge bg-secondary">Não informado</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <strong>Transplante Anterior:</strong><br>
                                                {% if ht.previous_transplant == 'sim' %}
                                                Sim
                                                {% if ht.transplant_location %}
                                                ({{ 'ICB' if ht.transplant_location == 'ICB' else 'Outro Serviço' }})
                                                {% endif %}
                                                {% elif ht.previous_transplant == 'nao' %}
                                                Não
                                                {% else %}
                                                <span class="text-muted">Não informado</span>
                                                {% endif %}
                                            </div>
                                            <div class="col-6">
                                                <strong>Número de Cirurgias:</strong><br>
                                                {% if ht.number_of_surgeries is not none %}
                                                {{ ht.number_of_surgeries }} cirurgia(s) planejada(s)
                                                {% else %}
                                                <span class="text-muted">Não informado</span>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="mb-2">
                                            <strong>Áreas Adicionais:</strong><br>
                                            <ul class="mb-0 list-unstyled">
                                                <li>
                                                    <i class="bi bi-{{ 'check-circle-fill text-success' if ht.body_hair_needed else 'x-circle text-muted' }}"></i>
                                                    Body hair transplant: {{ 'Sim' if ht.body_hair_needed else 'Não' }}
                                                </li>
                                                <li>
                                                    <i class="bi bi-{{ 'check-circle-fill text-success' if ht.eyebrow_transplant else 'x-circle text-muted' }}"></i>
                                                    Transplante de sobrancelha: {{ 'Sim' if ht.eyebrow_transplant else 'Não' }}
                                                </li>
                                                <li>
                                                    <i class="bi bi-{{ 'check-circle-fill text-success' if ht.beard_transplant else 'x-circle text-muted' }}"></i>
                                                    Transplante de barba: {{ 'Sim' if ht.beard_transplant else 'Não' }}
                                                </li>
                                                <li>
                                                    <i class="bi bi-{{ 'check-circle-fill text-success' if ht.feminine_hair_transplant else 'x-circle text-muted' }}"></i>
                                                    Transplante capilar feminino: {{ 'Sim' if ht.feminine_hair_transplant else 'Não' }}
                                                </li>
                                            </ul>
                                        </div>

                                        {% if ht.frontal_transplant or ht.crown_transplant or ht.complete_transplant or ht.complete_with_body_hair or ht.dense_packing %}
                                        <div class="mb-2">
                                            <strong>Indicações Cirúrgicas:</strong><br>
                                            <ul class="mb-0">
                                                {% if ht.frontal_transplant %}<li>Transplante frontal</li>{% endif %}
                                                {% if ht.crown_transplant %}<li>Transplante em coroa</li>{% endif %}
                                                {% if ht.complete_transplant %}<li>Transplante completo</li>{% endif %}
                                                {% if ht.complete_with_body_hair %}<li>Transplante completo com body hair</li>{% endif %}
                                                {% if ht.dense_packing %}<li>Dense Packing</li>{% endif %}
                                            </ul>
                                        </div>
                                        {% endif %}

                                        {% if ht.surgical_planning %}
                                        <div class="mb-2">
                                            <strong>Planejamento Cirúrgico:</strong><br>
                                            <p class="mb-0 p-2 bg-light rounded" style="white-space: pre-wrap;">{{ ht.surgical_planning }}</p>
                                        </div>
                                        {% endif %}
                                        
                                        {% if ht.clinical_conduct %}
                                        <div class="mb-2">
                                            <strong>Conduta Clínica:</strong><br>
                                            <p class="mb-0 p-2 bg-light rounded" style="white-space: pre-wrap;">{{ ht.clinical_conduct }}</p>
                                        </div>
                                        {% endif %}
                                        
                                        {% if ht.images %}
                                        <div class="mb-2">
                                            <strong>Imagens do Transplante:</strong><br>
                                            <div class="row g-2 mt-1">
                                                {% for img in ht.images %}
                                                <div class="col-4">
                                                    <div class="card">
                                                        <img src="{{ url_for('static', filename='uploads/' + img.file_path) }}" 
                                                             class="card-img-top" 
                                                             alt="{{ img.image_type }}"
                                                             style="max-height: 150px; object-fit: cover;">
                                                        <div class="card-body p-2 text-center">
                                                            <small class="text-muted">
                                                                {% if img.image_type == 'consultation_photo' %}Foto Consulta
                                                                {% elif img.image_type == 'surgical_plan' %}Planejamento
                                                                {% elif img.image_type == 'simulation' %}Simulação
                                                                {% else %}{{ img.image_type }}{% endif %}
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                                {% endif %}

                                <!-- Procedimentos Indicados/Realizados -->
                                {% set all_indications = [] %}
                                {% for note in consultation.all_notes %}
                                    {% if note.indications %}
                                        {% set all_indications = all_indications + note.indications %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% if all_indications %}
                                    <div class="mb-3">
                                        <h6 class="text-info">
                                            <i class="bi bi-list-check"></i> Procedimentos Realizados no Dia
                                        </h6>
                                        <div class="row">
                                            {% set indicated = all_indications | selectattr('indicated', 'equalto', True) | list %}
                                            {% set performed = all_indications | selectattr('performed', 'equalto', True) | list %}
                                            
                                            {% if indicated %}
                                            <div class="col-6">
                                                <strong class="text-muted">Indicados:</strong>
                                                <ul class="small mb-0">
                                                    {% for ind in indicated %}
                                                    <li>{{ ind.procedure.name }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                            
                                            {% if performed %}
                                            <div class="col-6">
                                                <strong class="text-success">Realizados:</strong>
                                                <ul class="small mb-0">
                                                    {% for ind in performed %}
                                                    <li>{{ ind.procedure.name }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}

                                <!-- Conduta (texto livre) -->
                                {% if 'conduta' in consultation.notes_by_type %}
                                    {% set conduta_text = consultation.notes_by_type['conduta'].content %}
                                    {% set conduta_note = consultation.notes_by_type['conduta'] %}
                                    {% if conduta_text and conduta_text != '[Conduta registrada via procedimentos]' %}
                                    <div class="mb-3">
                                        <h6 class="text-primary">
                                            <i class="bi bi-prescription2"></i> Conduta
                                        </h6>
                                        <p class="mb-0" style="white-space: pre-wrap;">{{ conduta_text }}</p>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Indicação de Transplante Capilar - Apenas para Transplante Capilar -->
                                    {% if consultation.category == 'transplante_capilar' and conduta_note.transplant_indication %}
                                    <div class="mb-3">
                                        <h6 class="text-warning">
                                            <i class="bi bi-exclamation-triangle"></i> Indicação de Transplante Capilar
                                        </h6>
                                        <div class="btn-group" role="group">
                                            {% if conduta_note.transplant_indication == 'sim' %}
                                            <button type="button" class="btn btn-sm btn-info">Sim</button>
                                            {% else %}
                                            <button type="button" class="btn btn-sm btn-secondary">Não</button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Planejamento Cirúrgico (JSON) - Apenas para Transplante Capilar -->
                                    {% if (consultation.category == 'transplante_capilar' or consultation.category == 'Transplante Capilar' or consultation.category == 'cosmiatria') and conduta_note.surgical_planning %}
                                    <div class="mb-3">
                                        <h6 class="text-success">
                                            <i class="bi bi-clipboard-check"></i> Detalhes do Planejamento
                                        </h6>
                                        <div class="card card-body bg-light-subtle border-start border-4 border-info" id="surgicalPlanDisplay{{ consultation.id }}">
                                            <script>
                                                (function() {
                                                    const container = document.getElementById('surgicalPlanDisplay{{ consultation.id }}');
                                                    let rawData = {{ conduta_note.surgical_planning | tojson }};
                                                    
                                                    const labels = {
                                                        'norwood': 'Escala Norwood',
                                                        'previous_transplant': 'Transplante Anterior',
                                                        'transplant_location': 'Local do Transplante',
                                                        'case_type': 'Tipo de Caso',
                                                        'body_hair_needed': 'Body Hair Transplant',
                                                        'eyebrow_transplant': 'Transplante Sobrancelha',
                                                        'beard_transplant': 'Transplante Barba',
                                                        'feminine_hair_transplant': 'Transplante Capilar Feminino',
                                                        'frontal': 'Frontal',
                                                        'crown': 'Coroa',
                                                        'complete': 'Completo',
                                                        'complete_body_hair': 'Body Hair',
                                                        'dense_packing': 'Dense Packing',
                                                        'surgical_planning_text': 'Observações',
                                                        'clinical_conduct': 'Conduta Clínica'
                                                    };
                                                    
                                                    try {
                                                        let planData = typeof rawData === 'string' ? JSON.parse(rawData) : rawData;
                                                        
                                                        if (planData && typeof planData === 'object') {
                                                            let html = '<dl class="row mb-0 small">';
                                                            let hasContent = false;
                                                            for (const [key, val] of Object.entries(planData)) {
                                                                if (val !== null && val !== false && val !== '' && val !== undefined) {
                                                                    hasContent = true;
                                                                    const label = labels[key] || key;
                                                                    let display = val;
                                                                    if (typeof val === 'boolean') {
                                                                        display = val ? 'Sim' : 'Não';
                                                                    } else if (typeof val === 'string' && val.length > 0) {
                                                                        display = val.replace(/\n/g, '<br>');
                                                                    }
                                                                    html += '<dt class="col-sm-5 text-muted">' + label + ':</dt><dd class="col-sm-7"><strong>' + display + '</strong></dd>';
                                                                }
                                                            }
                                                            html += '</dl>';
                                                            if (hasContent) {
                                                                container.innerHTML = html;
                                                            } else {
                                                                container.closest(".mb-3").style.display = "none";
                                                            }
                                                        }
                                                    } catch (e) {
                                                        console.error('Erro ao processar planejamento:', e);
                                                        container.innerHTML = '<p class="mb-0 small">' + String(rawData) + '</p>';
                                                    }
                                                })();
                                            </script>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endif %}
                                <hr class="my-3">
                                <h6 class="text-success mb-3">
                                    <i class="bi bi-stickies"></i> Evoluções
                                </h6>
                                <div id="evolutionsContainer{{ consultation.id }}" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center py-4">
                    <i class="bi bi-inbox"></i><br>
                    Nenhuma consulta finalizada registrada.
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- HISTÓRICO DE CIRURGIAS -->
<div class="row mt-3">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-heart-pulse"></i> Histórico de Cirurgias
                </h5>
            </div>
            <div class="card-body" id="surgeriesContainer" style="max-height: 600px; overflow-y: auto;">
                <!-- Cirurgias serão carregadas aqui via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Modal de Evolução -->
<div class="modal fade" id="evolutionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Nova Evolução</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label"><strong>Consulta do Histórico *</strong></label>
                    <!-- Dropdown para seleção (mostrado quando nenhuma consulta pré-selecionada) -->
                    <select id="evolutionConsultation" class="form-select" required>
                        <option value="">-- Selecione uma consulta --</option>
                    </select>
                    <!-- Display da consulta selecionada (oculto por padrão) -->
                    <div id="evolutionConsultationDisplay" style="display: none; padding: 8px 12px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
                        <strong id="evolutionConsultationName"></strong>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Data da Evolução</strong></label>
                    <input type="datetime-local" id="evolutionDate" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Descrição</strong></label>
                    <textarea id="evolutionContent" class="form-control" rows="5" placeholder="Descreva a evolução do paciente desde a última consulta..."></textarea>
                </div>
                <div id="surgicalEvolutionFindings" class="mb-3" style="display:none;">
                  <label class="form-label"><strong>Achados Cirúrgicos (marque quantos quiser)</strong></label>

                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfNecrose" value="necrose">
                        <label class="form-check-label" for="sfNecrose">Necrose</label>
                      </div>

                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfCrostas" value="crostas">
                        <label class="form-check-label" for="sfCrostas">Crostas</label>
                      </div>

                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfInfeccao" value="infeccao_secundaria">
                        <label class="form-check-label" for="sfInfeccao">Infecção secundária</label>
                      </div>

                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfFolAguda" value="foliculite_aguda">
                        <label class="form-check-label" for="sfFolAguda">Foliculite aguda</label>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfFolCron" value="foliculite_cronica">
                        <label class="form-check-label" for="sfFolCron">Foliculite crônica</label>
                      </div>

                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfRarefacao" value="rarefacao_capilar">
                        <label class="form-check-label" for="sfRarefacao">Rarefação capilar</label>
                      </div>

                      <div class="form-check">
                        <input class="form-check-input surg-find" type="checkbox" id="sfFalha" value="falha_localizada">
                        <label class="form-check-label" for="sfFalha">Falha localizada</label>
                      </div>
                    </div>
                  </div>

                  <small class="text-muted d-block mt-2">
                    * Esses achados serão salvos junto da evolução (padronizado) e podem coexistir.
                  </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveEvolution()"><i class="bi bi-save"></i> Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edição de Data da Consulta -->
<div class="modal fade" id="editConsultationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Consulta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <input type="hidden" id="editConsultationId">
                
                <div class="mb-3">
                    <label class="form-label"><strong>Data e Hora</strong></label>
                    <input type="datetime-local" id="editConsultationDateTime" class="form-control">
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <label class="form-label"><strong>Queixa Principal</strong></label>
                    <textarea id="editQueixa" class="form-control" rows="2" placeholder="Ex: Dor na cabeça..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><strong>Anamnese / Exame Físico</strong></label>
                    <textarea id="editAnamnese" class="form-control" rows="3" placeholder="Ex: Paciente refere..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><strong>Diagnóstico</strong></label>
                    <textarea id="editDiagnostico" class="form-control" rows="3" placeholder="Ex: Diagnóstico de..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><strong>Conduta</strong></label>
                    <textarea id="editConduta" class="form-control" rows="3" placeholder="Ex: Prescrever..."></textarea>
                </div>
                
                <input type="hidden" id="editQueixaId">
                <input type="hidden" id="editAnamneseId">
                <input type="hidden" id="editDiagnosticoId">
                <input type="hidden" id="editCondutaId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="saveConsultationEdit()">
                    <i class="bi bi-save"></i> Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/**
 * PATCH DEFINITIVO - Evolução Cirúrgica com checkboxes (somente em cirurgia)
 *
 * Estratégia (sem mexer no backend):
 * - Detecta contexto "cirurgia" por:
 *   (A) texto do select #evolutionConsultation contendo "cirurgia"
 *   (B) texto do display verde #evolutionConsultationName contendo "cirurgia"
 * - Quando for cirurgia: mostra checkboxes
 * - Quando não for: esconde e limpa
 * - No saveEvolution(): injeta um bloco padronizado dentro do texto da evolução
 *   para garantir persistência mesmo se o backend ainda salva só "content".
 */

(function() {
  function $(id){ return document.getElementById(id); }

  function isSurgeryContext() {
    // 1) Se o modal tiver dataset.context explícito, respeita
    const modal = $('evolutionModal');
    const ctx = modal?.dataset?.context;
    if (ctx === 'surgery') return true;
    if (ctx === 'consultation') return false;

    // 2) Tenta detectar pelo select
    const sel = $('evolutionConsultation');
    const selText = sel?.options?.[sel.selectedIndex]?.textContent?.toLowerCase?.() || '';
    if (selText.includes('cirurgia')) return true;

    // 3) Tenta detectar pelo display verde
    const disp = $('evolutionConsultationName');
    const dispText = disp?.textContent?.toLowerCase?.() || '';
    if (dispText.includes('cirurgia')) return true;

    return false;
  }

  function showHideSurgicalBox() {
    const box = $('surgicalEvolutionFindings');
    if (!box) return;
    if (isSurgeryContext()) {
      box.style.display = 'block';
    } else {
      box.style.display = 'none';
      document.querySelectorAll('.surg-find').forEach(cb => cb.checked = false);
    }
  }

  function getCheckedFindings() {
    return Array.from(document.querySelectorAll('.surg-find:checked')).map(x => x.value);
  }

  function findingsToHuman(findings) {
    const map = {
      necrose: 'Necrose',
      crostas: 'Crostas',
      infeccao_secundaria: 'Infecção secundária',
      foliculite_aguda: 'Foliculite aguda',
      foliculite_cronica: 'Foliculite crônica',
      rarefacao_capilar: 'Rarefação capilar',
      falha_localizada: 'Falha localizada'
    };
    return findings.map(f => map[f] || f);
  }

  function injectFindingsIntoContentIfNeeded() {
    if (!isSurgeryContext()) return;

    const txt = $('evolutionContent');
    if (!txt) return;

    const findings = getCheckedFindings();
    // Sempre padroniza: se não marcar nada, salva como "Sem achados selecionados"
    const human = findings.length ? findingsToHuman(findings).join(', ') : 'Sem achados selecionados';

    const blockHeader = '[ACHADOS CIRÚRGICOS - CHECKLIST]';
    const block = `${blockHeader}\n- ${human}\n[/ACHADOS CIRÚRGICOS]\n`;

    // Remove bloco antigo para evitar duplicar
    const current = txt.value || '';
    const cleaned = current
      .replace(/\[ACHADOS CIRÚRGICOS - CHECKLIST\][\s\S]*?\[\/ACHADOS CIRÚRGICOS\]\n?/g, '')
      .trim();

    // Insere no topo (padrão fixo)
    txt.value = (block + '\n' + cleaned).trim();
  }

  // ---- Ganchos para atualização do contexto ----
  document.addEventListener('DOMContentLoaded', function() {
    // 1) Ao mudar o select, reavalia contexto
    const sel = $('evolutionConsultation');
    if (sel) {
      sel.addEventListener('change', function() {
        // opcional: se quiser fixar dataset.context automaticamente
        const modal = $('evolutionModal');
        const txt = sel.options[sel.selectedIndex]?.textContent?.toLowerCase?.() || '';
        if (modal) modal.dataset.context = txt.includes('cirurgia') ? 'surgery' : 'consultation';
        showHideSurgicalBox();
      });
    }

    // 2) Ao abrir o modal, reavalia
    const modalEl = $('evolutionModal');
    if (modalEl) {
      modalEl.addEventListener('shown.bs.modal', function() {
        showHideSurgicalBox();
      });
    }

    // 3) Se o usuário clicar nos checkboxes, mantém o texto sempre preparado
    document.addEventListener('change', function(e) {
      if (e.target && e.target.classList && e.target.classList.contains('surg-find')) {
        // não injeta automaticamente (para não atrapalhar enquanto digita),
        // mas pode ser útil manter o bloco pronto se você quiser:
        // injectFindingsIntoContentIfNeeded();
      }
    });

    // 4) Intercepta saveEvolution() SEM precisar editar o arquivo JS original:
    //    - Se saveEvolution existir globalmente, “wrap” com injeção do checklist antes de salvar
    const originalSaveEvolution = window.saveEvolution;
    if (typeof originalSaveEvolution === 'function') {
      window.saveEvolution = function() {
        // garante que o checklist vai junto (no texto)
        injectFindingsIntoContentIfNeeded();
        return originalSaveEvolution.apply(this, arguments);
      };
    }

    // Primeira avaliação
    showHideSurgicalBox();
  });

})();
</script>
<script>
const patientId = {{ patient.id }};
window.patientId = {{ patient.id }};
window.patientName = "{{ patient.name }}";
window.appointmentId = {{ appointment_id | tojson }};
window.appointmentStartIso = {{ appointment_start_iso | tojson }};
console.log('DEBUG prontuario: appointmentId from URL =', window.appointmentId);

document.addEventListener('DOMContentLoaded', function() {
    // Se nao tem appointment_id, buscar o ultimo agendamento do paciente para hoje
    if (!window.appointmentId) {
        fetch(`/api/patient/${patientId}/today-appointment`)
            .then(r => r.json())
            .then(data => {
                if (data.appointment_id) {
                    window.appointmentId = data.appointment_id;
                    console.log('DEBUG: Loaded today appointment_id =', window.appointmentId);
                }
            })
            .catch(err => console.log('No today appointment found'));
    }
    
    if (typeof loadPrescriptionHistory === 'function') {
        loadPrescriptionHistory();
    }

    // Pre-preencher aba Data quando ela for aberta
    document.querySelectorAll('a[href="#data-consulta"]').forEach(function(tab) {
        tab.addEventListener('shown.bs.tab', function() {
            const input = document.getElementById('consultationDateInput');
            if (!input) return;
            if (window.appointmentStartIso) {
                input.value = window.appointmentStartIso;
            } else {
                const now = new Date();
                now.setSeconds(0, 0);
                input.value = now.toISOString().slice(0, 16);
            }
        });
    });
});

function saveConsultationDate() {
    const input = document.getElementById('consultationDateInput');
    const status = document.getElementById('consultationDateStatus');
    const apptId = window.appointmentId;

    if (!apptId) {
        status.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-circle me-1"></i>Nenhum agendamento ativo encontrado.</span>';
        return;
    }
    if (!input.value) {
        status.innerHTML = '<span class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Selecione uma data.</span>';
        return;
    }

    status.innerHTML = '<span class="text-muted"><i class="bi bi-hourglass-split me-1"></i>Salvando...</span>';

    const isoDate = new Date(input.value).toISOString();

    fetch(`/api/appointments/${apptId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ consultation_date: isoDate })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success !== false) {
            window.appointmentStartIso = input.value;
            status.innerHTML = '<span class="text-success"><i class="bi bi-check-circle me-1"></i>Data salva com sucesso!</span>';
            setTimeout(() => status.innerHTML = '', 3000);
        } else {
            status.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle me-1"></i>${data.error || 'Erro ao salvar.'}</span>`;
        }
    })
    .catch(() => {
        status.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>Erro de comunicação com o servidor.</span>';
    });
}
</script>
    <script src="{{ url_for('static', filename='js/surgeries.js') }}?v={{ range(1, 100000) | random }}"></script>
<script src="{{ url_for('static', filename='js/prontuario.js') }}"></script>
{% endblock %}
