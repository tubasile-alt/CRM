{% extends "base.html" %}

{% block title %}Mapa Cirúrgico - Clínica Basile{% endblock %}

{% block extra_css %}
<style>
.surgery-card {
    border-left: 4px solid #198754;
    transition: all 0.2s;
}
.surgery-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.room-header {
    background: linear-gradient(135deg, #198754 0%, #146c43 100%);
}
.time-slot {
    font-size: 0.85rem;
    color: #6c757d;
}
.conflict-warning {
    border-left-color: #dc3545 !important;
}
.day-card {
    border-left: 5px solid #0d6efd;
    transition: all 0.3s;
    cursor: pointer;
}
.day-card:hover {
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    transform: translateY(-3px);
}
.day-header {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    color: white;
    padding: 12px 15px;
}
.slot-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
}
.slot-free { background-color: #198754; }
.slot-occupied { background-color: #dc3545; }
.slot-partial { background-color: #ffc107; }
.room-slot {
    padding: 8px;
    margin: 4px 0;
    border-radius: 6px;
    background: #f8f9fa;
    font-size: 0.9rem;
}
.stats-badge {
    background: rgba(255,255,255,0.2);
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.85rem;
    margin-left: 8px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-clipboard2-pulse"></i> Mapa Cirúrgico Semanal</h2>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="previousWeek()">
                <i class="bi bi-chevron-left"></i> Semana Anterior
            </button>
            <button class="btn btn-outline-primary" onclick="currentWeek()">Semana Atual</button>
            <button class="btn btn-primary" onclick="nextWeek()">
                Próxima Semana <i class="bi bi-chevron-right"></i>
            </button>
        </div>
        <div class="btn-group">
            {% if current_user.is_doctor() %}
            <button class="btn btn-success" onclick="showNewSurgeryModal()">
                <i class="bi bi-plus-circle"></i> Nova Cirurgia
            </button>
            {% endif %}
            <button class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-download"></i> Exportar
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportPDF()"><i class="bi bi-file-pdf"></i> PDF</a></li>
                <li><a class="dropdown-item" href="#" onclick="exportExcel()"><i class="bi bi-file-excel"></i> Excel</a></li>
            </ul>
        </div>
    </div>

    <div id="week-info" class="alert alert-info mb-3">
        Carregando...
    </div>

    <div id="weekly-overview" class="row mb-4">
        <!-- Visão macro da semana (seg-sex) -->
    </div>

    <div id="detailed-view" class="row" style="display: none;">
        <!-- Detalhes do dia selecionado -->
        <div class="col-12 mb-3">
            <button class="btn btn-outline-secondary" onclick="showWeeklyOverview()">
                <i class="bi bi-arrow-left"></i> Voltar para visão semanal
            </button>
            <h4 id="detailed-view-title" class="d-inline-block ms-3"></h4>
        </div>
        <div id="detailed-surgeries" class="col-12">
            <!-- Cirurgias do dia serão carregadas aqui -->
        </div>
    </div>
</div>

<!-- Modal Nova Cirurgia -->
<div class="modal fade" id="newSurgeryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Cirurgia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="surgeryForm">
                    <div class="mb-3">
                        <label class="form-label">Nome do Paciente</label>
                        <input type="text" class="form-control" name="patient_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Médico Responsável</label>
                        <select class="form-select" name="doctor_id" required>
                            <option value="">Selecione...</option>
                            {% for doctor in doctors %}
                            <option value="{{ doctor.id }}">{{ doctor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Procedimento</label>
                        <input type="text" class="form-control" name="procedure_type" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sala</label>
                        <select class="form-select" name="room_id" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data</label>
                            <input type="date" class="form-control" name="scheduled_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Horário</label>
                            <input type="time" class="form-control" name="scheduled_time" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Duração</label>
                        <input type="text" class="form-control" name="duration_input" value="1h" placeholder="Ex: 1h, 1h30, 2h, 30min" required>
                        <small class="form-text text-muted">Exemplos: 1h, 1h30, 2h, 30min, 45min</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveSurgery()">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentWeekStart = '{{ week_start }}';

let weekData = null;

function loadWeeklyMap() {
    fetch(`/mapa-cirurgico/api/weekly?week_start=${currentWeekStart}`)
        .then(r => r.json())
        .then(data => {
            weekData = data;
            document.getElementById('week-info').innerHTML = `
                <strong>Semana:</strong> ${formatDate(data.week_start)} a ${formatDate(data.week_end)}
            `;
            
            // Organizar cirurgias por dia
            const dayStats = organizeSurgeriesByDay(data);
            
            // Renderizar visão macro
            renderWeeklyOverview(dayStats, data.rooms.length);
            
            // Resetar navegação para visão semanal
            showWeeklyOverview();
            
            // Preencher select de salas no modal
            const roomSelect = document.querySelector('select[name="room_id"]');
            roomSelect.innerHTML = '<option value="">Selecione...</option>';
            data.rooms.forEach(room => {
                roomSelect.innerHTML += `<option value="${room.id}">${room.name}</option>`;
            });
        });
}

function organizeSurgeriesByDay(data) {
    const days = {};
    const weekStart = new Date(data.week_start);
    
    // Criar estrutura para cada dia da semana (seg-sex)
    for (let i = 0; i < 5; i++) {
        const date = new Date(weekStart);
        date.setDate(date.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        
        days[dateStr] = {
            date: dateStr,
            dayName: ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta'][i],
            total: 0,
            byRoom: {},
            byTimeSlot: {'07:00': 0, '10:00': 0, 'outros': 0},
            surgeries: [],
            rooms: data.rooms.map(r => ({id: r.id, name: r.name}))
        };
        
        // Inicializar contadores por sala
        data.rooms.forEach(room => {
            days[dateStr].byRoom[room.name] = 0;
        });
    }
    
    // Processar todas as cirurgias
    data.rooms.forEach(room => {
        room.surgeries.forEach(surgery => {
            const dateStr = surgery.date;
            if (days[dateStr]) {
                days[dateStr].total++;
                days[dateStr].byRoom[room.name]++;
                days[dateStr].surgeries.push({...surgery, room_name: room.name, room_id: room.id});
                
                // Classificar por horário
                const time = surgery.start_time;
                if (time === '07:00') {
                    days[dateStr].byTimeSlot['07:00']++;
                } else if (time === '10:00') {
                    days[dateStr].byTimeSlot['10:00']++;
                } else {
                    days[dateStr].byTimeSlot['outros']++;
                }
            }
        });
    });
    
    return days;
}

function renderWeeklyOverview(dayStats, numRooms) {
    const container = document.getElementById('weekly-overview');
    container.innerHTML = '';
    
    // Calcular dinamicamente: número de salas × 2 horários fixos (7AM, 10AM)
    const slotsPerRoom = 2;
    const totalSlots = numRooms * slotsPerRoom;
    
    Object.keys(dayStats).forEach(dateStr => {
        const day = dayStats[dateStr];
        const occupancyPercent = Math.round((day.total / totalSlots) * 100);
        
        const roomSlotsHtml = day.rooms.map(room => {
            const count = day.byRoom[room.name] || 0;
            const maxPerRoom = slotsPerRoom;
            const indicators = Array(maxPerRoom).fill('').map((_, i) => 
                i < count ? '<span class="slot-indicator slot-occupied"></span>' : '<span class="slot-indicator slot-free"></span>'
            ).join('');
            return `<div class="room-slot">${room.name}: ${indicators} (${count})</div>`;
        }).join('');
        
        const timeSlotHtml = `
            <div class="room-slot">
                <strong>7AM:</strong> ${day.byTimeSlot['07:00']}/${numRooms}
                <span class="ms-2"><strong>10AM:</strong> ${day.byTimeSlot['10:00']}/${numRooms}</span>
                ${day.byTimeSlot['outros'] > 0 ? `<span class="ms-2 text-warning"><strong>Extras:</strong> ${day.byTimeSlot['outros']}</span>` : ''}
            </div>
        `;
        
        const dayCard = `
            <div class="col-md-4 col-lg-2 mb-3">
                <div class="card day-card" onclick="showDayDetails('${dateStr}')">
                    <div class="day-header">
                        <strong>${day.dayName}</strong>
                        <span class="stats-badge">${day.total}/${totalSlots}</span>
                        <div style="font-size: 0.85rem;">${formatDate(dateStr)}</div>
                    </div>
                    <div class="card-body p-2">
                        <div class="mb-2">
                            <small class="text-muted">Total: ${day.total} cirurgias</small>
                            ${day.total > 0 ? `<div class="progress" style="height: 6px;"><div class="progress-bar ${occupancyPercent >= 100 ? 'bg-danger' : 'bg-success'}" style="width: ${Math.min(occupancyPercent, 100)}%"></div></div>` : ''}
                        </div>
                        ${roomSlotsHtml}
                        ${timeSlotHtml}
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', dayCard);
    });
}

function showDayDetails(date) {
    if (!weekData) return;
    
    // Organizar cirurgias por dia
    const dayStats = organizeSurgeriesByDay(weekData);
    const day = dayStats[date];
    
    if (!day) return;
    
    // Ocultar visão semanal e mostrar detalhes
    document.getElementById('weekly-overview').style.display = 'none';
    document.getElementById('detailed-view').style.display = 'block';
    
    document.getElementById('detailed-view-title').textContent = `${day.dayName}, ${formatDate(date)} - ${day.total} cirurgias`;
    
    const container = document.getElementById('detailed-surgeries');
    container.innerHTML = '';
    
    // Agrupar por sala
    day.rooms.forEach(room => {
        const roomSurgeries = day.surgeries.filter(s => s.room_id === room.id);
        
        const roomHtml = `
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header room-header text-white">
                        <h5 class="mb-0">${room.name} <small>(${roomSurgeries.length} cirurgias)</small></h5>
                    </div>
                    <div class="card-body" id="detail-room-${room.id}">
                        ${roomSurgeries.length === 0 ? '<p class="text-muted">Nenhuma cirurgia agendada</p>' : ''}
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', roomHtml);
        
        // Adicionar cards de cirurgias
        roomSurgeries.forEach(surgery => {
            const surgeryCard = createSurgeryCard(surgery);
            document.getElementById(`detail-room-${room.id}`).insertAdjacentHTML('beforeend', surgeryCard);
        });
    });
}

function showWeeklyOverview() {
    document.getElementById('weekly-overview').style.display = 'flex';
    document.getElementById('detailed-view').style.display = 'none';
}

function createSurgeryCard(surgery) {
    const duration = formatDuration(surgery.duration_minutes);
    return `
        <div class="surgery-card card mb-2">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${surgery.patient_name}</strong>
                        <div class="time-slot">${surgery.date} • ${surgery.start_time} • ${duration}</div>
                        <small class="text-muted">${surgery.procedure_name} - ${surgery.doctor_name}</small>
                    </div>
                    {% if current_user.is_doctor() %}
                    <div>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSurgery(${surgery.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    `;
}

function formatDuration(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    
    if (hours === 0) {
        return `${mins}min`;
    } else if (mins === 0) {
        return `${hours}h`;
    } else {
        return `${hours}h${mins}`;
    }
}

function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString('pt-BR');
}

function previousWeek() {
    const d = new Date(currentWeekStart);
    d.setDate(d.getDate() - 7);
    currentWeekStart = d.toISOString().split('T')[0];
    loadWeeklyMap();
}

function currentWeek() {
    const today = new Date();
    const monday = new Date(today.setDate(today.getDate() - today.getDay() + 1));
    currentWeekStart = monday.toISOString().split('T')[0];
    loadWeeklyMap();
}

function nextWeek() {
    const d = new Date(currentWeekStart);
    d.setDate(d.getDate() + 7);
    currentWeekStart = d.toISOString().split('T')[0];
    loadWeeklyMap();
}

function showNewSurgeryModal() {
    new bootstrap.Modal(document.getElementById('newSurgeryModal')).show();
}

function parseDuration(input) {
    if (!input || typeof input !== 'string') {
        return NaN;
    }
    
    input = input.trim().toLowerCase();
    
    // Apenas minutos: "30min", "45min" - validação estrita
    const minPattern = /^(\d+)\s*min$/;
    const minMatch = input.match(minPattern);
    if (minMatch) {
        const mins = parseInt(minMatch[1]);
        return (mins > 0 && mins <= 480) ? mins : NaN;
    }
    
    // Horas e minutos: "1h30", "2h15", "1h45"
    const hoursMinutesPattern = /^(\d+)\s*h\s*(\d+)$/;
    const hoursMinutesMatch = input.match(hoursMinutesPattern);
    if (hoursMinutesMatch) {
        const hours = parseInt(hoursMinutesMatch[1]);
        const mins = parseInt(hoursMinutesMatch[2]);
        if (mins >= 60) return NaN;
        const total = hours * 60 + mins;
        return (total > 0 && total <= 480) ? total : NaN;
    }
    
    // Apenas horas: "1h", "2h"
    const hoursPattern = /^(\d+)\s*h$/;
    const hoursMatch = input.match(hoursPattern);
    if (hoursMatch) {
        const hours = parseInt(hoursMatch[1]);
        const total = hours * 60;
        return (total > 0 && total <= 480) ? total : NaN;
    }
    
    // Formato inválido
    return NaN;
}

function saveSurgery() {
    const form = document.getElementById('surgeryForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Validar doctor_id
    if (!data.doctor_id || data.doctor_id === '') {
        showAlert('Selecione o médico responsável', 'danger');
        return;
    }
    
    // Converter duração para minutos
    const durationMinutes = parseDuration(data.duration_input);
    if (isNaN(durationMinutes) || durationMinutes <= 0) {
        showAlert('Formato de duração inválido. Use: 1h, 1h30, 2h ou 30min', 'danger');
        return;
    }
    
    fetch('/mapa-cirurgico/api/surgery', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            patient_name: data.patient_name,
            doctor_id: parseInt(data.doctor_id),
            procedure_name: data.procedure_type,
            operating_room_id: parseInt(data.room_id),
            date: data.scheduled_date,
            start_time: data.scheduled_time,
            duration_minutes: durationMinutes,
            notes: data.notes || ''
        })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('newSurgeryModal')).hide();
            form.reset();
            loadWeeklyMap();
            showAlert('Cirurgia agendada com sucesso!', 'success');
        } else {
            showAlert(result.error || 'Erro ao agendar cirurgia', 'danger');
        }
    })
    .catch(err => {
        console.error('Erro:', err);
        showAlert('Erro ao agendar cirurgia', 'danger');
    });
}

function showSuccess(message) {
    showAlert(message, 'success');
}

function showError(message) {
    showAlert(message, 'danger');
}

function deleteSurgery(id) {
    if (!confirm('Deseja realmente excluir esta cirurgia?')) return;
    
    fetch(`/mapa-cirurgico/api/surgery/${id}`, {
        method: 'DELETE',
        headers: {'X-CSRFToken': getCSRFToken()}
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            loadWeeklyMap();
            showSuccess('Cirurgia excluída!');
        } else {
            showError(result.error);
        }
    });
}

function exportPDF() {
    window.location.href = `/mapa-cirurgico/export/pdf?week_start=${currentWeekStart}`;
}

function exportExcel() {
    window.location.href = `/mapa-cirurgico/export/excel?week_start=${currentWeekStart}`;
}

// Load initial data
document.addEventListener('DOMContentLoaded', () => {
    loadWeeklyMap();
});
</script>
{% endblock %}
